<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Dream-seeker TCG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase SDKï¼ˆãƒ«ãƒ¼ãƒ æˆ¦ç”¨ï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #181818;
      color: #f5f5f5;
    }

    h1, h2 { text-align: center; margin: 12px 0; }

    .screen {
      display: none;
      padding: 10px;
      max-width: 520px;
      margin: 0 auto;
    }
    .screen.active { display: block; }

    .btn {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      background: #444;
      color: #f5f5f5;
    }
    .btn.primary { background: #2ecc71; color: #000; }
    .btn.danger  { background: #e74c3c; }
    .btn.small {
      width: auto;
      padding: 4px 8px;
      font-size: 12px;
      margin: 2px 4px 0 0;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 8px;
    }

    .card-box {
      border: 1px solid #555;
      border-radius: 8px;
      padding: 6px;
      margin: 4px 0;
      font-size: 12px;
      background: #202020;
      cursor: pointer;
    }
    .card-name  { font-weight: bold; }
    .card-stats { font-size: 11px; opacity: 0.9; margin-top: 2px; }

    .red    { border-color: #e74c3c; }
    .purple { border-color: #9b59b6; }
    .blue   { border-color: #3498db; }
    .yellow { border-color: #f1c40f; }
    .white  { border-color: #ecf0f1; }
    .green  { border-color: #2ecc71; }

    .log {
      background: #111;
      border-radius: 8px;
      padding: 6px;
      font-size: 11px;
      height: 120px;
      overflow-y: auto;
      border: 1px solid #333;
      margin-top: 6px;
    }

    .section-title {
      font-size: 13px;
      margin: 10px 0 4px;
      font-weight: bold;
    }

    .stone-bar {
      font-size: 13px;
      padding: 4px 6px;
      border-radius: 8px;
      background: #222;
      display: inline-block;
      margin-bottom: 8px;
    }

    .row { display: flex; gap: 6px; }
    .row > .btn { flex: 1; }

    .toggle-selected {
      background: #f39c12 !important;
      color: #000 !important;
    }

    /* ===== ãƒãƒˆãƒ«ç”»é¢ç”¨ ===== */

    .battle-screen {
      padding: 16px;
    }

    .enemy-title {
      text-align: center;
      font-size: 20px;
      margin-bottom: 8px;
    }

    .enemy-status {
      display: flex;
      justify-content: space-around;
      margin-bottom: 8px;
      font-size: 13px;
    }

    #cpuField,
    #playerField,
    #playerHand {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      overflow-x: auto;
      padding: 8px 0;
      min-height: 160px;
      -webkit-overflow-scrolling: touch;
    }

    .divider {
      border-top: 3px dashed #ffffff;
      margin: 12px 0;
    }

    .bottom-ui {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .status-box,
    .effect-box {
      width: 48%;
      min-height: 120px;
      border: 3px solid #ffffff;
      box-sizing: border-box;
      padding: 8px;
      font-size: 14px;
    }

    .status-box-title,
    .effect-box-title {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .turn-info {
      margin-top: 4px;
      font-weight: bold;
    }

    .status-buttons {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .status-buttons button {
      font-size: 12px;
      padding: 4px 8px;
    }

    /* ã‚«ãƒ¼ãƒ‰è¦‹ãŸç›®ï¼ˆæ–°ã‚«ãƒ¼ãƒ‰å‹ï¼‰ */
    .card {
      flex: 0 0 auto;
      width: 96px;
      height: 160px;
      border-radius: 10px;
      border: 3px solid #555;
      background: #b30000;
      color: #ffffff;
      font-size: 10px;
      box-sizing: border-box;
      padding: 4px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.1s ease;
      position: relative;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 8px rgba(255,255,255,0.3);
    }

    .card.rest {
      opacity: 0.6;
      transform: rotate(8deg);
    }

    .card.red {
      border-color: #e74c3c;
      background: #8b1a1a;
    }
    .card.purple {
      border-color: #9b59b6;
      background: #4b2b63;
    }
    .card.blue {
      border-color: #3498db;
      background: #1f3f5f;
    }
    .card.yellow {
      border-color: #f1c40f;
      background: #866d07;
    }
    .card.white {
      border-color: #ecf0f1;
      background: #aaaaaa;
      color: #000;
    }
    .card.green {
      border-color: #2ecc71;
      background: #145437;
    }

    /* ç™½ã‚«ãƒ¼ãƒ‰ã ã‘ãƒ˜ãƒƒãƒ€ãƒ¼ï¼†ãƒ•ãƒƒã‚¿ãƒ¼ã‚’ç™½åœ°ï¼‹é»’æ–‡å­—ã« */
    .card.white .card-header,
    .card.white .card-footer {
      background: #ffffff;
      color: #000000;
    }
    .card.white .card-cost {
      color: #000000;
    }

    /* ===== Eãƒ¬ã‚¢ï¼ˆã‚¨ãƒ³ãƒãƒ£ãƒ³ãƒ†ãƒƒãƒ‰ï¼‰è±ªè¯æ é¢¨ãƒ‡ã‚¶ã‚¤ãƒ³ ===== */
    .card.enchanted {
      box-shadow:
        0 0 10px rgba(255,255,255,0.8),
        0 0 18px rgba(255,215,0,0.7);
      border-width: 3px;
      border-color: #ffd700;
    }
    .card.enchanted::before {
      content: "";
      position: absolute;
      inset: 0;
      background: conic-gradient(
        from 45deg,
        rgba(255,255,255,0.15),
        rgba(255,215,0,0.25),
        rgba(255,255,255,0.0),
        rgba(0,255,255,0.15),
        rgba(255,255,255,0.15)
      );
      mix-blend-mode: screen;
      pointer-events: none;
    }
    .card.enchanted.red {
      box-shadow:
        0 0 10px rgba(255,120,120,0.9),
        0 0 20px rgba(255,80,80,0.7);
    }
    .card.enchanted.purple {
      box-shadow:
        0 0 10px rgba(200,120,255,0.9),
        0 0 20px rgba(160,80,240,0.7);
    }
    .card.enchanted.blue {
      box-shadow:
        0 0 10px rgba(120,180,255,0.9),
        0 0 20px rgba(80,140,255,0.7);
    }
    .card.enchanted.yellow {
      box-shadow:
        0 0 10px rgba(255,230,120,0.9),
        0 0 20px rgba(255,210,80,0.7);
    }
    .card.enchanted.white {
      box-shadow:
        0 0 10px rgba(240,240,255,0.9),
        0 0 20px rgba(210,230,255,0.7);
    }
    .card.enchanted.green {
      box-shadow:
        0 0 10px rgba(140,255,180,0.9),
        0 0 20px rgba(80,220,140,0.7);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #000000;
      border-radius: 4px;
      padding: 2px 3px;
      margin-bottom: 3px;
      font-weight: bold;
      position: relative;
      z-index: 1;
    }

    .card-cost {
      min-width: 16px;
      text-align: center;
    }

    .card-name-header {
      flex: 1;
      text-align: center;
      font-size: 9px;
    }

    .card-inkable {
      min-width: 16px;
      text-align: center;
    }

    .card-illustration {
      flex: 1;
      background: #ffffff;
      border-radius: 4px;
      margin-bottom: 3px;
      overflow: hidden;
      position: relative;
      z-index: 1;
    }

    .card-illustration img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .card-stats-row {
      display: flex;
      justify-content: space-between;
      font-size: 9px;
      padding: 0 2px;
      margin-bottom: 3px;
      position: relative;
      z-index: 1;
    }

    .card-footer {
      background: #000000;
      border-radius: 4px;
      padding: 2px 3px;
      font-size: 9px;
      position: relative;
      z-index: 1;
    }

    .card-footer-buttons {
      display: flex;
      gap: 2px;
      margin-top: 2px;
      position: relative;
      z-index: 1;
    }

    /* ã‚«ãƒ¼ãƒ‰è©³ç´°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
    #cardDetailOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
    }
    #cardDetailInner {
      background: #222;
      max-width: 320px;
      margin: 40px auto;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #ffffff;
      font-size: 13px;
    }
  </style>
</head>
<body>

<!-- ===== ãƒ›ãƒ¼ãƒ  ===== -->
<div id="menuScreen" class="screen active">
  <h1>Dream-seeker TCG</h1>
  <div class="stone-bar">
    ğŸ’ ãƒ‰ãƒªãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³: <span id="stoneCount">0</span>
  </div>
  <button class="btn primary" onclick="openCpuConfig()">ãƒãƒˆãƒ«ï¼ˆCPUæˆ¦ï¼‰</button>
  <button class="btn" onclick="openRoomScreen()">ãƒ«ãƒ¼ãƒ æˆ¦ï¼ˆÎ²ãƒ»è¦³æˆ¦ä»˜ãï¼‰</button>
  <button class="btn" onclick="showShop()">ã‚·ãƒ§ãƒƒãƒ—</button>
  <button class="btn" onclick="showPack()">ãƒ‘ãƒƒã‚¯ï¼ˆã‚¬ãƒãƒ£ï¼‰</button>
  <button class="btn" onclick="openDeckBuilder()">ãƒ‡ãƒƒã‚­ç·¨é›†</button>
  <button class="btn" onclick="openCollection()">ã‚«ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«</button>
</div>

<!-- ===== CPUè¨­å®š ===== -->
<div id="cpuScreen" class="screen">
  <h2>CPUè¨­å®š</h2>

  <div class="section-title">CPUã®å¼·ã•</div>
  <div class="row">
    <button id="btnCpuNormal" class="btn" onclick="setCpuStrength('normal')">æ™®é€š</button>
    <button id="btnCpuStrong" class="btn" onclick="setCpuStrength('strong')">å¼·ã„ï¼ˆè¶…CPUï¼‰</button>
  </div>

  <div class="section-title">CPUãƒ‡ãƒƒã‚­è‰²ï¼ˆ2è‰²é¸ã‚“ã§ã­ï¼‰</div>
  <div class="row">
    <button id="cpuRed"    class="btn" onclick="setCpuColor('red')">èµ¤</button>
    <button id="cpuPurple" class="btn" onclick="setCpuColor('purple')">ç´«</button>
  </div>
  <div class="row">
    <button id="cpuBlue"   class="btn" onclick="setCpuColor('blue')">é’</button>
    <button id="cpuYellow" class="btn" onclick="setCpuColor('yellow')">é»„</button>
  </div>
  <div class="row">
    <button id="cpuWhite"  class="btn" onclick="setCpuColor('white')">ç™½</button>
    <button id="cpuGreen"  class="btn" onclick="setCpuColor('green')">ç·‘</button>
  </div>

  <div class="section-title">è‡ªåˆ†ã®ä½¿ç”¨ãƒ‡ãƒƒã‚­</div>
  <button id="btnPlayerDefault" class="btn" onclick="selectPlayerDeck('default')">
    ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèµ¤ãƒ‡ãƒƒã‚­
  </button>
  <button id="btnDeck1" class="btn" onclick="selectPlayerDeck('deck1')">
    ãƒ‡ãƒƒã‚­1ï¼ˆæœªä¿å­˜ï¼‰
  </button>
  <button id="btnDeck2" class="btn" onclick="selectPlayerDeck('deck2')">
    ãƒ‡ãƒƒã‚­2ï¼ˆæœªä¿å­˜ï¼‰
  </button>
  <button id="btnDeck3" class="btn" onclick="selectPlayerDeck('deck3')">
    ãƒ‡ãƒƒã‚­3ï¼ˆæœªä¿å­˜ï¼‰
  </button>

  <button class="btn primary" onclick="startBattle()">ãƒãƒˆãƒ«é–‹å§‹ï¼ˆCPUï¼‰</button>
  <button class="btn danger" onclick="showScreen('menu')">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
</div>

<!-- ===== ãƒãƒˆãƒ« ===== -->
<div id="battleScreen" class="screen">
  <div class="battle-screen">

    <!-- ç›¸æ‰‹ã‚¨ãƒªã‚¢ -->
    <div class="enemy-area">
      <div class="enemy-title">ç›¸æ‰‹</div>
      <div class="enemy-status">
        <span>æ‰‹æœ­ï¼š<span id="cpuHandCount">0</span>æš</span>
        <span>ãƒ­ã‚¢ï¼š<span id="cLore">0</span>å€‹</span>
        <span>æ®‹ã‚Šå±±æœ­ï¼š<span id="cDeck">0</span>æš</span>
      </div>
      <div id="cpuField"></div>
    </div>

    <div class="divider"></div>

    <!-- è‡ªåˆ†ã‚¨ãƒªã‚¢ -->
    <div class="player-area">

      <div id="playerField"></div>

      <div id="playerHand"></div>

      <div class="bottom-ui">
        <div class="status-box">
          <div class="status-box-title">è‡ªåˆ†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
          <div>ãƒ­ã‚¢ï¼š<span id="playerLore">0</span></div>
          <div>ã‚¤ãƒ³ã‚¯ï¼š<span id="playerInkCurrent">0</span> / <span id="playerInkMax">0</span></div>
          <div>æ®‹ã‚Šå±±æœ­ï¼š<span id="playerDeck">0</span></div>
          <div id="turnInfo" class="turn-info">è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³</div>

          <div class="status-buttons">
            <!-- ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã«è‡ªå‹•ãƒ‰ãƒ­ãƒ¼ã™ã‚‹ã®ã§ãƒ‰ãƒ­ãƒ¼ãƒœã‚¿ãƒ³ã¯ç„¡ã— -->
            <button class="btn small" onclick="endTurn()">ã‚¿ãƒ¼ãƒ³çµ‚äº†</button>
            <button class="btn small danger" onclick="endBattleToMenu()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
          </div>
        </div>

        <div class="effect-box">
          <div class="effect-box-title">è¡Œå‹• / æƒ…å ±</div>
          <div id="actionArea">ã‚­ãƒ£ãƒ©ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨è¡Œå‹•ã‚’é¸ã¹ã¾ã™ã€‚ï¼ˆãƒ«ãƒ¼ãƒ æˆ¦ã§ã¯ç°¡æ˜“æ“ä½œï¼‰</div>
        </div>
      </div>

      <div class="section-title">ãƒ­ã‚°</div>
      <div id="log" class="log"></div>

    </div>
  </div>
</div>

<!-- ===== ã‚·ãƒ§ãƒƒãƒ— ===== -->
<div id="shopScreen" class="screen">
  <h2>ã‚·ãƒ§ãƒƒãƒ—</h2>
  <p>â€» ä»Šã¯ãƒ†ã‚¹ãƒˆç”¨ã€‚çŸ³ã‚’å¢—ã‚„ã—æ”¾é¡Œã«ã—ã¦ã‚ã‚Šã¾ã™ã€‚</p>
  <p>æ‰€æŒãƒ‰ãƒªãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³: <span id="shopStoneCount">0</span></p>
  <button class="btn" onclick="debugAddStones()">çŸ³ã‚’100å€‹å¢—ã‚„ã™ï¼ˆãƒ†ã‚¹ãƒˆï¼‰</button>
  <button class="btn danger" onclick="showScreen('menu')">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
</div>

<!-- ===== ãƒ‘ãƒƒã‚¯ ===== -->
<div id="packScreen" class="screen">
  <h2>ãƒ‘ãƒƒã‚¯ï¼ˆã‚¬ãƒãƒ£ï¼‰</h2>
  <p>ãƒ‰ãƒªãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³5å€‹ã§1ãƒ‘ãƒƒã‚¯ï¼ˆ5æšå…¥ã‚Šï¼‰</p>
  <p>æ‰€æŒãƒ‰ãƒªãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³: <span id="packStoneCount">0</span></p>
  <button class="btn primary" onclick="openPack()">ãƒ‘ãƒƒã‚¯ã‚’é–‹ã‘ã‚‹</button>
  <div class="section-title">ä»Šå›ã®çµæœ</div>
  <div id="packResult"></div>
  <button class="btn danger" onclick="showScreen('menu')">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
</div>

<!-- ===== ãƒ‡ãƒƒã‚­ç·¨é›† ===== -->
<div id="deckScreen" class="screen">
  <h2>ãƒ‡ãƒƒã‚­ç·¨é›†</h2>
  <p style="font-size:12px; opacity:0.8;">
    æ‰€æŒã‚«ãƒ¼ãƒ‰ã‹ã‚‰ãƒ‡ãƒƒã‚­ã«å…¥ã‚Œã‚‹æšæ•°ã‚’æ±ºã‚ã¦ãã ã•ã„ã€‚ä¿å­˜ã—ãŸãƒ‡ãƒƒã‚­ã¯ãƒãƒˆãƒ«ã§ã€Œè‡ªåˆ†ã®ä½¿ç”¨ãƒ‡ãƒƒã‚­ã€ã§é¸ã¹ã¾ã™ã€‚<br>
    â€» ãƒ‡ãƒƒã‚­ã¯2è‰²ã¾ã§ï¼åŒåã‚«ãƒ¼ãƒ‰ã¯4æšã¾ã§ï¼ˆåŸºæœ¬6ç¨®ã¯ä½•æšã§ã‚‚å¯ï¼‰ï¼æœ€çµ‚çš„ã«60æšä»¥ä¸Š
  </p>

  <div style="margin-bottom:8px;">
    <button class="btn small" onclick="switchDeck(0)">ãƒ‡ãƒƒã‚­1</button>
    <button class="btn small" onclick="switchDeck(1)">ãƒ‡ãƒƒã‚­2</button>
    <button class="btn small" onclick="switchDeck(2)">ãƒ‡ãƒƒã‚­3</button>
    <div style="font-size:12px; opacity:0.9; margin-top:4px;">
      ç¾åœ¨ç·¨é›†ã—ã¦ã„ã‚‹ã®ã¯ï¼šãƒ‡ãƒƒã‚­<span id="currentDeckLabel">1</span>
    </div>
  </div>

  <div id="deckCardList"></div>
  <button class="btn primary" onclick="saveDeck()">ã“ã®å†…å®¹ã§ãƒ‡ãƒƒã‚­ã‚’ä¿å­˜</button>
  <button class="btn danger" onclick="showScreen('menu')">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
</div>

<!-- ===== ã‚«ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ« ===== -->
<div id="collectionScreen" class="screen">
  <h2>ã‚«ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«</h2>
  <div id="collectionList"></div>
  <button class="btn danger" onclick="showScreen('menu')">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
</div>

<!-- ===== ãƒ«ãƒ¼ãƒ æˆ¦ãƒ­ãƒ“ãƒ¼ ===== -->
<div id="roomScreen" class="screen">
  <h2>ãƒ«ãƒ¼ãƒ æˆ¦ï¼ˆÎ²ãƒ»è¦³æˆ¦ä»˜ãï¼‰</h2>
  <p style="font-size:12px;opacity:0.8;">
    Firebaseã‚’ä½¿ã£ãŸç°¡æ˜“ãƒ«ãƒ¼ãƒ ãƒ­ãƒ“ãƒ¼ï¼‹ã‚ªãƒ³ãƒ©ã‚¤ãƒ³è¦³æˆ¦ç‰ˆã§ã™ã€‚<br>
    ä»Šã¯ãƒ›ã‚¹ãƒˆå´ã§å¯¾æˆ¦ã—ã¦ã€ãã®ç›¤é¢ã‚’ã‚²ã‚¹ãƒˆã«å…±æœ‰ã™ã‚‹ã¨ã“ã‚ã¾ã§ã€‚<br>
    ã‚²ã‚¹ãƒˆå´ã‹ã‚‰ã®æ“ä½œã‚‚å«ã‚ãŸæœ¬æ ¼ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ã¯ã€ã“ã®åœŸå°ã®ä¸Šã«æ‹¡å¼µã—ã¦ã„ã‘ã‚‹ã‚ˆã†ã«ã—ã¦ã‚ã‚Šã¾ã™ã€‚
  </p>

  <div class="section-title">ãƒ«ãƒ¼ãƒ ä½œæˆ</div>
  <div style="font-size:13px; margin-bottom:4px;">
    ä¸‹ã®ãƒœã‚¿ãƒ³ã§4æ¡ã®ãƒ«ãƒ¼ãƒ IDã‚’ä½œæˆã—ã¦ã€å‹é”ã«æ•™ãˆã¦ãã ã•ã„ã€‚
  </div>
  <button class="btn" onclick="createRoom()">ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</button>
  <div style="margin-top:6px;">
    ã‚ãªãŸã®ãƒ«ãƒ¼ãƒ ID:
    <span id="roomIdDisplay" style="font-weight:bold;">-</span>
  </div>

  <div class="section-title">ãƒ«ãƒ¼ãƒ ã«å‚åŠ </div>
  <input
    id="joinRoomInput"
    type="text"
    placeholder="4æ¡ã®ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›"
    style="width:100%;padding:6px;margin-bottom:4px;border-radius:6px;border:1px solid #555;background:#111;color:#fff;"
  />
  <button class="btn" onclick="joinRoom()">ã“ã®IDã§å‚åŠ </button>

  <div class="section-title">ãƒ«ãƒ¼ãƒ çŠ¶æ…‹</div>
  <div id="roomInfoText" style="font-size:13px; margin-bottom:8px;">
    ã¾ã ã©ã®ãƒ«ãƒ¼ãƒ ã«ã‚‚å…¥ã£ã¦ã„ã¾ã›ã‚“ã€‚
  </div>
  <div style="font-size:12px;opacity:0.8;margin-bottom:4px;">
    â€»ä»Šã¯ã€Œæº–å‚™OKã€ã¨ã€Œãƒ›ã‚¹ãƒˆå´ã®ç›¤é¢å…±æœ‰ã€ã¾ã§ã€‚<br>
    ä¸¡æ–¹ãŒæº–å‚™OKã«ãªã£ãŸã‚‰ã€ãƒ›ã‚¹ãƒˆãŒã€Œãƒ«ãƒ¼ãƒ æˆ¦é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
  </div>

  <button class="btn small" onclick="setRoomReady(true)">æº–å‚™OK</button>
  <button class="btn small" onclick="setRoomReady(false)">æº–å‚™è§£é™¤</button>
  <button class="btn small danger" onclick="leaveRoom()">ãƒ«ãƒ¼ãƒ ã‹ã‚‰æŠœã‘ã‚‹</button>

  <div style="margin-top:8px;">
    <button class="btn small primary" onclick="hostStartOnlineBattle()">
      ã“ã®ãƒ«ãƒ¼ãƒ ã§ãƒ«ãƒ¼ãƒ æˆ¦é–‹å§‹ï¼ˆãƒ›ã‚¹ãƒˆç”¨ï¼‰
    </button>
  </div>

  <button class="btn danger" style="margin-top:10px;" onclick="showScreen('menu')">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
</div>

<!-- ===== ã‚«ãƒ¼ãƒ‰è©³ç´°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼å„ç¨®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å…±ç”¨ ===== -->
<div id="cardDetailOverlay">
  <div id="cardDetailInner">
    <div id="cardDetailContent"></div>
    <button class="btn" onclick="closeCardDetail()">æˆ»ã‚‹ / é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
/* ========== ç‰¹æ®ŠID ========== */
const ID_RATABAA   = 14;
const ID_LIN       = 13;
const ID_TITAN     = 9;
const ID_PRETZEL   = 16;
const ID_CHAMELEON = 24;
const ID_ERRATA_PRINCE = 31;

/* Eãƒ¬ã‚¢ï¼ˆã‚¨ãƒ³ãƒãƒ£ãƒ³ãƒ†ãƒƒãƒ‰ï¼‰ã®ãƒ¬ãƒ¼ãƒˆ */
const ENCHANTED_RATE = 1 / (288 * 5);

/* ========== ç”»é¢åˆ‡ã‚Šæ›¿ãˆ ========== */
function showScreen(name) {
  const ids = [
    "menuScreen","cpuScreen","battleScreen","shopScreen",
    "packScreen","deckScreen","collectionScreen","roomScreen"
  ];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.remove("active");
  });
  const map = {
    menu: "menuScreen",
    cpu: "cpuScreen",
    battle: "battleScreen",
    shop: "shopScreen",
    pack: "packScreen",
    deck: "deckScreen",
    collection: "collectionScreen",
    room: "roomScreen"
  };
  const target = map[name];
  if (target) {
    document.getElementById(target).classList.add("active");
  }
}

/* ========== ã‚«ãƒ¼ãƒ‰å®šç¾© ========== */
const cards = [
  // åŸºæœ¬6ç¨®
  {id:0, name:"ã‚«ãƒ¼",   color:"red",    type:"character", cost:1, atk:1, hp:3, lore:1, rarity:"N",  inkable:true},
  {id:1, name:"ãƒ«ãƒ‘ãƒ—", color:"purple", type:"character", cost:1, atk:1, hp:3, lore:1, rarity:"N",  inkable:true},
  {id:2, name:"ãƒ«ãƒ–ãƒ–", color:"blue",   type:"character", cost:1, atk:1, hp:3, lore:1, rarity:"N",  inkable:true},
  {id:3, name:"ãƒ­ã‚¤ã‚¨", color:"yellow", type:"character", cost:1, atk:1, hp:3, lore:1, rarity:"N",  inkable:true},
  {id:4, name:"ãƒ­ãƒ¼ã‚·", color:"white",  type:"character", cost:1, atk:1, hp:3, lore:1, rarity:"N",  inkable:true},
  {id:5, name:"ãƒ‰ãƒªãƒŸ", color:"green",  type:"character", cost:1, atk:1, hp:3, lore:1, rarity:"N",  inkable:true},

  // æ—¢å­˜SR/L
  {id:6, name:"çµ‚ç„‰ã®å¤§ç«",          color:"red",    type:"song",      cost:7, atk:0, hp:0, lore:0, rarity:"SR", inkable:false, effect:"boardwipe"},
  {id:7, name:"æ°·çµã®å¥³ç‹ã‚±ãƒ«ã‚µ",    color:"purple", type:"character", cost:8, atk:4, hp:6, lore:3, rarity:"L",  inkable:false, effect:"freeze2", evolveCost:6},
  {id:8, name:"ä¼èª¬ã®å‹‡è€…ã‚¤ãƒ•ãƒªãƒ¼ãƒˆ", color:"red",   type:"character", cost:8, atk:5, hp:5, lore:4, rarity:"L",  inkable:true,  evade:true},

  // ç·‘
  {id:9,  name:"ã‚¿ã‚¤ã‚¿ãƒ³",        color:"red",    type:"character", cost:5, atk:6, hp:5, lore:0, rarity:"SR",
   inkable:true, mustAttack:true, rush:true},  // â˜…çªé€²ã¤ã
  {id:10, name:"ãƒã‚¸ãƒ§ãƒ‰ãƒ©",      color:"red",    type:"character", cost:9, atk:7, hp:5, lore:2, rarity:"L",  inkable:true,  effect:"destroyOnSummon"},
  {id:11, name:"ãã‚ãã‚ãƒ€ãƒƒã‚¯",  color:"red",    type:"character", cost:2, atk:2, hp:3, lore:1, rarity:"N",  inkable:true},

  // é’
  {id:12, name:"ã‚´ãƒ¼ã‚º",       color:"blue",   type:"character", cost:7, atk:3, hp:6, lore:2, rarity:"L",  inkable:false, effect:"toInkOnSummon"},
  {id:13, name:"ãƒªãƒ³",         color:"blue",   type:"character", cost:4, atk:2, hp:4, lore:1, rarity:"L",  inkable:true},
  {id:14, name:"ã‚‰ãŸã°ã‚",     color:"blue",   type:"character", cost:1, atk:1, hp:1, lore:1, rarity:"N",  inkable:true},
  {id:15, name:"ã‚ã‚Šã®ã¾ã¾ã§", color:"blue",   type:"song",      cost:5, atk:0, hp:0, lore:0, rarity:"SR", inkable:true,  effect:"songToInk1"},

  // é»„
  {id:16, name:"ãƒ—ãƒ¬ãƒƒãƒ„ã‚§ãƒ«",   color:"yellow", type:"character", cost:4, atk:1, hp:5, lore:2, rarity:"L",  inkable:true,  effect:"pretzelHealDraw"},
  {id:17, name:"ãƒŸã‚¹ã‚¿ãƒ¼ãƒã‚¸",   color:"yellow", type:"character", cost:3, atk:2, hp:5, lore:1, rarity:"N",  inkable:true},
  {id:18, name:"ãƒ•ãƒ³ãƒãƒ¼",       color:"yellow", type:"character", cost:4, atk:3, hp:5, lore:1, rarity:"N",  inkable:true},
  {id:19, name:"ã‚¢ãƒªã‚¨ãƒŠã‚¤",     color:"yellow", type:"character", cost:3, atk:2, hp:3, lore:1, rarity:"SR", inkable:true,  effect:"arienaiSearchSong", songPower:5},

  /* ===== ã“ã“ã‹ã‚‰æ–°ã‚«ãƒ¼ãƒ‰ ===== */

  // ç·‘ï¼ˆæ–°ï¼‰
  {id:20, name:"ã‚¸ãƒ¼ãƒ¦ãƒ¼",     color:"green",    type:"character", cost:6, atk:3, hp:4, lore:2, rarity:"SR", inkable:false, effect:"bounceOnSummon"},
  {id:21, name:"ã‚¨ãƒ³ãƒãƒ³ã‚¹",   color:"green",    type:"character", cost:4, atk:3, hp:3, lore:3, rarity:"N",  inkable:true},
  {id:22, name:"èƒŒç­‹ãŒãƒ’ãƒ¤ãƒª", color:"green",    type:"song",      cost:2, atk:0, hp:0, lore:0, rarity:"N",  inkable:true,  effect:"discard1"},

  // ç´«ï¼ˆæ–°ï¼‰
  {id:23, name:"ã»ã†ã",               color:"purple", type:"character", cost:2, atk:2, hp:2, lore:1, rarity:"N", inkable:true},
  {id:24, name:"ã‚«ãƒ¡ãƒ¬ã‚ªãƒ³",           color:"purple", type:"character", cost:1, atk:1, hp:1, lore:1, rarity:"N", inkable:true},
  {id:25, name:"ãƒ†ã‚£ãƒ©ãƒŸã‚¹ã®ãŸãã‚‰ã¿", color:"purple", type:"song",      cost:3, atk:0, hp:0, lore:0, rarity:"R", inkable:true, effect:"draw3"},
  {id:26, name:"ãƒã‚¸ãƒ§",               color:"purple", type:"character", cost:3, atk:2, hp:2, lore:1, rarity:"N", inkable:true, effect:"drawOnSummon1"},
  {id:27, name:"ã‚±ãƒ«ã‚µ",               color:"purple", type:"character", cost:3, atk:2, hp:3, lore:1, rarity:"N", inkable:true},

  // ç™½ï¼ˆæ–°ï¼‰
  {id:28, name:"AHNW",        color:"white", type:"song",      cost:5, atk:0, hp:0, lore:0, rarity:"SR", inkable:false, effect:"handReset7"},
  {id:29, name:"ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ï¼", color:"white", type:"song",      cost:3, atk:0, hp:0, lore:0, rarity:"R",  inkable:true,  effect:"damage3"},
  {id:30, name:"å‰£ã§åˆºã›",    color:"white", type:"song",      cost:5, atk:0, hp:0, lore:0, rarity:"R",  inkable:false, effect:"aoe2"},
  {id:31, name:"ã‚¨ãƒ©ãƒƒã‚¿ç‹å­", color:"white", type:"character", cost:2, atk:1, hp:3, lore:1, rarity:"N", inkable:true,  effect:"frenzy2"}
];

/* ========== ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ ========== */
let stones = 0;
let collection = {};
let enchantedCollection = {};
let savedDecks = [[], [], []];
let currentDeckIndex = 0;

/* ========== ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ç³» ========== */
function loadData() {
  const s = localStorage.getItem("ds_stones");
  stones = s ? parseInt(s,10) : 0;

  const c = localStorage.getItem("ds_collection");
  collection = c ? JSON.parse(c) : {};

  const ec = localStorage.getItem("ds_collection_enchanted");
  enchantedCollection = ec ? JSON.parse(ec) : {};

  const d3 = localStorage.getItem("ds_playerDecks");
  if (d3) {
    try {
      const parsed = JSON.parse(d3);
      if (Array.isArray(parsed) && parsed.length === 3) {
        savedDecks = parsed;
      }
    } catch(e) {}
  }

  updateStoneDisplays();
  updatePlayerDeckButtons();
}

function saveStones() {
  localStorage.setItem("ds_stones", String(stones));
  updateStoneDisplays();
}
function saveCollection() {
  localStorage.setItem("ds_collection", JSON.stringify(collection));
}
function saveEnchantedCollection() {
  localStorage.setItem("ds_collection_enchanted", JSON.stringify(enchantedCollection));
}
function savePlayerDecks() {
  localStorage.setItem("ds_playerDecks", JSON.stringify(savedDecks));
}

function updateStoneDisplays() {
  const v1 = document.getElementById("stoneCount");
  const v2 = document.getElementById("shopStoneCount");
  const v3 = document.getElementById("packStoneCount");
  if (v1) v1.textContent = stones;
  if (v2) v2.textContent = stones;
  if (v3) v3.textContent = stones;
}

/* ========== Firebase åˆæœŸåŒ– & ãƒ«ãƒ¼ãƒ æˆ¦ãƒ­ã‚¸ãƒƒã‚¯ ========== */
/* â˜… è‡ªåˆ†ã®Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®šã«æ›¸ãæ›ãˆã¦ã­ â˜… */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT.firebaseio.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

let firebaseDb = null;
let currentRoomId = null;
let currentRoomRole = null;  // "host" or "guest"
let roomRef = null;
let roomListener = null;

/* ãƒ«ãƒ¼ãƒ æˆ¦ç”¨ å…±é€šçŠ¶æ…‹ï¼ˆç°¡æ˜“ã‚ªãƒ³ãƒ©ã‚¤ãƒ³è¦³æˆ¦ï¼‰ */
let battleMode = "cpu";            // "cpu" or "online"
let onlineBattle = null;           // ãƒ«ãƒ¼ãƒ æˆ¦ç”¨ãƒãƒˆãƒ«çŠ¶æ…‹
let myOnlineSide = null;           // "A" or "B"ï¼ˆãƒ›ã‚¹ãƒˆ=A, ã‚²ã‚¹ãƒˆ=Bï¼‰
let onlineBattleStarted = false;
let onlineBattleListener = null;
let commandListener = null;

function initFirebase() {
  try {
    if (!firebase.apps || firebase.apps.length === 0) {
      firebase.initializeApp(firebaseConfig);
    }
    firebaseDb = firebase.database();
  } catch (e) {
    console.error("FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", e);
  }
}

function openRoomScreen() {
  showScreen("room");
  updateRoomInfoText();
}

function randomRoomId() {
  return String(Math.floor(1000 + Math.random() * 9000));
}

function createRoom() {
  if (!firebaseDb) {
    alert("FirebaseãŒã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nfirebaseConfig ã‚’è‡ªåˆ†ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å€¤ã«å¤‰æ›´ã—ã¦ã­ã€‚");
    return;
  }
  const roomId = randomRoomId();
  const ref = firebaseDb.ref("rooms/" + roomId);
  ref.set({
    createdAt: Date.now(),
    hostReady: false,
    guestReady: false,
    battleStarted: false
  }).then(() => {
    attachRoomListener(roomId);
    currentRoomId = roomId;
    currentRoomRole = "host";
    roomRef = ref;
    const disp = document.getElementById("roomIdDisplay");
    if (disp) disp.textContent = roomId;
    updateRoomInfoText();
  }).catch(err => {
    console.error(err);
    alert("ãƒ«ãƒ¼ãƒ ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
  });
}

function joinRoom() {
  if (!firebaseDb) {
    alert("FirebaseãŒã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nfirebaseConfig ã‚’è‡ªåˆ†ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å€¤ã«å¤‰æ›´ã—ã¦ã­ã€‚");
    return;
  }
  const input = document.getElementById("joinRoomInput");
  if (!input) return;
  const roomId = (input.value || "").trim();
  if (!roomId) {
    alert("ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  const ref = firebaseDb.ref("rooms/" + roomId);
  ref.get().then(snap => {
    if (!snap.exists()) {
      alert("ãã®ãƒ«ãƒ¼ãƒ IDã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚");
      return;
    }
    attachRoomListener(roomId);
    currentRoomId = roomId;
    currentRoomRole = "guest";
    roomRef = ref;
    const disp = document.getElementById("roomIdDisplay");
    if (disp) disp.textContent = roomId;
    updateRoomInfoText();
  }).catch(err => {
    console.error(err);
    alert("ãƒ«ãƒ¼ãƒ å‚åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
  });
}

function attachRoomListener(roomId) {
  if (!firebaseDb) return;
  if (roomRef && roomListener) {
    roomRef.off("value", roomListener);
  }
  roomRef = firebaseDb.ref("rooms/" + roomId);
  roomListener = roomRef.on("value", snap => {
    const infoEl = document.getElementById("roomInfoText");
    if (!infoEl) return;
    const val = snap.val();
    if (!val) {
      infoEl.textContent = "ã“ã®ãƒ«ãƒ¼ãƒ ã¯å­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆå‰Šé™¤ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚";
      return;
    }
    let html = "";
    html += "ãƒ«ãƒ¼ãƒ ID: " + roomId + "<br>";
    html += "ãƒ›ã‚¹ãƒˆæº–å‚™: " + (val.hostReady ? "OK" : "æœª") + "<br>";
    html += "ã‚²ã‚¹ãƒˆæº–å‚™: " + (val.guestReady ? "OK" : "æœª") + "<br>";
    if (val.hostReady && val.guestReady) {
      html += "<br>ä¸¡è€…æº–å‚™OKï¼<br>ãƒ›ã‚¹ãƒˆãŒã€Œãƒ«ãƒ¼ãƒ æˆ¦é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
    } else {
      html += "<br>â€»ä¸¡æ–¹ãŒæº–å‚™OKã«ãªã‚‹ã¨é–‹å§‹å¯èƒ½ã§ã™ã€‚";
    }
    if (val.battleStarted) {
      html += "<br><br>å¯¾æˆ¦ä¸­ï¼šãƒãƒˆãƒ«ç”»é¢ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚";
    }
    infoEl.innerHTML = html;

    if (val.battleStarted && !onlineBattleStarted) {
      onlineBattleStarted = true;
      // ã‚²ã‚¹ãƒˆå´ï¼šhostãŒé–‹å§‹ã—ãŸ onlineBattle ã‚’å—ã‘å–ã£ã¦è¦³æˆ¦é–‹å§‹
      if (currentRoomRole === "guest" && val.onlineBattle) {
        battleMode = "online";
        myOnlineSide = "B";
        onlineBattle = val.onlineBattle;
        attachOnlineBattleListener();
        showScreen("battle");
        const logEl = document.getElementById("log");
        if (logEl) logEl.innerHTML = "";
        addLog("ãƒ«ãƒ¼ãƒ æˆ¦ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚ï¼ˆã‚²ã‚¹ãƒˆå´ / è¦³æˆ¦ï¼‰");
        updateBattleUI();
      }
    }
    if (!val.battleStarted && onlineBattleStarted) {
      onlineBattleStarted = false;
    }
  });
}

function updateRoomInfoText() {
  const infoEl = document.getElementById("roomInfoText");
  if (!infoEl) return;
  if (!currentRoomId) {
    infoEl.textContent = "ã¾ã ã©ã®ãƒ«ãƒ¼ãƒ ã«ã‚‚å…¥ã£ã¦ã„ã¾ã›ã‚“ã€‚";
    return;
  }
  let text = "ãƒ«ãƒ¼ãƒ ID: " + currentRoomId + "\n";
  text += "ã‚ãªãŸã¯ " + (currentRoomRole === "host" ? "ãƒ›ã‚¹ãƒˆ" : "ã‚²ã‚¹ãƒˆ") + " ã§ã™ã€‚\n";
  text += "Firebaseã®åŒæœŸçµæœã¯å°‘ã—å¾…ã¤ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚";
  infoEl.textContent = text;
}

function setRoomReady(flag) {
  if (!roomRef || !currentRoomRole) {
    alert("ã¾ãšãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ or å‚åŠ ã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  const key = currentRoomRole === "host" ? "hostReady" : "guestReady";
  roomRef.update({ [key]: !!flag }).catch(err => {
    console.error(err);
    alert("æº–å‚™çŠ¶æ…‹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
  });
}

function leaveRoom() {
  if (roomRef && roomListener) {
    roomRef.off("value", roomListener);
  }
  if (roomRef && onlineBattleListener) {
    roomRef.child("onlineBattle").off("value", onlineBattleListener);
  }
  if (roomRef && commandListener) {
    roomRef.child("commands").off("child_added", commandListener);
  }
  // ãƒ›ã‚¹ãƒˆãŒæŠœã‘ã‚‹ãªã‚‰ãƒ«ãƒ¼ãƒ å‰Šé™¤ï¼ˆç°¡æ˜“ï¼‰
  if (roomRef && currentRoomRole === "host") {
    roomRef.remove().catch(e => console.error(e));
  }
  currentRoomId = null;
  currentRoomRole = null;
  roomRef = null;
  roomListener = null;
  onlineBattleListener = null;
  commandListener = null;
  onlineBattle = null;
  onlineBattleStarted = false;
  battleMode = "cpu";

  const disp = document.getElementById("roomIdDisplay");
  if (disp) disp.textContent = "-";
  const infoEl = document.getElementById("roomInfoText");
  if (infoEl) infoEl.textContent = "ã¾ã ã©ã®ãƒ«ãƒ¼ãƒ ã«ã‚‚å…¥ã£ã¦ã„ã¾ã›ã‚“ã€‚";
}

/* ===== ãƒ«ãƒ¼ãƒ æˆ¦ï¼ˆç°¡æ˜“ã‚ªãƒ³ãƒ©ã‚¤ãƒ³è¦³æˆ¦ï¼‰ ===== */

/* ãƒ›ã‚¹ãƒˆãŒã€Œãƒ«ãƒ¼ãƒ æˆ¦é–‹å§‹ã€ã‚’æŠ¼ã—ãŸã¨ã */
function hostStartOnlineBattle() {
  if (!roomRef || currentRoomRole !== "host") {
    alert("ãƒ›ã‚¹ãƒˆã®ã¿ãŒãƒ«ãƒ¼ãƒ æˆ¦ã‚’é–‹å§‹ã§ãã¾ã™ã€‚");
    return;
  }
  roomRef.get().then(snap => {
    const val = snap.val();
    if (!val || !val.hostReady || !val.guestReady) {
      alert("ä¸¡ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæº–å‚™OKã«ãªã£ã¦ã‹ã‚‰é–‹å§‹ã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    // ã¨ã‚Šã‚ãˆãšãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèµ¤ãƒ‡ãƒƒã‚­ã‚’ä¸¡è€…å…±é€šã§ä½¿ã†
    const ids = makeDefaultDeck();
    const baseDeck = ids.map(id => {
      const base = cards.find(c => c.id === id);
      return makeCardInstance(base, false);
    });

    const deckA = JSON.parse(JSON.stringify(baseDeck));
    const deckB = JSON.parse(JSON.stringify(baseDeck));
    shuffle(deckA);
    shuffle(deckB);

    onlineBattle = {
      turnCount: 1,
      currentPlayer: "A",
      A: { deck: deckA, hand: [], field: [], inkCurrent: 0, inkMax: 0, lore: 0 },
      B: { deck: deckB, hand: [], field: [], inkCurrent: 0, inkMax: 0, lore: 0 }
    };

    // åˆæœŸæ‰‹æœ­5æšãšã¤
    for (let i = 0; i < 5; i++) {
      if (onlineBattle.A.deck.length) {
        const c = onlineBattle.A.deck.shift();
        onlineBattle.A.hand.push(c);
      }
      if (onlineBattle.B.deck.length) {
        const c2 = onlineBattle.B.deck.shift();
        onlineBattle.B.hand.push(c2);
      }
    }

    battleMode = "online";
    myOnlineSide = "A";
    onlineBattleStarted = true;

    // Firebaseã«æ›¸ãè¾¼ã¿ï¼†ãƒªã‚¹ãƒŠãƒ¼ã‚»ãƒƒãƒˆ
    roomRef.update({
      battleStarted: true,
      onlineBattle: onlineBattle
    }).then(() => {
      attachOnlineBattleListener();
      attachCommandListenerForHost();
      showScreen("battle");
      const logEl = document.getElementById("log");
      if (logEl) logEl.innerHTML = "";
      addLog("ãƒ«ãƒ¼ãƒ æˆ¦ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚ï¼ˆãƒ›ã‚¹ãƒˆå´ï¼‰");
      // ã‚¿ãƒ¼ãƒ³é–‹å§‹å‡¦ç†
      onlineStartTurn("A", true);
    }).catch(err => {
      console.error(err);
      alert("ãƒ«ãƒ¼ãƒ æˆ¦ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    });
  });
}

/* Firebaseä¸Šã® onlineBattle ã‚’ç›£è¦– */
function attachOnlineBattleListener() {
  if (!roomRef) return;
  if (onlineBattleListener) {
    roomRef.child("onlineBattle").off("value", onlineBattleListener);
  }
  onlineBattleListener = roomRef.child("onlineBattle").on("value", snap => {
    const data = snap.val();
    if (!data) return;
    onlineBattle = data;
    updateBattleUI();
  });
}

/* ã‚²ã‚¹ãƒˆâ†’ãƒ›ã‚¹ãƒˆã¸ã®æ“ä½œã‚³ãƒãƒ³ãƒ‰ */
function sendRoomCommand(cmd) {
  if (!roomRef || !currentRoomRole) return;
  roomRef.child("commands").push({
    ...cmd,
    from: currentRoomRole,
    createdAt: Date.now()
  });
}

/* ãƒ›ã‚¹ãƒˆå´ï¼šã‚²ã‚¹ãƒˆã‹ã‚‰ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å—ä¿¡ */
function attachCommandListenerForHost() {
  if (!roomRef) return;
  if (commandListener) {
    roomRef.child("commands").off("child_added", commandListener);
  }
  commandListener = roomRef.child("commands").on("child_added", snap => {
    const cmd = snap.val();
    const key = snap.key;
    if (!cmd || cmd.from !== "guest") return;
    handleOnlineGuestCommand(cmd);
    // å‡¦ç†ã—ãŸã‚³ãƒãƒ³ãƒ‰ã¯å‰Šé™¤
    roomRef.child("commands/" + key).remove();
  });
}

/* ã‚²ã‚¹ãƒˆã‹ã‚‰ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ãƒ›ã‚¹ãƒˆå´ã§å‡¦ç†ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç°¡æ˜“ç‰ˆï¼‰ */
function handleOnlineGuestCommand(cmd) {
  if (!onlineBattle) return;
  // ã‚²ã‚¹ãƒˆã¯å¸¸ã«Bå´
  const side = "B";
  if (cmd.type === "playCharacter") {
    onlinePlayCharacter(side, cmd.handIndex);
  } else if (cmd.type === "seek") {
    onlineSeek(side, cmd.fieldIndex);
  } else if (cmd.type === "challenge") {
    onlineChallenge(side, cmd.fieldIndex);
  } else if (cmd.type === "endTurn") {
    onlineEndTurn(side);
  }
}

/* ===== ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ç”¨ ç°¡æ˜“ã‚¨ãƒ³ã‚¸ãƒ³ ===== */

function isMyTurnOnline() {
  if (!onlineBattle || !myOnlineSide) return false;
  return onlineBattle.currentPlayer === myOnlineSide;
}

function syncOnlineBattleToFirebase() {
  if (!onlineBattle) return;
  if (battleMode === "online" && roomRef && currentRoomRole === "host") {
    roomRef.child("onlineBattle").set(onlineBattle);
  }
}

function onlineStartTurn(sideKey, isFirst) {
  if (!onlineBattle) return;
  if (!isFirst) {
    onlineBattle.turnCount++;
  }
  onlineBattle.currentPlayer = sideKey;
  const s = onlineBattle[sideKey];
  s.inkMax = Math.min(s.inkMax + 1, 10);
  s.inkCurrent = s.inkMax;
  s.field.forEach(c => {
    c.rest = false;
    c.frozen = false;
  });
  if (s.deck.length > 0) {
    const c = s.deck.shift();
    s.hand.push(c);
  }
  const who = (sideKey === myOnlineSide) ? "è‡ªåˆ†" : "ç›¸æ‰‹";
  addLog(`=== ${who}ã®ã‚¿ãƒ¼ãƒ³ ${onlineBattle.turnCount} ===`);
  syncOnlineBattleToFirebase();
  updateBattleUI();
}

function onlinePlayCharacter(sideKey, handIndex) {
  if (!onlineBattle) return;
  if (onlineBattle.currentPlayer !== sideKey) return;
  const s = onlineBattle[sideKey];
  const card = s.hand[handIndex];
  if (!card || card.type !== "character") return;
  if (s.inkCurrent < card.cost) return;
  s.inkCurrent -= card.cost;
  s.hand.splice(handIndex, 1);
  card.rest = false;
  card.frozen = false;
  card.summonTurn = onlineBattle.turnCount;
  s.field.push(card);
  const who = (sideKey === myOnlineSide) ? "è‡ªåˆ†" : "ç›¸æ‰‹";
  addLog(`${who}ã¯ã€Œ${card.name}ã€ã‚’å¬å–šã—ãŸã€‚`);
  syncOnlineBattleToFirebase();
  updateBattleUI();
}

function onlineSeek(sideKey, fieldIndex) {
  if (!onlineBattle) return;
  if (onlineBattle.currentPlayer !== sideKey) return;
  const

function onlineSeek(sideKey, fieldIndex) {
  if (!onlineBattle) return;
  if (onlineBattle.currentPlayer !== sideKey) return;

  const s = onlineBattle[sideKey];
  const card = s.field[fieldIndex];
  if (!card || card.type !== "character") return;

  // å¬å–šã‚¿ãƒ¼ãƒ³ã¯ã‚·ãƒ¼ã‚¯ä¸å¯
  if (card.summonTurn === onlineBattle.turnCount) return;
  if (card.rest || card.frozen) return;

  card.rest = true;
  const gain = card.lore || 0;
  s.lore = (s.lore || 0) + gain;

  const who = (sideKey === myOnlineSide) ? "è‡ªåˆ†" : "ç›¸æ‰‹";
  addLog(`${who}ã¯ã€Œ${card.name}ã€ã§ã‚·ãƒ¼ã‚¯ã—ã¦ã€ãƒ­ã‚¢ã‚’${gain}å¾—ãŸã€‚ï¼ˆåˆè¨ˆ ${s.lore}ï¼‰`);

  checkOnlineWin();
  syncOnlineBattleToFirebase();
  updateBattleUI();
}

function onlineChallenge(sideKey, fieldIndex) {
  if (!onlineBattle) return;
  if (onlineBattle.currentPlayer !== sideKey) return;

  const atkSide = onlineBattle[sideKey];
  const defSideKey = (sideKey === "A") ? "B" : "A";
  const defSide = onlineBattle[defSideKey];

  const attacker = atkSide.field[fieldIndex];
  if (!attacker || attacker.type !== "character") return;

  // å¬å–šã‚¿ãƒ¼ãƒ³ã¯ãƒãƒ£ãƒ¬ãƒ³ã‚¸ä¸å¯
  if (attacker.summonTurn === onlineBattle.turnCount) return;
  if (attacker.rest || attacker.frozen) return;

  if (!defSide.field.length) {
    addLog("ç›¸æ‰‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚­ãƒ£ãƒ©ãŒã„ãªã„ãŸã‚ã€ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã§ãã¾ã›ã‚“ã€‚");
    return;
  }

  // ç°¡æ˜“ï¼šç›¸æ‰‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ä¸­ã§HPãŒä¸€ç•ªä½ã„ã‚­ãƒ£ãƒ©ã‚’è‡ªå‹•ã§æ®´ã‚‹
  let targetIndex = 0;
  let minHp = defSide.field[0].hp;
  for (let i = 1; i < defSide.field.length; i++) {
    if (defSide.field[i].hp < minHp) {
      minHp = defSide.field[i].hp;
      targetIndex = i;
    }
  }
  const defender = defSide.field[targetIndex];

  attacker.rest = true;

  addLog(`ã€Œ${attacker.name}ã€ãŒã€Œ${defender.name}ã€ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼`);

  // åŒæ™‚ãƒ€ãƒ¡ãƒ¼ã‚¸
  defender.hp -= attacker.atk;
  attacker.hp -= defender.atk;

  if (defender.hp <= 0) {
    addLog(`ç›¸æ‰‹ã®ã€Œ${defender.name}ã€ã¯é€€å ´ã—ãŸã€‚`);
    defSide.field.splice(targetIndex, 1);
  }
  if (attacker.hp <= 0) {
    addLog(`è‡ªåˆ†ã®ã€Œ${attacker.name}ã€ã¯é€€å ´ã—ãŸã€‚`);
    atkSide.field.splice(fieldIndex, 1);
  }

  syncOnlineBattleToFirebase();
  updateBattleUI();
}

function onlineEndTurn(sideKey) {
  if (!onlineBattle) return;
  if (onlineBattle.currentPlayer !== sideKey) return;
  const next = (sideKey === "A") ? "B" : "A";
  onlineStartTurn(next, false);
}

function checkOnlineWin() {
  if (!onlineBattle) return;
  const LORE_WIN = 20;

  if ((onlineBattle.A.lore || 0) >= LORE_WIN &&
      (onlineBattle.B.lore || 0) >= LORE_WIN) {
    addLog("ä¸¡è€…ãƒ­ã‚¢20ä»¥ä¸Šï¼å¼•ãåˆ†ã‘ã§ã™ã€‚");
    return;
  }
  if ((onlineBattle.A.lore || 0) >= LORE_WIN) {
    addLog("Aå´ã®å‹åˆ©ï¼ï¼ˆãƒ­ã‚¢20åˆ°é”ï¼‰");
  }
  if ((onlineBattle.B.lore || 0) >= LORE_WIN) {
    addLog("Bå´ã®å‹åˆ©ï¼ï¼ˆãƒ­ã‚¢20åˆ°é”ï¼‰");
  }
}

/* ========== å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========== */

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

function makeCardInstance(base, isEnchanted) {
  return {
    id: base.id,
    name: base.name,
    color: base.color,
    type: base.type,
    cost: base.cost,
    atk: base.atk,
    hp: base.hp,
    lore: base.lore,
    rarity: base.rarity,
    inkable: base.inkable,
    effect: base.effect || null,
    songPower: base.songPower || 0,
    mustAttack: !!base.mustAttack,
    rush: !!base.rush,
    evade: !!base.evade,
    evolveCost: base.evolveCost || null,
    enchanted: !!isEnchanted,
    rest: false,
    frozen: false,
    summonTurn: 0
  };
}

/* ========== ãƒ­ã‚° & ã‚«ãƒ¼ãƒ‰æç”» ========== */

function addLog(text) {
  const logEl = document.getElementById("log");
  if (!logEl) return;
  const line = document.createElement("div");
  line.textContent = text;
  logEl.appendChild(line);
  logEl.scrollTop = logEl.scrollHeight;
}

/* ãƒãƒˆãƒ«ç”»é¢ã®æç”»ï¼ˆCPU / ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å…±é€šï¼‰ */
function updateBattleUI() {
  const cpuFieldEl    = document.getElementById("cpuField");
  const playerFieldEl = document.getElementById("playerField");
  const playerHandEl  = document.getElementById("playerHand");

  const cpuHandCountEl = document.getElementById("cpuHandCount");
  const cLoreEl        = document.getElementById("cLore");
  const cDeckEl        = document.getElementById("cDeck");

  const playerLoreEl   = document.getElementById("playerLore");
  const playerInkCurEl = document.getElementById("playerInkCurrent");
  const playerInkMaxEl = document.getElementById("playerInkMax");
  const playerDeckEl   = document.getElementById("playerDeck");
  const turnInfoEl     = document.getElementById("turnInfo");

  if (!cpuFieldEl || !playerFieldEl || !playerHandEl) return;

  cpuFieldEl.innerHTML = "";
  playerFieldEl.innerHTML = "";
  playerHandEl.innerHTML = "";

  if (battleMode === "online" && onlineBattle) {
    const meSide    = myOnlineSide;
    const oppSide   = (meSide === "A") ? "B" : "A";
    const me        = onlineBattle[meSide];
    const opp       = onlineBattle[oppSide];

    // ä¸Šæ®µï¼šç›¸æ‰‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    opp.field.forEach((card, idx) => {
      const el = createBattleCardElement(card, false, () => {
        // ç›¸æ‰‹ã‚«ãƒ¼ãƒ‰ã¯ã‚¯ãƒªãƒƒã‚¯ã ã‘ã§è©³ç´°è¡¨ç¤º
        showCardDetail(card);
      });
      cpuFieldEl.appendChild(el);
    });

    // ä¸‹æ®µï¼šè‡ªåˆ†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    me.field.forEach((card, idx) => {
      const el = createBattleCardElement(card, false, () => {
        if (!isMyTurnOnline()) {
          showCardDetail(card);
          return;
        }
        openOnlineActionPopup("field", idx);
      });
      playerFieldEl.appendChild(el);
    });

    // è‡ªåˆ†æ‰‹æœ­
    me.hand.forEach((card, idx) => {
      const el = createBattleCardElement(card, true, () => {
        if (!isMyTurnOnline()) {
          showCardDetail(card);
          return;
        }
        if (card.type === "character") {
          onlinePlayCharacter(meSide, idx);
        } else {
          // ä»Šã¯ã‚­ãƒ£ãƒ©ä»¥å¤–ã¯è©³ç´°è¡¨ç¤ºã®ã¿ï¼ˆç°¡æ˜“ç‰ˆï¼‰
          showCardDetail(card);
        }
      });
      playerHandEl.appendChild(el);
    });

    if (cpuHandCountEl) cpuHandCountEl.textContent = opp.hand.length;
    if (cLoreEl)        cLoreEl.textContent        = opp.lore || 0;
    if (cDeckEl)        cDeckEl.textContent        = opp.deck.length;

    if (playerLoreEl)   playerLoreEl.textContent   = me.lore || 0;
    if (playerInkCurEl) playerInkCurEl.textContent = me.inkCurrent || 0;
    if (playerInkMaxEl) playerInkMaxEl.textContent = me.inkMax || 0;
    if (playerDeckEl)   playerDeckEl.textContent   = me.deck.length;

    if (turnInfoEl) {
      if (isMyTurnOnline()) {
        turnInfoEl.textContent = "è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼‰";
      } else {
        turnInfoEl.textContent = "ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼‰";
      }
    }
    return;
  }

  // ===== CPUæˆ¦ãƒ¢ãƒ¼ãƒ‰ =====
  if (!gameState) return;
  const me     = gameState.player;
  const opp    = gameState.cpu;

  // CPUãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  opp.field.forEach((card, idx) => {
    const el = createBattleCardElement(card, false, () => {
      showCardDetail(card);
    });
    cpuFieldEl.appendChild(el);
  });

  // è‡ªåˆ†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  me.field.forEach((card, idx) => {
    const el = createBattleCardElement(card, false, () => {
      if (gameState.currentPlayer !== "player") {
        showCardDetail(card);
        return;
      }
      openCpuBattleActionPopup("field", idx);
    });
    playerFieldEl.appendChild(el);
  });

  // è‡ªåˆ†æ‰‹æœ­
  me.hand.forEach((card, idx) => {
    const el = createBattleCardElement(card, true, () => {
      if (gameState.currentPlayer !== "player") {
        showCardDetail(card);
        return;
      }
      if (card.type === "character") {
        cpuBattlePlayCharacter(idx);
      } else {
        // ã‚½ãƒ³ã‚°/ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ä»Šã¯è©³ç´°è¡¨ç¤ºã®ã¿ï¼ˆç°¡æ˜“ï¼‰
        showCardDetail(card);
      }
    });
    playerHandEl.appendChild(el);
  });

  if (cpuHandCountEl) cpuHandCountEl.textContent = opp.hand.length;
  if (cLoreEl)        cLoreEl.textContent        = opp.lore || 0;
  if (cDeckEl)        cDeckEl.textContent        = opp.deck.length;

  if (playerLoreEl)   playerLoreEl.textContent   = me.lore || 0;
  if (playerInkCurEl) playerInkCurEl.textContent = me.inkCurrent || 0;
  if (playerInkMaxEl) playerInkMaxEl.textContent = me.inkMax || 0;
  if (playerDeckEl)   playerDeckEl.textContent   = me.deck.length;

  if (turnInfoEl) {
    turnInfoEl.textContent =
      (gameState.currentPlayer === "player")
        ? "è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ï¼ˆCPUæˆ¦ï¼‰"
        : "CPUã®ã‚¿ãƒ¼ãƒ³";
  }
}

/* 1æšã®ã‚«ãƒ¼ãƒ‰ã‚’HTMLè¦ç´ åŒ–ï¼ˆãƒãƒˆãƒ«ç”¨ï¼‰ */
function createBattleCardElement(card, isHand, onClick) {
  const div = document.createElement("div");
  div.className = "card " + card.color + (card.rest ? " rest" : "") +
                  (card.enchanted ? " enchanted" : "");
  div.onclick = onClick;

  const header = document.createElement("div");
  header.className = "card-header";
  const costEl = document.createElement("div");
  costEl.className = "card-cost";
  costEl.textContent = card.cost;
  const nameEl = document.createElement("div");
  nameEl.className = "card-name-header";
  nameEl.textContent = card.name;
  const inkableEl = document.createElement("div");
  inkableEl.className = "card-inkable";
  inkableEl.textContent = card.inkable ? "â—" : "Ã—";
  header.appendChild(costEl);
  header.appendChild(nameEl);
  header.appendChild(inkableEl);

  const illust = document.createElement("div");
  illust.className = "card-illustration";
  // å®Ÿç”»åƒã‚’ä½¿ã‚ãªã„ç°¡æ˜“ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
  const ph = document.createElement("div");
  ph.style.width = "100%";
  ph.style.height = "100%";
  ph.style.display = "flex";
  ph.style.alignItems = "center";
  ph.style.justifyContent = "center";
  ph.style.fontSize = "9px";
  ph.style.color = "#000";
  ph.textContent = card.name;
  illust.appendChild(ph);

  const statRow = document.createElement("div");
  statRow.className = "card-stats-row";
  const atkEl = document.createElement("div");
  atkEl.textContent = "ATK " + card.atk;
  const hpEl = document.createElement("div");
  hpEl.textContent = "HP " + card.hp;
  const loreEl = document.createElement("div");
  loreEl.textContent = "ãƒ­ã‚¢ " + card.lore;
  statRow.appendChild(atkEl);
  statRow.appendChild(hpEl);
  statRow.appendChild(loreEl);

  const footer = document.createElement("div");
  footer.className = "card-footer";
  footer.textContent =
    (card.type === "character" ? "ã‚­ãƒ£ãƒ©" :
     card.type === "song" ? "ã‚½ãƒ³ã‚°" : card.type) +
    (card.effect ? "ï¼åŠ¹æœã‚ã‚Š" : "");

  div.appendChild(header);
  div.appendChild(illust);
  div.appendChild(statRow);
  div.appendChild(footer);

  return div;
}

/* ========== CPUæˆ¦ç”¨ãƒ­ã‚¸ãƒƒã‚¯ ========== */

let cpuStrength = "normal"; // "normal" or "strong"
let cpuColors = [];
let selectedPlayerDeckKey = "default";
let gameState = null;

function openCpuConfig() {
  showScreen("cpu");
}

function setCpuStrength(level) {
  cpuStrength = level;
  const btnN = document.getElementById("btnCpuNormal");
  const btnS = document.getElementById("btnCpuStrong");
  if (btnN) btnN.classList.toggle("toggle-selected", level === "normal");
  if (btnS) btnS.classList.toggle("toggle-selected", level === "strong");
}

function setCpuColor(color) {
  const idx = cpuColors.indexOf(color);
  if (idx >= 0) {
    cpuColors.splice(idx, 1);
  } else {
    if (cpuColors.length >= 2) {
      alert("CPUãƒ‡ãƒƒã‚­è‰²ã¯2è‰²ã¾ã§ã§ã™ã€‚");
      return;
    }
    cpuColors.push(color);
  }
  ["red","purple","blue","yellow","white","green"].forEach(c => {
    const btn = document.getElementById("cpu" + c.charAt(0).toUpperCase() + c.slice(1));
    if (btn) btn.classList.toggle("toggle-selected", cpuColors.includes(c));
  });
}

function selectPlayerDeck(key) {
  selectedPlayerDeckKey = key;
  const list = [
    {id:"btnPlayerDefault", key:"default"},
    {id:"btnDeck1", key:"deck1"},
    {id:"btnDeck2", key:"deck2"},
    {id:"btnDeck3", key:"deck3"}
  ];
  list.forEach(info => {
    const btn = document.getElementById(info.id);
    if (!btn) return;
    btn.classList.toggle("toggle-selected", info.key === key);
  });
}

/* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèµ¤ãƒ‡ãƒƒã‚­ */
function makeDefaultDeck() {
  const ids = [];
  for (let i = 0; i < 10; i++) ids.push(0);   // ã‚«ãƒ¼
  for (let i = 0; i < 8; i++)  ids.push(11);  // ãã‚ãã‚ãƒ€ãƒƒã‚¯
  for (let i = 0; i < 4; i++)  ids.push(9);   // ã‚¿ã‚¤ã‚¿ãƒ³
  for (let i = 0; i < 2; i++)  ids.push(8);   // ã‚¤ãƒ•ãƒªãƒ¼ãƒˆ
  for (let i = 0; i < 2; i++)  ids.push(6);   // çµ‚ç„‰ã®å¤§ç«
  return ids;
}

/* savedDecks ã‹ã‚‰ãƒ‡ãƒƒã‚­ã‚’ç”Ÿæˆï¼ˆãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ */
function makePlayerDeckFromSaved(key) {
  if (key === "default") {
    return makeDefaultDeck();
  }
  const idx = key === "deck1" ? 0 : key === "deck2" ? 1 : 2;
  const arr = savedDecks[idx];
  if (!Array.isArray(arr) || arr.length < 40) {
    alert("ãã®ãƒ‡ãƒƒã‚­ã¯æœªä¿å­˜ã‹40æšæœªæº€ã®ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèµ¤ãƒ‡ãƒƒã‚­ã«ãªã‚Šã¾ã™ã€‚");
    return makeDefaultDeck();
  }
  return arr.slice();
}

/* CPUç”¨ 2è‰²ãƒ©ãƒ³ãƒ€ãƒ ãƒ‡ãƒƒã‚­ï¼ˆç°¡æ˜“ï¼‰ */
function makeCpuDeck() {
  if (cpuColors.length === 0) cpuColors = ["red","purple"];
  const cols = cpuColors.slice();
  while (cols.length < 2) cols.push(cols[0]);

  const ids = [];
  for (let i = 0; i < 30; i++) {
    const c = cols[i % 2];
    const candidates = cards.filter(cd => cd.color === c && cd.type === "character");
    if (candidates.length === 0) {
      ids.push(0);
    } else {
      const base = candidates[Math.floor(Math.random() * candidates.length)];
      ids.push(base.id);
    }
  }
  return ids;
}

function startBattle() {
  battleMode = "cpu";

  const playerDeckIds = makePlayerDeckFromSaved(selectedPlayerDeckKey);
  const cpuDeckIds    = makeCpuDeck();

  const playerDeck = playerDeckIds.map(id => makeCardInstance(cards.find(c => c.id === id), false));
  const cpuDeck    = cpuDeckIds.map(id => makeCardInstance(cards.find(c => c.id === id), false));

  shuffle(playerDeck);
  shuffle(cpuDeck);

  gameState = {
    turnCount: 1,
    currentPlayer: "player",
    player: {
      deck: playerDeck,
      hand: [],
      field: [],
      inkCurrent: 0,
      inkMax: 0,
      lore: 0
    },
    cpu: {
      deck: cpuDeck,
      hand: [],
      field: [],
      inkCurrent: 0,
      inkMax: 0,
      lore: 0
    }
  };

  for (let i = 0; i < 5; i++) {
    if (gameState.player.deck.length) {
      gameState.player.hand.push(gameState.player.deck.shift());
    }
    if (gameState.cpu.deck.length) {
      gameState.cpu.hand.push(gameState.cpu.deck.shift());
    }
  }

  startCpuStyleTurn("player", true);

  showScreen("battle");
  const logEl = document.getElementById("log");
  if (logEl) logEl.innerHTML = "";
  addLog("CPUæˆ¦ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚");
  updateBattleUI();
}

function startCpuStyleTurn(who, isFirst) {
  if (!gameState) return;
  if (!isFirst) {
    gameState.turnCount++;
  }
  gameState.currentPlayer = who;
  const side = (who === "player") ? gameState.player : gameState.cpu;
  side.inkMax = Math.min(side.inkMax + 1, 10);
  side.inkCurrent = side.inkMax;
  side.field.forEach(c => {
    c.rest = false;
    c.frozen = false;
  });
  if (side.deck.length) {
    const c = side.deck.shift();
    side.hand.push(c);
  }
  addLog(`=== ${who === "player" ? "è‡ªåˆ†" : "CPU"}ã®ã‚¿ãƒ¼ãƒ³ ${gameState.turnCount} ===`);
  updateBattleUI();

  if (who === "cpu") {
    setTimeout(cpuDoTurn, 400);
  }
}

function endTurn() {
  if (battleMode === "online") {
    if (!onlineBattle || !myOnlineSide) return;
    onlineEndTurn(myOnlineSide);
    return;
  }
  if (!gameState || gameState.currentPlayer !== "player") return;
  startCpuStyleTurn("cpu", false);
}

function cpuDoTurn() {
  if (!gameState || gameState.currentPlayer !== "cpu") return;
  const me  = gameState.cpu;
  const you = gameState.player;

  // 1. å‡ºã›ã‚‹ã‚­ãƒ£ãƒ©ã‚’å…¨éƒ¨å‡ºã™ï¼ˆç°¡æ˜“ï¼‰
  let played = true;
  while (played) {
    played = false;
    for (let i = 0; i < me.hand.length; i++) {
      const card = me.hand[i];
      if (card.type === "character" && card.cost <= me.inkCurrent) {
        me.inkCurrent -= card.cost;
        card.rest = false;
        card.frozen = false;
        card.summonTurn = gameState.turnCount;
        me.field.push(card);
        me.hand.splice(i, 1);
        addLog(`CPUã¯ã€Œ${card.name}ã€ã‚’å¬å–šã—ãŸã€‚`);
        played = true;
        break;
      }
    }
  }

  // 2. å¬å–šæ¸ˆã¿ã‚­ãƒ£ãƒ©ã§ã‚·ãƒ¼ã‚¯ or ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ˆé©å½“ï¼‰
  me.field.forEach((card, idx) => {
    if (card.rest || card.frozen) return;
    if (card.summonTurn === gameState.turnCount && !card.rush) {
      return;
    }
    if (you.field.length === 0 || card.lore >= 2) {
      card.rest = true;
      me.lore += card.lore || 0;
      addLog(`CPUã®ã€Œ${card.name}ã€ãŒã‚·ãƒ¼ã‚¯ã—ã¦ãƒ­ã‚¢ã‚’${card.lore}ç²å¾—ã—ãŸã€‚ï¼ˆåˆè¨ˆ ${me.lore}ï¼‰`);
    } else {
      const target = you.field[0];
      card.rest = true;
      addLog(`CPUã®ã€Œ${card.name}ã€ãŒã‚ãªãŸã®ã€Œ${target.name}ã€ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼`);
      target.hp -= card.atk;
      card.hp -= target.atk;
      if (target.hp <= 0) {
        addLog(`ã‚ãªãŸã®ã€Œ${target.name}ã€ã¯é€€å ´ã—ãŸã€‚`);
        you.field.splice(you.field.indexOf(target), 1);
      }
      if (card.hp <= 0) {
        addLog(`CPUã®ã€Œ${card.name}ã€ã¯é€€å ´ã—ãŸã€‚`);
        me.field.splice(me.field.indexOf(card), 1);
      }
    }
  });

  checkCpuStyleWin();
  updateBattleUI();

  // ã‚¿ãƒ¼ãƒ³çµ‚äº†
  startCpuStyleTurn("player", false);
}

function checkCpuStyleWin() {
  if (!gameState) return;
  const LORE_WIN = 20;
  if (gameState.player.lore >= LORE_WIN && gameState.cpu.lore >= LORE_WIN) {
    addLog("ä¸¡è€…ãƒ­ã‚¢20ä»¥ä¸Šï¼å¼•ãåˆ†ã‘ã§ã™ã€‚");
  } else if (gameState.player.lore >= LORE_WIN) {
    addLog("ã‚ãªãŸã®å‹åˆ©ï¼ï¼ˆãƒ­ã‚¢20åˆ°é”ï¼‰");
  } else if (gameState.cpu.lore >= LORE_WIN) {
    addLog("CPUã®å‹åˆ©ï¼ï¼ˆãƒ­ã‚¢20åˆ°é”ï¼‰");
  }
}

/* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œï¼šæ‰‹æœ­ã®ã‚­ãƒ£ãƒ©ã‚’å‡ºã™ï¼ˆCPUæˆ¦ï¼‰ */
function cpuBattlePlayCharacter(handIndex) {
  if (!gameState || gameState.currentPlayer !== "player") return;
  const me = gameState.player;
  const card = me.hand[handIndex];
  if (!card || card.type !== "character") return;
  if (me.inkCurrent < card.cost) {
    addLog("ã‚¤ãƒ³ã‚¯ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }
  me.inkCurrent -= card.cost;
  me.hand.splice(handIndex, 1);
  card.rest = false;
  card.frozen = false;
  card.summonTurn = gameState.turnCount;
  me.field.push(card);
  addLog(`ã‚ãªãŸã¯ã€Œ${card.name}ã€ã‚’å¬å–šã—ãŸã€‚`);
  updateBattleUI();
}

/* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œï¼šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚­ãƒ£ãƒ©ã®è¡Œå‹•é¸æŠï¼ˆCPUæˆ¦ï¼‰ */
function openCpuBattleActionPopup(zone, index) {
  const card = gameState.player.field[index];
  if (!card) return;
  if (card.rest || card.frozen) {
    showCardDetail(card);
    return;
  }
  if (card.summonTurn === gameState.turnCount && !card.rush) {
    showCardDetail(card);
    return;
  }

  const area = document.getElementById("actionArea");
  if (!area) return;

  area.innerHTML = "";
  const title = document.createElement("div");
  title.textContent = `ã€Œ${card.name}ã€ã®è¡Œå‹•ã‚’é¸æŠï¼š`;
  area.appendChild(title);

  const btnSeek = document.createElement("button");
  btnSeek.className = "btn small";
  btnSeek.textContent = "ã‚·ãƒ¼ã‚¯ï¼ˆãƒ­ã‚¢ç²å¾—ï¼‰";
  btnSeek.onclick = () => {
    card.rest = true;
    gameState.player.lore += card.lore || 0;
    addLog(`ã‚ãªãŸã®ã€Œ${card.name}ã€ãŒã‚·ãƒ¼ã‚¯ã—ã¦ãƒ­ã‚¢ã‚’${card.lore}ç²å¾—ã€‚ï¼ˆåˆè¨ˆ ${gameState.player.lore}ï¼‰`);
    checkCpuStyleWin();
    updateBattleUI();
    area.textContent = "ã‚­ãƒ£ãƒ©ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨è¡Œå‹•ã‚’é¸ã¹ã¾ã™ã€‚";
  };

  const btnChal = document.createElement("button");
  btnChal.className = "btn small";
  btnChal.textContent = "ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ˆãƒãƒˆãƒ«ï¼‰";
  btnChal.onclick = () => {
    if (!gameState.cpu.field.length) {
      addLog("ç›¸æ‰‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚­ãƒ£ãƒ©ãŒã„ã¾ã›ã‚“ã€‚");
      return;
    }
    const target = gameState.cpu.field[0]; // ç°¡æ˜“ï¼šå…ˆé ­
    card.rest = true;
    addLog(`ã‚ãªãŸã®ã€Œ${card.name}ã€ãŒCPUã®ã€Œ${target.name}ã€ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼`);
    target.hp -= card.atk;
    card.hp -= target.atk;
    if (target.hp <= 0) {
      addLog(`CPUã®ã€Œ${target.name}ã€ã¯é€€å ´ã—ãŸã€‚`);
      gameState.cpu.field.splice(0, 1);
    }
    if (card.hp <= 0) {
      addLog(`ã‚ãªãŸã®ã€Œ${card.name}ã€ã¯é€€å ´ã—ãŸã€‚`);
      gameState.player.field.splice(index, 1);
    }
    checkCpuStyleWin();
    updateBattleUI();
    area.textContent = "ã‚­ãƒ£ãƒ©ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨è¡Œå‹•ã‚’é¸ã¹ã¾ã™ã€‚";
  };

  area.appendChild(btnSeek);
  area.appendChild(btnChal);
}

/* ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç”¨ è¡Œå‹•é¸æŠãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆç°¡æ˜“ï¼‰ */
function openOnlineActionPopup(zone, index) {
  if (!onlineBattle || !isMyTurnOnline()) return;
  const me = onlineBattle[myOnlineSide];
  const card = me.field[index];
  if (!card) return;

  const area = document.getElementById("actionArea");
  if (!area) return;

  area.innerHTML = "";
  const title = document.createElement("div");
  title.textContent = `ã€Œ${card.name}ã€ã®è¡Œå‹•ã‚’é¸æŠï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼‰ï¼š`;
  area.appendChild(title);

  const btnSeek = document.createElement("button");
  btnSeek.className = "btn small";
  btnSeek.textContent = "ã‚·ãƒ¼ã‚¯";
  btnSeek.onclick = () => {
    onlineSeek(myOnlineSide, index);
    area.textContent = "ã‚­ãƒ£ãƒ©ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨è¡Œå‹•ã‚’é¸ã¹ã¾ã™ã€‚ï¼ˆãƒ«ãƒ¼ãƒ æˆ¦ã§ã¯ç°¡æ˜“æ“ä½œï¼‰";
  };

  const btnChal = document.createElement("button");
  btnChal.className = "btn small";
  btnChal.textContent = "ãƒãƒ£ãƒ¬ãƒ³ã‚¸";
  btnChal.onclick = () => {
    onlineChallenge(myOnlineSide, index);
    area.textContent = "ã‚­ãƒ£ãƒ©ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨è¡Œå‹•ã‚’é¸ã¹ã¾ã™ã€‚ï¼ˆãƒ«ãƒ¼ãƒ æˆ¦ã§ã¯ç°¡æ˜“æ“ä½œï¼‰";
  };

  area.appendChild(btnSeek);
  area.appendChild(btnChal);
}

/* ãƒãƒˆãƒ«çµ‚äº† â†’ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸ */
function endBattleToMenu() {
  gameState = null;
  onlineBattle = null;
  battleMode = "cpu";
  showScreen("menu");
}

/* ========== ã‚·ãƒ§ãƒƒãƒ— / ãƒ‘ãƒƒã‚¯ ========== */

function showShop() {
  updateStoneDisplays();
  showScreen("shop");
}

function debugAddStones() {
  stones += 100;
  saveStones();
}

function showPack() {
  updateStoneDisplays();
  const res = document.getElementById("packResult");
  if (res) res.innerHTML = "";
  showScreen("pack");
}

function openPack() {
  if (stones < 5) {
    alert("ãƒ‰ãƒªãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }
  stones -= 5;
  saveStones();

  const res = document.getElementById("packResult");
  if (!res) return;
  res.innerHTML = "";

  const drawn = [];
  for (let i = 0; i < 5; i++) {
    const base = cards[Math.floor(Math.random() * cards.length)];
    const isEnchanted = Math.random() < ENCHANTED_RATE;
    const inst = makeCardInstance(base, isEnchanted);
    drawn.push(inst);

    if (isEnchanted) {
      enchantedCollection[base.id] = (enchantedCollection[base.id] || 0) + 1;
    } else {
      collection[base.id] = (collection[base.id] || 0) + 1;
    }
  }
  saveCollection();
  saveEnchantedCollection();

  drawn.forEach(card => {
    const box = document.createElement("div");
    box.className = "card-box " + card.color;
    const name = document.createElement("div");
    name.className = "card-name";
    name.textContent = card.name + (card.enchanted ? "ã€Eã€‘" : "");
    const stats = document.createElement("div");
    stats.className = "card-stats";
    stats.textContent =
      `ç¨®é¡:${card.type} ã‚³ã‚¹ãƒˆ:${card.cost} ATK:${card.atk} HP:${card.hp} ãƒ­ã‚¢:${card.lore}`;
    box.onclick = () => showCardDetail(card);
    box.appendChild(name);
    box.appendChild(stats);
    res.appendChild(box);
  });
}

/* ========== ãƒ‡ãƒƒã‚­ç·¨é›† ========== */

let deckEditCounts = {};

function openDeckBuilder() {
  currentDeckIndex = 0;
  loadDeckToEditor(0);
  showScreen("deck");
}

function loadDeckToEditor(idx) {
  currentDeckIndex = idx;
  document.getElementById("currentDeckLabel").textContent = (idx + 1);

  deckEditCounts = {};
  const deck = savedDecks[idx];
  if (Array.isArray(deck)) {
    deck.forEach(id => {
      deckEditCounts[id] = (deckEditCounts[id] || 0) + 1;
    });
  }
  renderDeckEditor();
}

function switchDeck(idx) {
  loadDeckToEditor(idx);
}

function renderDeckEditor() {
  const listEl = document.getElementById("deckCardList");
  if (!listEl) return;
  listEl.innerHTML = "";

  let total = 0;
  Object.values(deckEditCounts).forEach(c => total += c);

  const totalInfo = document.createElement("div");
  totalInfo.style.marginBottom = "6px";
  totalInfo.textContent = `ç¾åœ¨ã®æšæ•°ï¼š${total}æš`;
  listEl.appendChild(totalInfo);

  cards.forEach(card => {
    const count = deckEditCounts[card.id] || 0;

    const box = document.createElement("div");
    box.className = "card-box " + card.color;

    const name = document.createElement("div");
    name.className = "card-name";
    name.textContent = card.name;

    const stats = document.createElement("div");
    stats.className = "card-stats";
    stats.textContent =
      `ã‚³ã‚¹ãƒˆ:${card.cost} ATK:${card.atk} HP:${card.hp} ãƒ­ã‚¢:${card.lore}ï¼ˆæ‰€æŒ:${collection[card.id] || 0} / E:${enchantedCollection[card.id] || 0}ï¼‰`;

    const ctr = document.createElement("div");
    const minus = document.createElement("button");
    minus.className = "btn small";
    minus.textContent = "-";
    minus.onclick = () => {
      if (deckEditCounts[card.id] > 0) {
        deckEditCounts[card.id]--;
        if (deckEditCounts[card.id] <= 0) delete deckEditCounts[card.id];
        renderDeckEditor();
      }
    };
    const plus = document.createElement("button");
    plus.className = "btn small";
    plus.textContent = "+";
    plus.onclick = () => {
      const owned = (collection[card.id] || 0) + (enchantedCollection[card.id] || 0);
      if (owned === 0) {
        alert("ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’1æšã‚‚æ‰€æŒã—ã¦ã„ã¾ã›ã‚“ã€‚ãƒ‘ãƒƒã‚¯ã‹ã‚‰å¼•ã„ã¦ã­ã€‚");
        return;
      }
      const current = deckEditCounts[card.id] || 0;
      if (card.id >= 0 && card.id <= 5) {
        // åŸºæœ¬6ç¨®ã¯ç„¡åˆ¶é™
      } else if (current >= 4) {
        alert("åŒåã‚«ãƒ¼ãƒ‰ã¯4æšã¾ã§ã§ã™ã€‚");
        return;
      }
      if (current >= owned) {
        alert("æ‰€æŒæšæ•°ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚");
        return;
      }
      deckEditCounts[card.id] = current + 1;
      renderDeckEditor();
    };
    const cText = document.createElement("span");
    cText.style.marginLeft = "6px";
    cText.textContent = `ãƒ‡ãƒƒã‚­å†…: ${count}æš`;

    ctr.appendChild(minus);
    ctr.appendChild(plus);
    ctr.appendChild(cText);

    box.appendChild(name);
    box.appendChild(stats);
    box.appendChild(ctr);
    listEl.appendChild(box);
  });
}

function saveDeck() {
  let total = 0;
  const arr = [];
  Object.keys(deckEditCounts).forEach(idStr => {
    const id = Number(idStr);
    const c = deckEditCounts[idStr];
    total += c;
    for (let i = 0; i < c; i++) arr.push(id);
  });
  if (total < 60) {
    alert("ãƒ‡ãƒƒã‚­ã¯60æšä»¥ä¸Šã«ã—ã¦ãã ã•ã„ã€‚ï¼ˆä»Šã¯ " + total + " æšï¼‰");
    return;
  }
  savedDecks[currentDeckIndex] = arr;
  savePlayerDecks();
  alert("ãƒ‡ãƒƒã‚­ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
  updatePlayerDeckButtons();
}

function updatePlayerDeckButtons() {
  const labels = [
    {id:"btnDeck1", idx:0},
    {id:"btnDeck2", idx:1},
    {id:"btnDeck3", idx:2}
  ];
  labels.forEach(info => {
    const btn = document.getElementById(info.id);
    if (!btn) return;
    const deck = savedDecks[info.idx];
    if (Array.isArray(deck) && deck.length >= 40) {
      btn.textContent = `ãƒ‡ãƒƒã‚­${info.idx+1}ï¼ˆ${deck.length}æšï¼‰`;
    } else {
      btn.textContent = `ãƒ‡ãƒƒã‚­${info.idx+1}ï¼ˆæœªä¿å­˜ï¼‰`;
    }
  });
}

/* ========== ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º ========== */

function openCollection() {
  renderCollection();
  showScreen("collection");
}

function renderCollection() {
  const list = document.getElementById("collectionList");
  if (!list) return;
  list.innerHTML = "";

  cards.forEach(card => {
    const normal = collection[card.id] || 0;
    const e = enchantedCollection[card.id] || 0;
    if (normal === 0 && e === 0) return;

    const box = document.createElement("div");
    box.className = "card-box " + card.color;
    const name = document.createElement("div");
    name.className = "card-name";
    name.textContent = card.name;
    const stats = document.createElement("div");
    stats.className = "card-stats";
    stats.textContent =
      `ã‚³ã‚¹ãƒˆ:${card.cost} ATK:${card.atk} HP:${card.hp} ãƒ­ã‚¢:${card.lore} ï¼ é€šå¸¸:${normal}æš / E:${e}æš`;
    box.onclick = () => showCardDetail(card);
    box.appendChild(name);
    box.appendChild(stats);
    list.appendChild(box);
  });
}

/* ========== ã‚«ãƒ¼ãƒ‰è©³ç´°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ========== */

function showCardDetail(card) {
  const ov = document.getElementById("cardDetailOverlay");
  const inner = document.getElementById("cardDetailContent");
  if (!ov || !inner) return;

  inner.innerHTML = "";
  const title = document.createElement("div");
  title.style.fontWeight = "bold";
  title.style.marginBottom = "4px";
  title.textContent = card.name + (card.enchanted ? "ã€Eã€‘" : "");
  const body = document.createElement("div");
  body.innerHTML =
    `è‰²:${card.color}<br>` +
    `ç¨®é¡:${card.type}<br>` +
    `ã‚³ã‚¹ãƒˆ:${card.cost}<br>` +
    `ATK:${card.atk} / HP:${card.hp} / ãƒ­ã‚¢:${card.lore}<br>` +
    (card.effect ? `åŠ¹æœ:${card.effect}` : "åŠ¹æœ:ï¼ˆãªã—ï¼‰");
  inner.appendChild(title);
  inner.appendChild(body);

  ov.style.display = "block";
}

function closeCardDetail() {
  const ov = document.getElementById("cardDetailOverlay");
  if (ov) ov.style.display = "none";
}

/* ========== åˆæœŸåŒ– ========== */

window.onload = () => {
  loadData();
  initFirebase();
  setCpuStrength("normal");
  updatePlayerDeckButtons();
};
</script>

</body>
</html>

