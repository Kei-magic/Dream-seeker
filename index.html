<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Dream-seeker TCG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #181818;
      color: #f5f5f5;
    }
    h1, h2 { text-align: center; margin: 12px 0; }

    .screen {
      display: none;
      padding: 10px;
      max-width: 520px;
      margin: 0 auto;
    }
    .screen.active { display: block; }

    .btn {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      background: #444;
      color: #f5f5f5;
    }
    .btn.primary { background: #2ecc71; color: #000; }
    .btn.danger { background: #e74c3c; }
    .btn.small {
      width: auto;
      padding: 4px 8px;
      font-size: 12px;
      margin: 2px 4px 0 0;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 8px;
    }

    .card-box {
      border: 1px solid #555;
      border-radius: 8px;
      padding: 6px;
      margin: 4px 0;
      font-size: 12px;
      background: #202020;
    }
    .card-name { font-weight: bold; }
    .card-stats { font-size: 11px; opacity: 0.9; margin-top: 2px; }

    .red { border-color: #e74c3c; }
    .purple { border-color: #9b59b6; }
    .blue { border-color: #3498db; }
    .yellow { border-color: #f1c40f; }
    .white { border-color: #ecf0f1; }
    .green { border-color: #2ecc71; }

    .log {
      background: #111;
      border-radius: 8px;
      padding: 6px;
      font-size: 11px;
      height: 120px;
      overflow-y: auto;
      border: 1px solid #333;
      margin-top: 6px;
    }

    .section-title {
      font-size: 13px;
      margin: 10px 0 4px;
      font-weight: bold;
    }

    .stone-bar {
      font-size: 13px;
      padding: 4px 6px;
      border-radius: 8px;
      background: #222;
      display: inline-block;
      margin-bottom: 8px;
    }

    .row { display: flex; gap: 6px; }
    .row > .btn { flex: 1; }

    .toggle-selected {
      background: #f39c12 !important;
      color: #000 !important;
    }
  </style>
</head>
<body>

<!-- ===== ãƒ›ãƒ¼ãƒ  ===== -->
<div id="menuScreen" class="screen active">
  <h1>Dream-seeker TCG</h1>
  <div class="stone-bar">
    ğŸ’ ãƒ‰ãƒªãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³: <span id="stoneCount">0</span>
  </div>
  <button class="btn primary" onclick="openCpuConfig()">ãƒãƒˆãƒ«</button>
  <button class="btn" onclick="showShop()">ã‚·ãƒ§ãƒƒãƒ—</button>
  <button class="btn" onclick="showPack()">ãƒ‘ãƒƒã‚¯ï¼ˆã‚¬ãƒãƒ£ï¼‰</button>
  <button class="btn" onclick="openDeckBuilder()">ãƒ‡ãƒƒã‚­ç·¨é›†</button>
  <button class="btn" onclick="openCollection()">ã‚«ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«</button>
</div>

<!-- ===== CPUè¨­å®š ===== -->
<div id="cpuScreen" class="screen">
  <h2>CPUè¨­å®š</h2>

  <div class="section-title">CPUã®å¼·ã•</div>
  <div class="row">
    <button id="btnCpuNormal" class="btn" onclick="setCpuStrength('normal')">æ™®é€šï¼ˆSRã¾ã§ï¼‰</button>
    <button id="btnCpuStrong" class="btn" onclick="setCpuStrength('strong')">å¼·ã„ï¼ˆLä½¿ç”¨ï¼‰</button>
  </div>

  <div class="section-title">CPUãƒ‡ãƒƒã‚­è‰²</div>
  <div class="row">
    <button id="cpuRed"    class="btn" onclick="setCpuColor('red')">èµ¤</button>
    <button id="cpuPurple" class="btn" onclick="setCpuColor('purple')">ç´«</button>
  </div>
  <div class="row">
    <button id="cpuBlue"   class="btn" onclick="setCpuColor('blue')">é’</button>
    <button id="cpuYellow" class="btn" onclick="setCpuColor('yellow')">é»„</button>
  </div>
  <div class="row">
    <button id="cpuWhite"  class="btn" onclick="setCpuColor('white')">ç™½</button>
    <button id="cpuGreen"  class="btn" onclick="setCpuColor('green')">ç·‘</button>
  </div>

  <div class="section-title">è‡ªåˆ†ã®ä½¿ç”¨ãƒ‡ãƒƒã‚­</div>
  <button id="btnPlayerDefault" class="btn" onclick="selectPlayerDeck('default')">
    ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèµ¤ãƒ‡ãƒƒã‚­
  </button>
  <button id="btnPlayerCustom" class="btn" onclick="selectPlayerDeck('custom')">
    ãƒ‡ãƒƒã‚­ç·¨é›†ã§ä¿å­˜ã—ãŸãƒ‡ãƒƒã‚­ï¼ˆãªã—ï¼‰
  </button>

  <button class="btn primary" onclick="startBattle()">ãƒãƒˆãƒ«é–‹å§‹</button>
  <button class="btn danger" onclick="showScreen('menu')">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
</div>

<!-- ===== ãƒãƒˆãƒ« ===== -->
<div id="battleScreen" class="screen">
  <h2>ãƒãƒˆãƒ«</h2>

  <div class="topbar">
    <div>
      è‡ªåˆ† ãƒ­ã‚¢:<span id="pLore">0</span> /
      ã‚¤ãƒ³ã‚¯:<span id="pInkTotal">0</span>ï¼ˆæ®‹ã‚Š:<span id="pInkAvail">0</span>ï¼‰ /
      å±±æœ­:<span id="pDeck">0</span>
    </div>
  </div>
  <div class="topbar">
    <div>
      CPU ãƒ­ã‚¢:<span id="cLore">0</span> /
      ã‚¤ãƒ³ã‚¯:<span id="cInkTotal">0</span>ï¼ˆæ®‹ã‚Š:<span id="cInkAvail">0</span>ï¼‰ /
      å±±æœ­:<span id="cDeck">0</span>
    </div>
  </div>

  <div class="section-title">CPUã®å ´</div>
  <div id="cpuField"></div>

  <div class="section-title">è‡ªåˆ†ã®å ´</div>
  <div id="playerField"></div>

  <div class="section-title">è‡ªåˆ†ã®æ‰‹æœ­</div>
  <div id="playerHand"></div>

  <div class="section-title">é¸æŠä¸­ã®ã‚­ãƒ£ãƒ©</div>
  <div id="actionArea"></div>

  <div class="row" style="margin-top:8px;">
    <button id="btnDraw" class="btn" onclick="playerDraw()">ãƒ‰ãƒ­ãƒ¼ï¼ˆ1ã‚¿ãƒ¼ãƒ³1å›ï¼‰</button>
    <button class="btn" onclick="endTurn()">ã‚¿ãƒ¼ãƒ³çµ‚äº†</button>
    <button class="btn danger" onclick="showScreen('menu')">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button>
  </div>

  <div class="section-title">ãƒ­ã‚°</div>
  <div id="log" class="log"></div>
</div>

<!-- ===== ã‚·ãƒ§ãƒƒãƒ— ===== -->
<div id="shopScreen" class="screen">
  <h2>ã‚·ãƒ§ãƒƒãƒ—</h2>
  <p>â€» ä»Šã¯ãƒ†ã‚¹ãƒˆç”¨ã€‚çŸ³ã‚’å¢—ã‚„ã—æ”¾é¡Œã«ã—ã¦ã‚ã‚Šã¾ã™ã€‚</p>
  <p>æ‰€æŒãƒ‰ãƒªãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³: <span id="shopStoneCount">0</span></p>
  <button class="btn" onclick="debugAddStones()">çŸ³ã‚’100å€‹å¢—ã‚„ã™ï¼ˆãƒ†ã‚¹ãƒˆï¼‰</button>
  <button class="btn danger" onclick="showScreen('menu')">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
</div>

<!-- ===== ãƒ‘ãƒƒã‚¯ ===== -->
<div id="packScreen" class="screen">
  <h2>ãƒ‘ãƒƒã‚¯ï¼ˆã‚¬ãƒãƒ£ï¼‰</h2>
  <p>ãƒ‰ãƒªãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³5å€‹ã§1ãƒ‘ãƒƒã‚¯ï¼ˆ5æšå…¥ã‚Šï¼‰</p>
  <p>æ‰€æŒãƒ‰ãƒªãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³: <span id="packStoneCount">0</span></p>
  <button class="btn primary" onclick="openPack()">ãƒ‘ãƒƒã‚¯ã‚’é–‹ã‘ã‚‹</button>
  <div class="section-title">ä»Šå›ã®çµæœ</div>
  <div id="packResult"></div>
  <button class="btn danger" onclick="showScreen('menu')">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
</div>

<!-- ===== ãƒ‡ãƒƒã‚­ç·¨é›† ===== -->
<div id="deckScreen" class="screen">
  <h2>ãƒ‡ãƒƒã‚­ç·¨é›†</h2>
  <p style="font-size:12px; opacity:0.8;">
    æ‰€æŒã‚«ãƒ¼ãƒ‰ã‹ã‚‰ãƒ‡ãƒƒã‚­ã«å…¥ã‚Œã‚‹æšæ•°ã‚’æ±ºã‚ã¦ãã ã•ã„ã€‚ä¿å­˜ã—ãŸãƒ‡ãƒƒã‚­ã¯ãƒãƒˆãƒ«ã§ã€Œè‡ªåˆ†ã®ä½¿ç”¨ãƒ‡ãƒƒã‚­ã€ã§é¸ã¹ã¾ã™ã€‚
  </p>
  <div id="deckCardList"></div>
  <button class="btn primary" onclick="saveDeck()">ã“ã®å†…å®¹ã§ãƒ‡ãƒƒã‚­ã‚’ä¿å­˜</button>
  <button class="btn danger" onclick="showScreen('menu')">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
</div>

<!-- ===== ã‚«ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ« ===== -->
<div id="collectionScreen" class="screen">
  <h2>ã‚«ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«</h2>
  <div id="collectionList"></div>
  <button class="btn danger" onclick="showScreen('menu')">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
</div>

<script>
/* ========== ç”»é¢åˆ‡ã‚Šæ›¿ãˆ ========== */
function showScreen(name) {
  const ids = ["menuScreen","cpuScreen","battleScreen","shopScreen","packScreen","deckScreen","collectionScreen"];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.remove("active");
  });
  const map = {
    menu: "menuScreen",
    cpu: "cpuScreen",
    battle: "battleScreen",
    shop: "shopScreen",
    pack: "packScreen",
    deck: "deckScreen",
    collection: "collectionScreen"
  };
  document.getElementById(map[name]).classList.add("active");
}

/* ========== ã‚«ãƒ¼ãƒ‰å®šç¾© ========== */
const cards = [
  {id:0, name:"ã‚«ãƒ¼",   color:"red",    type:"character", cost:1, atk:1, hp:3, lore:1, rarity:"N", inkable:true},
  {id:1, name:"ãƒ«ãƒ‘ãƒ—", color:"purple", type:"character", cost:1, atk:1, hp:3, lore:1, rarity:"N", inkable:true},
  {id:2, name:"ãƒ«ãƒ–ãƒ–", color:"blue",   type:"character", cost:1, atk:1, hp:3, lore:1, rarity:"N", inkable:true},
  {id:3, name:"ãƒ­ã‚¤ã‚¨", color:"yellow", type:"character", cost:1, atk:1, hp:3, lore:1, rarity:"N", inkable:true},
  {id:4, name:"ãƒ­ãƒ¼ã‚·", color:"white",  type:"character", cost:1, atk:1, hp:3, lore:1, rarity:"N", inkable:true},
  {id:5, name:"ãƒ‰ãƒªãƒŸ", color:"green",  type:"character", cost:1, atk:1, hp:3, lore:1, rarity:"N", inkable:true},
  // SR / L
  {id:6, name:"çµ‚ç„‰ã®å¤§ç«", color:"red", type:"song", cost:7, atk:0, hp:0, lore:0, rarity:"SR", inkable:false},
  {id:7, name:"è¦šé†’ã‚¨ãƒ«ã‚µ", color:"purple", type:"character", cost:8, atk:4, hp:6, lore:2, rarity:"L", inkable:false},
  {id:8, name:"ä¼èª¬ã®å‹‡è€…ã‚¤ãƒ•ãƒªãƒ¼ãƒˆ", color:"red", type:"character", cost:7, atk:5, hp:5, lore:2, rarity:"L", inkable:false}
];

function makeCardInstance(base) {
  const c = Object.assign({}, base);
  c.hp = base.hp;
  c.maxHp = base.hp;
  c.rest = false;        // è¡Œå‹•æ¸ˆã¿ãƒ•ãƒ©ã‚°
  c.summonTurn = -1;     // å¬å–šã•ã‚ŒãŸã‚¿ãƒ¼ãƒ³ç•ªå·
  return c;
}

/* ========== ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ ========== */
let stones = 0;
let collection = {};
let savedDeck = [];

function loadData() {
  const s = localStorage.getItem("ds_stones");
  stones = s ? parseInt(s,10) : 0;
  const c = localStorage.getItem("ds_collection");
  collection = c ? JSON.parse(c) : {};
  const d = localStorage.getItem("ds_playerDeck");
  savedDeck = d ? JSON.parse(d) : [];
  updateStoneDisplays();
}
function saveStones() {
  localStorage.setItem("ds_stones", String(stones));
  updateStoneDisplays();
}
function saveCollection() {
  localStorage.setItem("ds_collection", JSON.stringify(collection));
}
function savePlayerDeck() {
  localStorage.setItem("ds_playerDeck", JSON.stringify(savedDeck));
}
function updateStoneDisplays() {
  const v1 = document.getElementById("stoneCount");
  const v2 = document.getElementById("shopStoneCount");
  const v3 = document.getElementById("packStoneCount");
  if (v1) v1.textContent = stones;
  if (v2) v2.textContent = stones;
  if (v3) v3.textContent = stones;
}

/* ========== ã‚·ãƒ§ãƒƒãƒ— ========== */
function showShop() {
  updateStoneDisplays();
  showScreen("shop");
}
function debugAddStones() {
  stones += 100;
  saveStones();
}

/* ========== ã‚¬ãƒãƒ£ ========== */
function showPack() {
  updateStoneDisplays();
  document.getElementById("packResult").innerHTML = "";
  showScreen("pack");
}

function openPack() {
  const COST = 5;
  if (stones < COST) {
    alert("ãƒ‰ãƒªãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³ãŒè¶³ã‚Šã¾ã›ã‚“ï¼ˆ5å€‹å¿…è¦ï¼‰");
    return;
  }
  stones -= COST;
  saveStones();

  const pulled = [];

  for (let i=0;i<5;i++) {
    const r = Math.random();
    let rarity;
    if (r < 0.78) rarity = "N";
    else if (r < 0.90) rarity = "R";
    else if (r < 0.98) rarity = "SR";
    else rarity = "L";

    let candidates = cards.filter(c => c.rarity === rarity);
    if (candidates.length === 0) {
      const order = ["L","SR","R","N"];
      for (const rr of order) {
        const list = cards.filter(c => c.rarity === rr);
        if (list.length) { candidates = list; break; }
      }
      if (!candidates.length) candidates = cards.slice();
    }

    const card = candidates[Math.floor(Math.random()*candidates.length)];
    pulled.push(card);
    if (!collection[card.id]) collection[card.id] = 0;
    collection[card.id]++;
  }
  saveCollection();

  const pr = document.getElementById("packResult");
  pr.innerHTML = pulled.map(c => `
    <div class="card-box ${c.color}">
      <div class="card-name">${c.name}</div>
      <div class="card-stats">è‰²:${c.color} / ãƒ¬ã‚¢:${c.rarity} / ç¨®é¡:${c.type}</div>
    </div>
  `).join("");
}

/* ========== ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ ========== */
function openCollection() {
  const list = document.getElementById("collectionList");
  let html = "";
  cards.forEach(c => {
    const cnt = collection[c.id] || 0;
    html += `
      <div class="card-box ${c.color}">
        <div class="card-name">${c.name}</div>
        <div class="card-stats">è‰²:${c.color} / ãƒ¬ã‚¢:${c.rarity} / ç¨®é¡:${c.type}</div>
        <div class="card-stats">æ‰€æŒæšæ•°: Ã—${cnt}</div>
      </div>`;
  });
  list.innerHTML = html;
  showScreen("collection");
}

/* ========== ãƒ‡ãƒƒã‚­ç·¨é›† ========== */
let deckCounts = {};

function openDeckBuilder() {
  deckCounts = {};
  savedDeck.forEach(id => {
    deckCounts[id] = (deckCounts[id] || 0) + 1;
  });

  const area = document.getElementById("deckCardList");
  let html = "";
  cards.forEach(c => {
    const have = collection[c.id] || 0;
    const inDeck = deckCounts[c.id] || 0;
    html += `
      <div class="card-box ${c.color}">
        <div class="card-name">${c.name}</div>
        <div class="card-stats">
          è‰²:${c.color} / ãƒ¬ã‚¢:${c.rarity} / ç¨®é¡:${c.type} / ã‚³ã‚¹ãƒˆ:${c.cost}
        </div>
        <div class="card-stats">
          æ‰€æŒ: Ã—${have} ï¼ ãƒ‡ãƒƒã‚­: Ã—<span id="deck-count-${c.id}">${inDeck}</span>
        </div>
        <button class="btn small" onclick="changeDeckCount(${c.id}, -1)">ï¼</button>
        <button class="btn small" onclick="changeDeckCount(${c.id}, +1)">ï¼‹</button>
      </div>`;
  });
  area.innerHTML = html;
  showScreen("deck");
}

function changeDeckCount(cardId, diff) {
  const have = collection[cardId] || 0;
  let cur = deckCounts[cardId] || 0;
  cur += diff;
  if (cur < 0) cur = 0;
  if (cur > have) cur = have;
  deckCounts[cardId] = cur;
  const span = document.getElementById("deck-count-"+cardId);
  if (span) span.textContent = cur;
}

function saveDeck() {
  const newDeck = [];
  Object.entries(deckCounts).forEach(([idStr,cnt]) => {
    const id = parseInt(idStr,10);
    for (let i=0;i<cnt;i++) newDeck.push(id);
  });
  savedDeck = newDeck;
  savePlayerDeck();
  alert("ãƒ‡ãƒƒã‚­ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
}

/* ========== CPUè¨­å®š ========== */
let cpuStrength = "normal";
let cpuColor = "red";
let playerDeckMode = "default";

function openCpuConfig() {
  updateCpuButtons();
  updatePlayerDeckButtons();
  showScreen("cpu");
}
function setCpuStrength(s) {
  cpuStrength = s;
  updateCpuButtons();
}
function setCpuColor(color) {
  cpuColor = color;
  updateCpuButtons();
}
function updateCpuButtons() {
  document.getElementById("btnCpuNormal").classList.toggle("toggle-selected", cpuStrength==="normal");
  document.getElementById("btnCpuStrong").classList.toggle("toggle-selected", cpuStrength==="strong");
  const colors = ["red","purple","blue","yellow","white","green"];
  colors.forEach(c => {
    const btnId = "cpu" + c.charAt(0).toUpperCase() + c.slice(1);
    const btn = document.getElementById(btnId);
    if (!btn) return;
    btn.classList.toggle("toggle-selected", cpuColor===c);
  });
}
function hasCustomDeck() {
  return savedDeck && savedDeck.length > 0;
}
function updatePlayerDeckButtons() {
  const btnDef = document.getElementById("btnPlayerDefault");
  const btnCus = document.getElementById("btnPlayerCustom");
  btnDef.classList.toggle("toggle-selected", playerDeckMode==="default");
  btnCus.classList.toggle("toggle-selected", playerDeckMode==="custom");
  if (!hasCustomDeck()) {
    btnCus.disabled = true;
    btnCus.textContent = "ãƒ‡ãƒƒã‚­ç·¨é›†ã§ä¿å­˜ã—ãŸãƒ‡ãƒƒã‚­ï¼ˆãªã—ï¼‰";
  } else {
    btnCus.disabled = false;
    btnCus.textContent = "ãƒ‡ãƒƒã‚­ç·¨é›†ã§ä¿å­˜ã—ãŸãƒ‡ãƒƒã‚­";
  }
}
function selectPlayerDeck(mode) {
  if (mode==="custom" && !hasCustomDeck()) {
    alert("ã¾ãšãƒ‡ãƒƒã‚­ç·¨é›†ã§ãƒ‡ãƒƒã‚­ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  playerDeckMode = mode;
  updatePlayerDeckButtons();
}

/* ========== ãƒãƒˆãƒ« ========== */
let battle = null;
let pendingChallenge = null; // {actorIndex}

function startBattle() {
  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒƒã‚­
  let playerDeckCards = [];
  if (playerDeckMode === "custom" && hasCustomDeck()) {
    savedDeck.forEach(id => {
      const base = cards.find(c => c.id===id);
      if (base) playerDeckCards.push(makeCardInstance(base));
    });
  }
  if (playerDeckCards.length === 0) {
    for (let i=0;i<24;i++) playerDeckCards.push(makeCardInstance(cards[0]));
    playerDeckCards.push(makeCardInstance(cards[6]));
    playerDeckCards.push(makeCardInstance(cards[8]));
  }

  // CPUãƒ‡ãƒƒã‚­
  let cpuDeckCards = [];
  const baseN = cards.filter(c => c.rarity==="N" && c.color===cpuColor);
  const baseSR = cards.filter(c => c.rarity==="SR" && (cpuStrength==="normal" || cpuStrength==="strong"));
  const baseL  = cards.filter(c => c.rarity==="L" && cpuStrength==="strong");
  for (let i=0;i<24;i++) {
    const src = baseN.length ? baseN : cards.filter(c=>c.rarity==="N");
    cpuDeckCards.push(makeCardInstance(src[i % src.length]));
  }
  if (baseSR.length) cpuDeckCards.push(makeCardInstance(baseSR[0]));
  if (baseL.length)  cpuDeckCards.push(makeCardInstance(baseL[0]));

  shuffle(playerDeckCards);
  shuffle(cpuDeckCards);

  battle = {
    turn: "player",
    turnCount: 0,
    player: {
      deck: playerDeckCards,
      hand: [],
      field: [],
      lore: 0,
      inkTotal: 0,
      inkAvail: 0,
      hasDrawn: false,
      hasInked: false
    },
    cpu: {
      deck: cpuDeckCards,
      hand: [],
      field: [],
      lore: 0,
      inkTotal: 0,
      inkAvail: 0,
      hasDrawn: false,
      hasInked: false
    }
  };

  for (let i=0;i<5;i++) {
    if (battle.player.deck.length) battle.player.hand.push(battle.player.deck.pop());
    if (battle.cpu.deck.length)    battle.cpu.hand.push(battle.cpu.deck.pop());
  }

  clearLog();
  addLog("ãƒãƒˆãƒ«é–‹å§‹ï¼");
  startPlayerTurn();
  showScreen("battle");
}

function shuffle(arr) {
  for (let i=arr.length-1;i>0;i--) {
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
}

function startPlayerTurn() {
  battle.turnCount++;
  const p = battle.player;
  p.inkAvail = p.inkTotal;
  p.hasDrawn = false;
  p.hasInked = false;
  // ã‚­ãƒ£ãƒ©ã‚’ãƒ¬ãƒ‡ã‚£ã«
  p.field.forEach(card => { card.rest = false; });
  pendingChallenge = null;
  document.getElementById("actionArea").innerHTML = "";
  addLog("è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã€‚ã¾ãšãƒ‰ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
  updateBattleView();
}

function startCpuTurn() {
  battle.turnCount++;
  const c = battle.cpu;
  c.inkAvail = c.inkTotal;
  c.hasDrawn = false;
  c.hasInked = false;
  c.field.forEach(card => { card.rest = false; });

  // ãƒ‰ãƒ­ãƒ¼1æš
  if (c.deck.length) {
    c.hand.push(c.deck.pop());
    c.hasDrawn = true;
    addLog("CPUã¯1æšãƒ‰ãƒ­ãƒ¼ã—ãŸã€‚");
  }

  // ã‚¤ãƒ³ã‚¯1æš
  for (let i=0;i<c.hand.length;i++) {
    const card = c.hand[i];
    if (card.inkable) {
      c.inkTotal++;
      c.inkAvail++;
      c.hand.splice(i,1);
      c.hasInked = true;
      addLog("CPUã¯1æšã‚¤ãƒ³ã‚¯ã«ç½®ã„ãŸã€‚");
      break;
    }
  }

  // å‡ºã›ã‚‹æœ€å¤§ã‚³ã‚¹ãƒˆã®ã‚«ãƒ¼ãƒ‰1æš
  let bestIndex = -1;
  let bestCost = -1;
  c.hand.forEach((card,idx) => {
    if (card.cost <= c.inkAvail && card.cost > bestCost) {
      bestCost = card.cost;
      bestIndex = idx;
    }
  });
  if (bestIndex >= 0) {
    const card = c.hand[bestIndex];
    c.inkAvail -= card.cost;
    card.summonTurn = battle.turnCount;
    c.hand.splice(bestIndex,1);
    c.field.push(card);
    addLog(`CPUã¯ã€Œ${card.name}ã€ã‚’å¬å–šã—ãŸã€‚`);
  }

  // ãƒ†ã‚¹ãƒˆç”¨ï¼šãƒ­ã‚¢+1
  if (c.field.length) {
    c.lore += 1;
    addLog("CPUã¯ãƒ­ã‚¢ã‚’1å¾—ãŸã€‚ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰");
  }

  updateBattleView();
  battle.turn = "player";
  startPlayerTurn();
}

/* --- æç”» --- */
function updateBattleView() {
  const p = battle.player;
  const c = battle.cpu;

  document.getElementById("pLore").textContent = p.lore;
  document.getElementById("pInkTotal").textContent = p.inkTotal;
  document.getElementById("pInkAvail").textContent = p.inkAvail;
  document.getElementById("pDeck").textContent = p.deck.length;

  document.getElementById("cLore").textContent = c.lore;
  document.getElementById("cInkTotal").textContent = c.inkTotal;
  document.getElementById("cInkAvail").textContent = c.inkAvail;
  document.getElementById("cDeck").textContent = c.deck.length;

  const pf = document.getElementById("playerField");
  pf.innerHTML = p.field.map((card,idx) => `
    <div class="card-box ${card.color}" onclick="onPlayerFieldClick(${idx})">
      <div class="card-name">${card.name}</div>
      <div class="card-stats">
        ATK:${card.atk} / HP:${card.hp}/${card.maxHp} / ãƒ­ã‚¢:${card.lore}
      </div>
    </div>
  `).join("");

  const cf = document.getElementById("cpuField");
  cf.innerHTML = c.field.map((card,idx) => `
    <div class="card-box ${card.color}" onclick="onCpuFieldClick(${idx})">
      <div class="card-name">${card.name}</div>
      <div class="card-stats">
        ATK:${card.atk} / HP:${card.hp}/${card.maxHp} / ãƒ­ã‚¢:${card.lore}
      </div>
    </div>
  `).join("");

  const ph = document.getElementById("playerHand");
  ph.innerHTML = p.hand.map((card,idx) => `
    <div class="card-box ${card.color}">
      <div class="card-name">${card.name} ã‚³ã‚¹ãƒˆ:${card.cost} [${card.rarity}]</div>
      <div class="card-stats">
        ç¨®é¡:${card.type} / ã‚¤ãƒ³ã‚¯åŒ–:${card.inkable ? "å¯èƒ½" : "ä¸å¯"}
      </div>
      <button class="btn small" onclick="inkFromHand(${idx})">ã‚¤ãƒ³ã‚¯ã«ã™ã‚‹</button>
      <button class="btn small" onclick="playFromHand(${idx})">å¬å–š</button>
    </div>
  `).join("");

  const btnDraw = document.getElementById("btnDraw");
  btnDraw.disabled = battle.turn !== "player" || p.hasDrawn;
}

/* --- ã‚­ãƒ£ãƒ©ã‚¯ãƒªãƒƒã‚¯ï¼ˆè‡ªåˆ†ï¼‰ --- */
function onPlayerFieldClick(index) {
  if (battle.turn !== "player") return;
  const p = battle.player;
  const card = p.field[index];
  if (!card) return;

  const area = document.getElementById("actionArea");

  let baseInfo = `
    <div class="card-box ${card.color}">
      <div class="card-name">${card.name}</div>
      <div class="card-stats">
        ATK:${card.atk} / HP:${card.hp}/${card.maxHp} / ãƒ­ã‚¢:${card.lore}
      </div>
    </div>
  `;

  if (card.type !== "character") {
    area.innerHTML = baseInfo + `<div class="card-stats">ã“ã®ã‚«ãƒ¼ãƒ‰ã¯ã‚­ãƒ£ãƒ©ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
    return;
  }

  if (!battle.player.hasDrawn) {
    area.innerHTML = baseInfo + `<div class="card-stats">ã¾ãšãƒ‰ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚</div>`;
    return;
  }

  if (card.summonTurn === battle.turnCount) {
    area.innerHTML = baseInfo + `<div class="card-stats">ã“ã®ã‚¿ãƒ¼ãƒ³ã«å‡ºãŸã‚­ãƒ£ãƒ©ã§ã™ï¼ˆå¬å–šé…”ã„ï¼‰ã€‚</div>`;
    return;
  }

  if (card.rest) {
    area.innerHTML = baseInfo + `<div class="card-stats">ã“ã®ã‚­ãƒ£ãƒ©ã¯ã™ã§ã«è¡Œå‹•ã—ã¾ã—ãŸã€‚</div>`;
    return;
  }

  pendingChallenge = null;
  area.innerHTML = baseInfo + `
    <button class="btn" onclick="doSeek(${index})">Seekï¼ˆãƒ­ã‚¢ã‚’å¾—ã‚‹ï¼‰</button>
    <button class="btn" onclick="prepareChallenge(${index})">ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ˆæ”»æ’ƒï¼‰</button>
  `;
}

/* --- ã‚­ãƒ£ãƒ©ã‚¯ãƒªãƒƒã‚¯ï¼ˆCPUï¼‰ --- */
function onCpuFieldClick(index) {
  const c = battle.cpu;
  const card = c.field[index];
  if (!card) return;
  const area = document.getElementById("actionArea");

  // ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®å¯¾è±¡ã¨ã—ã¦é¸ã¶å ´åˆ
  if (pendingChallenge !== null) {
    resolvePlayerChallenge(pendingChallenge, index);
    pendingChallenge = null;
    return;
  }

  // ãŸã ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
  area.innerHTML = `
    <div class="card-box ${card.color}">
      <div class="card-name">${card.name}</div>
      <div class="card-stats">
        ATK:${card.atk} / HP:${card.hp}/${card.maxHp} / ãƒ­ã‚¢:${card.lore}
      </div>
      <div class="card-stats">ï¼ˆç›¸æ‰‹ã®ã‚­ãƒ£ãƒ©ã§ã™ï¼‰</div>
    </div>
  `;
}

/* --- Seek & ãƒãƒ£ãƒ¬ãƒ³ã‚¸ --- */
function doSeek(index) {
  const p = battle.player;
  const card = p.field[index];
  if (!card || card.type!=="character") return;
  if (card.summonTurn === battle.turnCount) {
    alert("ã“ã®ã‚¿ãƒ¼ãƒ³ã«å‡ºãŸã‚­ãƒ£ãƒ©ã¯è¡Œå‹•ã§ãã¾ã›ã‚“ã€‚");
    return;
  }
  if (card.rest) {
    alert("ã“ã®ã‚­ãƒ£ãƒ©ã¯ã™ã§ã«è¡Œå‹•ã—ã¦ã„ã¾ã™ã€‚");
    return;
  }
  p.lore += card.lore || 0;
  card.rest = true;
  addLog(`è‡ªåˆ†ã®ã€Œ${card.name}ã€ãŒSeekã—ã¦ãƒ­ã‚¢ã‚’${card.lore}å¾—ãŸã€‚`);
  document.getElementById("actionArea").innerHTML = "";
  updateBattleView();
}

function prepareChallenge(index) {
  const p = battle.player;
  const card = p.field[index];
  if (!card || card.type!=="character") return;
  if (card.summonTurn === battle.turnCount) {
    alert("ã“ã®ã‚¿ãƒ¼ãƒ³ã«å‡ºãŸã‚­ãƒ£ãƒ©ã¯è¡Œå‹•ã§ãã¾ã›ã‚“ã€‚");
    return;
  }
  if (card.rest) {
    alert("ã“ã®ã‚­ãƒ£ãƒ©ã¯ã™ã§ã«è¡Œå‹•ã—ã¦ã„ã¾ã™ã€‚");
    return;
  }
  pendingChallenge = index;
  addLog(`ã€Œ${card.name}ã€ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸å¯¾è±¡ã«ã™ã‚‹ç›¸æ‰‹ã‚­ãƒ£ãƒ©ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚`);
}

function resolvePlayerChallenge(pIndex, cIndex) {
  const p = battle.player;
  const c = battle.cpu;
  const attacker = p.field[pIndex];
  const target   = c.field[cIndex];
  if (!attacker || !target) {
    addLog("æ”»æ’ƒå¯¾è±¡ãŒã„ã¾ã›ã‚“ã§ã—ãŸã€‚");
    return;
  }
  if (attacker.summonTurn === battle.turnCount || attacker.rest) {
    addLog("ã“ã®ã‚­ãƒ£ãƒ©ã¯è¡Œå‹•ã§ãã¾ã›ã‚“ã€‚");
    return;
  }
  // ãƒ€ãƒ¡ãƒ¼ã‚¸äº¤æ›
  target.hp   -= attacker.atk;
  attacker.hp -= target.atk;

  addLog(`ã€Œ${attacker.name}ã€ãŒã€Œ${target.name}ã€ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼`);
  addLog(`  ${target.name} ã«${attacker.atk}ãƒ€ãƒ¡ãƒ¼ã‚¸ / ${attacker.name} ã«${target.atk}ãƒ€ãƒ¡ãƒ¼ã‚¸`);

  if (target.hp <= 0) {
    c.field.splice(cIndex,1);
    addLog(`  ã€Œ${target.name}ã€ã¯é€€å ´ã—ãŸã€‚`);
  }
  if (attacker.hp <= 0) {
    p.field.splice(pIndex,1);
    addLog(`  ã€Œ${attacker.name}ã€ã¯é€€å ´ã—ãŸã€‚`);
  } else {
    attacker.rest = true;
  }

  document.getElementById("actionArea").innerHTML = "";
  updateBattleView();
}

/* --- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡Œå‹•ï¼ˆæ‰‹æœ­ï¼‰ --- */
function playerDraw() {
  const p = battle.player;
  if (battle.turn !== "player") return;
  if (p.hasDrawn) {
    alert("ã“ã®ã‚¿ãƒ¼ãƒ³ã¯æ—¢ã«ãƒ‰ãƒ­ãƒ¼ã—ã¦ã„ã¾ã™ã€‚");
    return;
  }
  if (!p.deck.length) {
    alert("å±±æœ­ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }
  p.hand.push(p.deck.pop());
  p.hasDrawn = true;
  addLog("è‡ªåˆ†ã¯1æšãƒ‰ãƒ­ãƒ¼ã—ãŸã€‚");
  updateBattleView();
}
function requireDrawFirst() {
  const p = battle.player;
  if (!p.hasDrawn) {
    alert("ã¾ãšãƒ‰ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
    return false;
  }
  return true;
}
function inkFromHand(index) {
  if (battle.turn !== "player") return;
  const p = battle.player;
  if (!requireDrawFirst()) return;
  if (p.hasInked) {
    alert("ã“ã®ã‚¿ãƒ¼ãƒ³ã¯æ—¢ã«ã‚¤ãƒ³ã‚¯ã‚’ç½®ã„ã¦ã„ã¾ã™ã€‚");
    return;
  }
  const card = p.hand[index];
  if (!card || !card.inkable) {
    alert("ã“ã®ã‚«ãƒ¼ãƒ‰ã¯ã‚¤ãƒ³ã‚¯ã«ã§ãã¾ã›ã‚“ã€‚");
    return;
  }
  p.hand.splice(index,1);
  p.inkTotal++;
  p.inkAvail++;
  p.hasInked = true;
  addLog(`è‡ªåˆ†ã¯ã€Œ${card.name}ã€ã‚’ã‚¤ãƒ³ã‚¯ã«ç½®ã„ãŸã€‚`);
  updateBattleView();
}
function playFromHand(index) {
  if (battle.turn !== "player") return;
  const p = battle.player;
  if (!requireDrawFirst()) return;
  const card = p.hand[index];
  if (!card) return;
  if (p.inkAvail < card.cost) {
    alert("ã‚¤ãƒ³ã‚¯ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }
  p.inkAvail -= card.cost;
  card.summonTurn = battle.turnCount;
  card.rest = false;
  p.hand.splice(index,1);
  p.field.push(card);
  addLog(`è‡ªåˆ†ã¯ã€Œ${card.name}ã€ã‚’å¬å–šã—ãŸã€‚`);
  updateBattleView();
}
function endTurn() {
  if (battle.turn !== "player") return;
  addLog("è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³çµ‚äº†ã€‚CPUã®ã‚¿ãƒ¼ãƒ³ã€‚");
  battle.turn = "cpu";
  updateBattleView();
  startCpuTurn();
}

/* --- ãƒ­ã‚° --- */
function clearLog() {
  const el = document.getElementById("log");
  if (el) el.innerHTML = "";
}
function addLog(text) {
  const el = document.getElementById("log");
  if (!el) return;
  const div = document.createElement("div");
  div.textContent = text;
  el.appendChild(div);
  el.scrollTop = el.scrollHeight;
}

/* ========== åˆæœŸåŒ– ========== */
window.onload = function() {
  loadData();
  showScreen("menu");
};
</script>
</body>
</html>
