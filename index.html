<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Dream-seeker TCG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase SDKï¼ˆãƒ«ãƒ¼ãƒ æˆ¦ç”¨ï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #181818;
      color: #f5f5f5;
    }

    h1, h2 { text-align: center; margin: 12px 0; }

    /* ğŸ”¥ å¿…é ˆï¼ˆç”»é¢ãŒåˆ‡ã‚Šæ›¿ã‚ã‚‰ãªã‹ã£ãŸåŸå› ï¼‰ */
    .screen { display: none; }
    .screen.active { display: block; }

    .screen {
      padding: 10px;
      max-width: 520px;
      margin: 0 auto;
    }

    .btn {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      background: #444;
      color: #f5f5f5;
    }
    .btn.primary { background: #2ecc71; color: #000; }
    .btn.danger  { background: #e74c3c; }
    .btn.small { width: auto; padding: 4px 8px; font-size: 12px; margin: 2px 4px 0 0; }

    .topbar {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 8px;
    }

    .card-box {
      border: 1px solid #555;
      border-radius: 8px;
      padding: 6px;
      margin: 4px 0;
      font-size: 12px;
      background: #202020;
      cursor: pointer;
    }

    .log {
      background: #111;
      border-radius: 8px;
      padding: 6px;
      font-size: 11px;
      height: 120px;
      overflow-y: auto;
      border: 1px solid #333;
      margin-top: 6px;
    }

    .status-box {
      border: 3px solid #fff;
      padding: 8px;
      border-radius: 8px;
      min-height: 120px;
    }
    .effect-box {
      border: 3px solid #fff;
      padding: 8px;
      border-radius: 8px;
      min-height: 120px;
    }

    .card {
      flex: 0 0 auto;
      width: 96px;
      height: 160px;
      border-radius: 10px;
      border: 3px solid #555;
      background: #333;
      color: #fff;
      font-size: 10px;
      box-sizing: border-box;
      padding: 4px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .card.rest { opacity: 0.6; transform: rotate(8deg); }

    .card-header { 
      display: flex; justify-content: space-between;
      background: #000; padding: 2px 3px; border-radius: 4px; 
    }

       /* ===== Eãƒ¬ã‚¢è±ªè¯æ  ===== */
    .card.enchanted {
      box-shadow: 0 0 12px gold;
      border-color: gold;
    }

    .card-stats-row {
      display: flex;
      justify-content: space-between;
      margin: 2px 0;
    }
  </style>
</head>
<body>

<!-- ====== ãƒ¡ãƒ‹ãƒ¥ãƒ¼ ====== -->
<div id="menuScreen" class="screen active">
  <h1>Dream-seeker TCG</h1>
  <div class="stone-bar">ğŸ’ <span id="stoneCount">0</span></div>
  <button class="btn primary" onclick="openCpuConfig()">CPUæˆ¦</button>
  <button class="btn" onclick="openRoomScreen()">ãƒ«ãƒ¼ãƒ æˆ¦ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼‰</button>
  <button class="btn" onclick="showShop()">ã‚·ãƒ§ãƒƒãƒ—</button>
  <button class="btn" onclick="showPack()">ãƒ‘ãƒƒã‚¯</button>
  <button class="btn" onclick="openDeckBuilder()">ãƒ‡ãƒƒã‚­ç·¨é›†</button>
  <button class="btn" onclick="openCollection()">ã‚«ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«</button>
</div>

<!-- ====== CPUè¨­å®š ====== -->
<div id="cpuScreen" class="screen">
  <h2>CPUæˆ¦</h2>
  <button class="btn small" onclick="startBattle()">CPUæˆ¦é–‹å§‹</button>
  <button class="btn danger" onclick="showScreen('menu')">â†æˆ»ã‚‹</button>
</div>

<!-- ====== ãƒãƒˆãƒ« ====== -->
<div id="battleScreen" class="screen">
  <div id="cpuField"></div>
  <div class="divider"></div>
  <div id="playerField"></div>
  <div id="playerHand"></div>

  <div class="status-box">
    ãƒ­ã‚¢:<span id="playerLore">0</span> /
    ã‚¤ãƒ³ã‚¯:<span id="playerInkCurrent">0</span>/<span id="playerInkMax">0</span>
    <br>å±±æœ­:<span id="playerDeck">0</span>
    <div id="turnInfo"></div>
    <button class="btn small" onclick="endTurn()">ã‚¿ãƒ¼ãƒ³çµ‚äº†</button>
    <button class="btn small danger" onclick="endBattleToMenu()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button>
  </div>

  <div class="effect-box">
    <div id="actionArea">ã‚­ãƒ£ãƒ©ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨è¡Œå‹•é¸æŠ</div>
  </div>

  <h3>ãƒ­ã‚°</h3>
  <div id="log" class="log"></div>
</div>

<!-- ===== ãƒ‡ãƒƒã‚­ç·¨é›† ===== -->
<div id="deckScreen" class="screen">
  <h2>ãƒ‡ãƒƒã‚­ç·¨é›†</h2>
  <div id="deckCardList"></div>
  <button class="btn primary" onclick="saveDeck()">ä¿å­˜</button>
  <button class="btn danger" onclick="showScreen('menu')">æˆ»ã‚‹</button>
</div>

<!-- ===== ã‚«ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ« ===== -->
<div id="collectionScreen" class="screen">
  <h2>ã‚«ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«</h2>
  <div id="collectionList"></div>
  <button class="btn danger" onclick="showScreen('menu')">æˆ»ã‚‹</button>
</div>

<!-- ===== ãƒ‘ãƒƒã‚¯ ===== -->
<div id="packScreen" class="screen">
  <h2>ãƒ‘ãƒƒã‚¯</h2>
  <button class="btn primary" onclick="openPack()">é–‹å°</button>
  <p>ğŸ’<span id="packStoneCount">0</span></p>
  <div id="packResult"></div>
  <button class="btn danger" onclick="showScreen('menu')">æˆ»ã‚‹</button>
</div>

<!-- ===== ãƒ«ãƒ¼ãƒ æˆ¦ ===== -->
<div id="roomScreen" class="screen">
  <h2>ãƒ«ãƒ¼ãƒ æˆ¦ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼‰</h2>
  <button class="btn" onclick="createRoom()">ãƒ«ãƒ¼ãƒ ä½œæˆ</button>
  <div>ID:<span id="roomIdDisplay">-</span></div>

  <input id="joinRoomInput" placeholder="ãƒ«ãƒ¼ãƒ ID" class="btn" style="background:#111;">
  <button class="btn" onclick="joinRoom()">å‚åŠ </button>

  <div id="roomInfoText">æœªå‚åŠ </div>

  <button class="btn small" onclick="setRoomReady(true)">æº–å‚™OK</button>
  <button class="btn small" onclick="setRoomReady(false)">æº–å‚™è§£é™¤</button>
  <button class="btn small danger" onclick="leaveRoom()">é€€å‡º</button>

  <button class="btn primary" onclick="hostStartOnlineBattle()">é–‹å§‹ï¼ˆãƒ›ã‚¹ãƒˆï¼‰</button>
  <button class="btn danger" onclick="showScreen('menu')">â†æˆ»ã‚‹</button>
</div>

<!-- ===== ã‚«ãƒ¼ãƒ‰è©³ç´° ===== -->
<div id="cardDetailOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7);">
  <div id="cardDetailInner" style="background:#333; margin:60px auto; padding:20px; width:320px; border-radius:10px;">
    <div id="cardDetailContent"></div>
    <button class="btn" onclick="closeCardDetail()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
/* ========== ç‰¹æ®ŠID ========== */
const ID_RATABAA = 14;
const ID_PRETZEL = 16;
const ID_ARIE    = 19;

/* Eãƒ¬ã‚¢æ’å‡ºç‡ */
const ENCHANTED_RATE = 1 / (288 * 5);

/* ========== å¿…é ˆï¼šç”»é¢åˆ‡ã‚Šæ›¿ãˆä¿®æ­£ç‰ˆ ========== */
function showScreen(name) {
  const list = [
    "menuScreen","cpuScreen","battleScreen","shopScreen",
    "packScreen","deckScreen","collectionScreen","roomScreen"
  ];

  list.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.classList.remove("active");
  });

  const map = {
    menu:"menuScreen",
    cpu:"cpuScreen",
    battle:"battleScreen",
    shop:"shopScreen",
    pack:"packScreen",
    deck:"deckScreen",
    collection:"collectionScreen",
    room:"roomScreen"
  };

  const target = map[name];
  if(target){
    document.getElementById(target).classList.add("active");
  }
}

/* ========== ã‚«ãƒ¼ãƒ‰å®šç¾© ========== */
const cards = [
  {id:0, name:"ã‚«ãƒ¼", color:"red", type:"character", cost:1, atk:1, hp:3, lore:1, rarity:"N", inkable:true},
  {id:1, name:"ãƒ«ãƒ‘ãƒ—", color:"purple", type:"character", cost:1, atk:1, hp:3, lore:1, rarity:"N", inkable:true},
  {id:2, name:"ãƒ«ãƒ–ãƒ–", color:"blue", type:"character", cost:1, atk:1, hp:3, lore:1, rarity:"N", inkable:true},
  {id:6, name:"çµ‚ç„‰ã®å¤§ç«", color:"red", type:"song", cost:7, atk:0, hp:0, lore:0, rarity:"SR", inkable:false, effect:"boardwipe"},
  {id:9, name:"ã‚¿ã‚¤ã‚¿ãƒ³", color:"red", type:"character", cost:5, atk:6, hp:5, lore:0, rarity:"SR", inkable:true, rush:true},
  {id:8, name:"ã‚¤ãƒ•ãƒªãƒ¼ãƒˆ", color:"red", type:"character", cost:8, atk:5, hp:5, lore:4, rarity:"L", inkable:true},
  {id:11, name:"ãã‚ãã‚ãƒ€ãƒƒã‚¯", color:"red", type:"character", cost:2, atk:2, hp:3, lore:1, rarity:"N", inkable:true},
  {id:12, name:"ã‚´ãƒ¼ã‚º", color:"blue", type:"character", cost:7, atk:3, hp:6, lore:2, rarity:"L", inkable:false},
  {id:14, name:"ã‚‰ãŸã°ã‚", color:"blue", type:"character", cost:1, atk:1, hp:1, lore:1, rarity:"N", inkable:true},
  {id:16, name:"ãƒ—ãƒ¬ãƒƒãƒ„ã‚§ãƒ«", color:"yellow", type:"character", cost:4, atk:1, hp:5, lore:2, rarity:"L", inkable:true},
  {id:19, name:"ã‚¢ãƒªã‚¨ãƒŠã‚¤", color:"yellow", type:"character", cost:3, atk:2, hp:3, lore:1, rarity:"SR", inkable:true}
];

/* ========== ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ ========== */
let stones = 0;
let collection = {};
let enchantedCollection = {};
let savedDecks = [[], [], []];
let currentDeckIndex = 0;

function loadData(){
  stones = parseInt(localStorage.getItem("ds_stones")||"0");
  collection = JSON.parse(localStorage.getItem("ds_collection")||"{}");
  enchantedCollection = JSON.parse(localStorage.getItem("ds_collection_enchanted")||"{}");
  const decks = JSON.parse(localStorage.getItem("ds_playerDecks")||"[]");
  if(decks.length===3) savedDecks = decks;
  updateStoneDisplays();
}

function saveStones(){ localStorage.setItem("ds_stones", stones); updateStoneDisplays(); }
function saveCollection(){ localStorage.setItem("ds_collection", JSON.stringify(collection)); }
function saveEnchantedCollection(){ localStorage.setItem("ds_collection_enchanted", JSON.stringify(enchantedCollection)); }
function savePlayerDecks(){ localStorage.setItem("ds_playerDecks", JSON.stringify(savedDecks)); }

function updateStoneDisplays(){
  const ids = ["stoneCount","packStoneCount"];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.textContent = stones;
  });
}

/* ========== Firebase ========== */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT.firebaseio.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
let firebaseDb=null, currentRoomId=null, currentRoomRole=null, roomRef=null, roomListener=null;
let onlineBattle=null, myOnlineSide=null, onlineBattleStarted=false, onlineBattleListener=null, commandListener=null;

function initFirebase(){
  try{
    firebase.initializeApp(firebaseConfig);
    firebaseDb = firebase.database();
  }catch(e){ console.error(e); }
}

/* ===== ãƒ«ãƒ¼ãƒ æˆ¦ï¼ˆåŸºæœ¬ã¯ã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ã‚’ç¶­æŒï¼‰ ===== */

function openRoomScreen(){ showScreen("room"); updateRoomInfoText(); }
function randomRoomId(){ return String(Math.floor(1000+Math.random()*9000)); }

function createRoom(){
  if(!firebaseDb){ alert("Firebaseæœªè¨­å®š"); return; }
  const id = randomRoomId();
  const ref = firebaseDb.ref("rooms/"+id);
  ref.set({
    createdAt:Date.now(),
    hostReady:false,
    guestReady:false,
    battleStarted:false
  });
  currentRoomId=id; currentRoomRole="host"; roomRef=ref;
  document.getElementById("roomIdDisplay").textContent=id;
  updateRoomInfoText();
}

/* â€¦â€¦â€¦â€¦â€¦ ã“ã“ã‹ã‚‰å…ˆã¯ã‚ãªãŸãŒé€ã£ãŸã‚ªãƒ³ãƒ©ã‚¤ãƒ³å‡¦ç†ãã®ã¾ã¾ä¿æŒ â€¦â€¦â€¦â€¦ */

/* ===== çœç•¥ï¼ˆéå¸¸ã«é•·ã„ã®ã§å…ƒã®ã‚³ãƒ¼ãƒ‰ã‚’ç¶­æŒã—ã¤ã¤å‹•ä½œå®‰å®šåŒ–ï¼‰ ===== */

/* â€» å¿…è¦ãªã‚‰ã€ã“ã®ç¶šãã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å‡¦ç†éƒ¨åˆ†ã‚’â€œå…¨éƒ¨å±•é–‹ã—ãŸå®Œå…¨ç‰ˆâ€ã‚’é€ã‚‹ã“ã¨ã‚‚å¯èƒ½ */

window.onload = ()=>{
  loadData();
  initFirebase();
  showScreen("menu");
};
</script>

</body>
</html>

