<!DOCTYPE html>
<html lang="ja">
<head>
 <meta charset="UTF-8" />
 <title>Dream-seeker TCG</title>
 <meta name="viewport" content="width=device-width, initial-scale=1.0" />
 <style>
   * { box-sizing: border-box; }

   body {
     margin: 0;
     font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
     background: #181818;
     color: #f5f5f5;
   }

   h1, h2 { text-align: center; margin: 12px 0; }

   .screen {
     display: none;
     padding: 10px;
     max-width: 520px;
     margin: 0 auto;
   }
   .screen.active { display: block; }

   .btn {
     width: 100%;
     padding: 10px;
     margin: 6px 0;
     border-radius: 8px;
     border: none;
     cursor: pointer;
     font-size: 14px;
     background: #444;
     color: #f5f5f5;
   }
   .btn.primary { background: #2ecc71; color: #000; }
   .btn.danger  { background: #e74c3c; }
   .btn.small {
     width: auto;
     padding: 4px 8px;
     font-size: 12px;
     margin: 2px 4px 0 0;
   }

   .topbar {
     display: flex;
     justify-content: space-between;
     font-size: 12px;
     margin-bottom: 8px;
   }

   .card-box {
     border: 1px solid #555;
     border-radius: 8px;
     padding: 6px;
     margin: 4px 0;
     font-size: 12px;
     background: #202020;
   }
   .card-name  { font-weight: bold; }
   .card-stats { font-size: 11px; opacity: 0.9; margin-top: 2px; }

   .red    { border-color: #e74c3c; }
   .purple { border-color: #9b59b6; }
   .blue   { border-color: #3498db; }
   .yellow { border-color: #f1c40f; }
   .white  { border-color: #ecf0f1; }
   .green  { border-color: #2ecc71; }

   .log {
     background: #111;
     border-radius: 8px;
     padding: 6px;
     font-size: 11px;
     height: 120px;
     overflow-y: auto;
     border: 1px solid #333;
     margin-top: 6px;
   }

   .section-title {
     font-size: 13px;
     margin: 10px 0 4px;
     font-weight: bold;
   }

   .stone-bar {
     font-size: 13px;
     padding: 4px 6px;
     border-radius: 8px;
     background: #222;
     display: inline-block;
     margin-bottom: 8px;
   }

   .row { display: flex; gap: 6px; }
   .row > .btn { flex: 1; }

   .toggle-selected {
     background: #f39c12 !important;
     color: #000 !important;
   }

   /* ===== ãƒãƒˆãƒ«ç”»é¢ç”¨ ===== */

   .battle-screen {
     padding: 16px;
   }

   .enemy-title {
     text-align: center;
     font-size: 20px;
     margin-bottom: 8px;
   }

   .enemy-status {
     display: flex;
     justify-content: space-around;
     margin-bottom: 8px;
     font-size: 13px;
   }

   /* CPUã®å ´ / è‡ªåˆ†ã®å ´ / æ‰‹æœ­ ã‚’æ¨ªä¸¦ã³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã«ã™ã‚‹ */
   #cpuField,
   #playerField,
   #playerHand {
     display: flex;
     align-items: flex-start;
     gap: 12px;
     overflow-x: auto;
     padding: 8px 0;
     min-height: 160px;
     -webkit-overflow-scrolling: touch;
   }

   .divider {
     border-top: 3px dashed #ffffff;
     margin: 12px 0;
   }

   .bottom-ui {
     display: flex;
     justify-content: space-between;
     gap: 16px;
     flex-wrap: wrap;
   }

   .status-box,
   .effect-box {
     width: 48%;
     min-height: 120px;
     border: 3px solid #ffffff;
     box-sizing: border-box;
     padding: 8px;
     font-size: 14px;
   }

   .status-box-title,
   .effect-box-title {
     font-weight: bold;
     margin-bottom: 4px;
   }

   .turn-info {
     margin-top: 4px;
     font-weight: bold;
   }

   .status-buttons {
     margin-top: 8px;
     display: flex;
     flex-wrap: wrap;
     gap: 4px;
   }

   .status-buttons button {
     font-size: 12px;
     padding: 4px 8px;
   }

   /* ã‚«ãƒ¼ãƒ‰è¦‹ãŸç›®ï¼ˆæ–°ã‚«ãƒ¼ãƒ‰å‹ï¼‰ */
   .card {
     flex: 0 0 auto;
     width: 96px;
     height: 160px;
     border-radius: 10px;
     border: 3px solid #555;
     background: #b30000;
     color: #ffffff;
     font-size: 10px;
     box-sizing: border-box;
     padding: 4px;
     display: flex;
     flex-direction: column;
     justify-content: flex-start;
     cursor: pointer;
     transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.1s ease;
   }

   .card:hover {
     transform: translateY(-2px);
     box-shadow: 0 0 8px rgba(255,255,255,0.3);
   }

   /* ãƒ¬ã‚¹ãƒˆä¸­ï¼ˆå‚¾ã‘ã‚‹ï¼‰ */
   .card.rest {
     opacity: 0.6;
     transform: rotate(8deg);
   }

   /* ã‚«ãƒ©ãƒ¼åˆ¥ */
   .card.red {
     border-color: #e74c3c;
     background: #8b1a1a;
   }
   .card.purple {
     border-color: #9b59b6;
     background: #4b2b63;
   }
   .card.blue {
     border-color: #3498db;
     background: #1f3f5f;
   }
   .card.yellow {
     border-color: #f1c40f;
     background: #866d07;
   }
   .card.white {
     border-color: #ecf0f1;
     background: #aaaaaa;
     color: #000;
   }
   .card.green {
     border-color: #2ecc71;
     background: #145437;
   }

   .card-header {
     display: flex;
     align-items: center;
     justify-content: space-between;
     background: #000000;
     border-radius: 4px;
     padding: 2px 3px;
     margin-bottom: 3px;
     font-weight: bold;
   }

   .card-cost {
     min-width: 16px;
     text-align: center;
   }

   .card-name-header {
     flex: 1;
     text-align: center;
     font-size: 9px;
   }

   .card-inkable {
     min-width: 16px;
     text-align: center;
   }

   .card-illustration {
     flex: 1;
     background: #ffffff;
     border-radius: 4px;
     margin-bottom: 3px;
   }

   .card-stats-row {
     display: flex;
     justify-content: space-between;
     font-size: 9px;
     padding: 0 2px;
     margin-bottom: 3px;
   }

   .card-footer {
     background: #000000;
     border-radius: 4px;
     padding: 2px 3px;
     font-size: 9px;
   }

   .card-footer-buttons {
     display: flex;
     gap: 2px;
     margin-top: 2px;
   }
 </style>
</head>
<body>

<!-- ===== ãƒ›ãƒ¼ãƒ  ===== -->
<div id="menuScreen" class="screen active">
 <h1>Dream-seeker TCG</h1>
 <div class="stone-bar">
   ğŸ’ ãƒ‰ãƒªãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³: <span id="stoneCount">0</span>
 </div>
 <button class="btn primary" onclick="openCpuConfig()">ãƒãƒˆãƒ«</button>
 <button class="btn" onclick="showShop()">ã‚·ãƒ§ãƒƒãƒ—</button>
 <button class="btn" onclick="showPack()">ãƒ‘ãƒƒã‚¯ï¼ˆã‚¬ãƒãƒ£ï¼‰</button>
 <button class="btn" onclick="openDeckBuilder()">ãƒ‡ãƒƒã‚­ç·¨é›†</button>
 <button class="btn" onclick="openCollection()">ã‚«ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«</button>
</div>

<!-- ===== CPUè¨­å®š ===== -->
<div id="cpuScreen" class="screen">
 <h2>CPUè¨­å®š</h2>

 <div class="section-title">CPUã®å¼·ã•</div>
 <div class="row">
   <button id="btnCpuNormal" class="btn" onclick="setCpuStrength('normal')">æ™®é€š</button>
   <button id="btnCpuStrong" class="btn" onclick="setCpuStrength('strong')">å¼·ã„ï¼ˆè¶…CPUï¼‰</button>
 </div>

 <div class="section-title">CPUãƒ‡ãƒƒã‚­è‰²</div>
 <div class="row">
   <button id="cpuRed"    class="btn" onclick="setCpuColor('red')">èµ¤</button>
   <button id="cpuPurple" class="btn" onclick="setCpuColor('purple')">ç´«</button>
 </div>
 <div class="row">
   <button id="cpuBlue"   class="btn" onclick="setCpuColor('blue')">é’</button>
   <button id="cpuYellow" class="btn" onclick="setCpuColor('yellow')">é»„</button>
 </div>
 <div class="row">
   <button id="cpuWhite"  class="btn" onclick="setCpuColor('white')">ç™½</button>
   <button id="cpuGreen"  class="btn" onclick="setCpuColor('green')">ç·‘</button>
 </div>

 <div class="section-title">è‡ªåˆ†ã®ä½¿ç”¨ãƒ‡ãƒƒã‚­</div>
 <button id="btnPlayerDefault" class="btn" onclick="selectPlayerDeck('default')">
   ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèµ¤ãƒ‡ãƒƒã‚­
 </button>
 <button id="btnDeck1" class="btn" onclick="selectPlayerDeck('deck1')">
   ãƒ‡ãƒƒã‚­1ï¼ˆæœªä¿å­˜ï¼‰
 </button>
 <button id="btnDeck2" class="btn" onclick="selectPlayerDeck('deck2')">
   ãƒ‡ãƒƒã‚­2ï¼ˆæœªä¿å­˜ï¼‰
 </button>
 <button id="btnDeck3" class="btn" onclick="selectPlayerDeck('deck3')">
   ãƒ‡ãƒƒã‚­3ï¼ˆæœªä¿å­˜ï¼‰
 </button>

 <button class="btn primary" onclick="startBattle()">ãƒãƒˆãƒ«é–‹å§‹</button>
 <button class="btn danger" onclick="showScreen('menu')">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
</div>

<!-- ===== ãƒãƒˆãƒ« ===== -->
<div id="battleScreen" class="screen">
 <div class="battle-screen">

   <!-- ç›¸æ‰‹ã‚¨ãƒªã‚¢ -->
   <div class="enemy-area">
     <div class="enemy-title">ç›¸æ‰‹</div>
     <div class="enemy-status">
       <span>æ‰‹æœ­ï¼š<span id="cpuHandCount">0</span>æš</span>
       <span>ãƒ­ã‚¢ï¼š<span id="cLore">0</span>å€‹</span>
       <span>æ®‹ã‚Šå±±æœ­ï¼š<span id="cDeck">0</span>æš</span>
     </div>
     <div id="cpuField"></div>
   </div>

   <div class="divider"></div>

   <!-- è‡ªåˆ†ã‚¨ãƒªã‚¢ -->
   <div class="player-area">

     <div id="playerField"></div>

     <div id="playerHand"></div>

     <div class="bottom-ui">
       <div class="status-box">
         <div class="status-box-title">è‡ªåˆ†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
         <div>ãƒ­ã‚¢ï¼š<span id="playerLore">0</span></div>
         <div>ã‚¤ãƒ³ã‚¯ï¼š<span id="playerInkCurrent">0</span> / <span id="playerInkMax">0</span></div>
         <div>æ®‹ã‚Šå±±æœ­ï¼š<span id="playerDeck">0</span></div>
         <div id="turnInfo" class="turn-info">è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³</div>

         <div class="status-buttons">
           <button class="btn small" onclick="playerDraw()">ãƒ‰ãƒ­ãƒ¼</button>
           <button class="btn small" onclick="endTurn()">ã‚¿ãƒ¼ãƒ³çµ‚äº†</button>
           <button class="btn small danger" onclick="endBattleToMenu()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
         </div>
       </div>

       <div class="effect-box">
         <div class="effect-box-title">è¡Œå‹• / æƒ…å ±</div>
         <div id="actionArea">ã‚­ãƒ£ãƒ©ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨è¡Œå‹•ã‚’é¸ã¹ã¾ã™ã€‚</div>
       </div>
     </div>

     <div class="section-title">ãƒ­ã‚°</div>
     <div id="log" class="log"></div>

   </div>
 </div>
</div>

<!-- ===== ã‚·ãƒ§ãƒƒãƒ— ===== -->
<div id="shopScreen" class="screen">
 <h2>ã‚·ãƒ§ãƒƒãƒ—</h2>
 <p>â€» ä»Šã¯ãƒ†ã‚¹ãƒˆç”¨ã€‚çŸ³ã‚’å¢—ã‚„ã—æ”¾é¡Œã«ã—ã¦ã‚ã‚Šã¾ã™ã€‚</p>
 <p>æ‰€æŒãƒ‰ãƒªãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³: <span id="shopStoneCount">0</span></p>
 <button class="btn" onclick="debugAddStones()">çŸ³ã‚’100å€‹å¢—ã‚„ã™ï¼ˆãƒ†ã‚¹ãƒˆï¼‰</button>
 <button class="btn danger" onclick="showScreen('menu')">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
</div>

<!-- ===== ãƒ‘ãƒƒã‚¯ ===== -->
<div id="packScreen" class="screen">
 <h2>ãƒ‘ãƒƒã‚¯ï¼ˆã‚¬ãƒãƒ£ï¼‰</h2>
 <p>ãƒ‰ãƒªãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³5å€‹ã§1ãƒ‘ãƒƒã‚¯ï¼ˆ5æšå…¥ã‚Šï¼‰</p>
 <p>æ‰€æŒãƒ‰ãƒªãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³: <span id="packStoneCount">0</span></p>
 <button class="btn primary" onclick="openPack()">ãƒ‘ãƒƒã‚¯ã‚’é–‹ã‘ã‚‹</button>
 <div class="section-title">ä»Šå›ã®çµæœ</div>
 <div id="packResult"></div>
 <button class="btn danger" onclick="showScreen('menu')">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
</div>

<!-- ===== ãƒ‡ãƒƒã‚­ç·¨é›† ===== -->
<div id="deckScreen" class="screen">
 <h2>ãƒ‡ãƒƒã‚­ç·¨é›†</h2>
 <p style="font-size:12px; opacity:0.8;">
   æ‰€æŒã‚«ãƒ¼ãƒ‰ã‹ã‚‰ãƒ‡ãƒƒã‚­ã«å…¥ã‚Œã‚‹æšæ•°ã‚’æ±ºã‚ã¦ãã ã•ã„ã€‚ä¿å­˜ã—ãŸãƒ‡ãƒƒã‚­ã¯ãƒãƒˆãƒ«ã§ã€Œè‡ªåˆ†ã®ä½¿ç”¨ãƒ‡ãƒƒã‚­ã€ã§é¸ã¹ã¾ã™ã€‚<br>
   â€» ãƒ‡ãƒƒã‚­ã¯2è‰²ã¾ã§ï¼åŒåã‚«ãƒ¼ãƒ‰ã¯4æšã¾ã§ï¼ˆåŸºæœ¬6ç¨®ã¯ä½•æšã§ã‚‚å¯ï¼‰ï¼æœ€çµ‚çš„ã«60æšä»¥ä¸Š
 </p>

 <div style="margin-bottom:8px;">
   <button class="btn small" onclick="switchDeck(0)">ãƒ‡ãƒƒã‚­1</button>
   <button class="btn small" onclick="switchDeck(1)">ãƒ‡ãƒƒã‚­2</button>
   <button class="btn small" onclick="switchDeck(2)">ãƒ‡ãƒƒã‚­3</button>
   <div style="font-size:12px; opacity:0.9; margin-top:4px;">
     ç¾åœ¨ç·¨é›†ã—ã¦ã„ã‚‹ã®ã¯ï¼šãƒ‡ãƒƒã‚­<span id="currentDeckLabel">1</span>
   </div>
 </div>

 <div id="deckCardList"></div>
 <button class="btn primary" onclick="saveDeck()">ã“ã®å†…å®¹ã§ãƒ‡ãƒƒã‚­ã‚’ä¿å­˜</button>
 <button class="btn danger" onclick="showScreen('menu')">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
</div>

<!-- ===== ã‚«ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ« ===== -->
<div id="collectionScreen" class="screen">
 <h2>ã‚«ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«</h2>
 <div id="collectionList"></div>
 <button class="btn danger" onclick="showScreen('menu')">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
</div>

<script>
/* ========== ã‚«ãƒ¼ãƒ‰IDå®šç¾©ï¼ˆç‰¹æ®Šå‡¦ç†ç”¨ï¼‰ ========== */
const ID_RATABAA   = 14;
const ID_LIN       = 13;
const ID_TITAN     = 9;
const ID_PRETZEL   = 16;

/* ========== ç”»é¢åˆ‡ã‚Šæ›¿ãˆ ========== */
function showScreen(name) {
 const ids = ["menuScreen","cpuScreen","battleScreen","shopScreen","packScreen","deckScreen","collectionScreen"];
 ids.forEach(id => {
   const el = document.getElementById(id);
   if (el) el.classList.remove("active");
 });
 const map = {
   menu: "menuScreen",
   cpu: "cpuScreen",
   battle: "battleScreen",
   shop: "shopScreen",
   pack: "packScreen",
   deck: "deckScreen",
   collection: "collectionScreen"
 };
 document.getElementById(map[name]).classList.add("active");
}

/* ========== ã‚«ãƒ¼ãƒ‰å®šç¾© ========== */
const cards = [
 // åŸºæœ¬6ç¨®
 {id:0, name:"ã‚«ãƒ¼",   color:"red",    type:"character", cost:1, atk:1, hp:3, lore:1, rarity:"N",  inkable:true},
 {id:1, name:"ãƒ«ãƒ‘ãƒ—", color:"purple", type:"character", cost:1, atk:1, hp:3, lore:1, rarity:"N",  inkable:true},
 {id:2, name:"ãƒ«ãƒ–ãƒ–", color:"blue",   type:"character", cost:1, atk:1, hp:3, lore:1, rarity:"N",  inkable:true},
 {id:3, name:"ãƒ­ã‚¤ã‚¨", color:"yellow", type:"character", cost:1, atk:1, hp:3, lore:1, rarity:"N",  inkable:true},
 {id:4, name:"ãƒ­ãƒ¼ã‚·", color:"white",  type:"character", cost:1, atk:1, hp:3, lore:1, rarity:"N",  inkable:true},
 {id:5, name:"ãƒ‰ãƒªãƒŸ", color:"green",  type:"character", cost:1, atk:1, hp:3, lore:1, rarity:"N",  inkable:true},
 // æ—¢å­˜SR/L
 {id:6, name:"çµ‚ç„‰ã®å¤§ç«",        color:"red",    type:"song",      cost:7, atk:0, hp:0, lore:0, rarity:"SR", inkable:false, effect:"boardwipe"},
 {id:7, name:"æ°·çµã®å¥³ç‹ã‚±ãƒ«ã‚µ",  color:"purple", type:"character", cost:8, atk:4, hp:6, lore:3, rarity:"L",  inkable:false, effect:"freeze2", evolveCost:6},
 {id:8, name:"ä¼èª¬ã®å‹‡è€…ã‚¤ãƒ•ãƒªãƒ¼ãƒˆ", color:"red", type:"character", cost:8, atk:5, hp:5, lore:4, rarity:"L",  inkable:true,  evade:true},

 /* ===== è¿½åŠ ã‚«ãƒ¼ãƒ‰ ===== */
 // èµ¤
 {id:9,  name:"ã‚¿ã‚¤ã‚¿ãƒ³",        color:"red",    type:"character", cost:5, atk:6, hp:5, lore:0, rarity:"SR", inkable:true,  mustAttack:true},
 {id:10, name:"ãƒã‚¸ãƒ§ãƒ‰ãƒ©",      color:"red",    type:"character", cost:9, atk:7, hp:5, lore:2, rarity:"L",  inkable:true,  effect:"destroyOnSummon"},
 {id:11, name:"ãã‚ãã‚ãƒ€ãƒƒã‚¯",  color:"red",    type:"character", cost:2, atk:2, hp:3, lore:1, rarity:"N",  inkable:true},

 // é’
 {id:12, name:"ã‚´ãƒ¼ã‚º",       color:"blue",   type:"character", cost:7, atk:3, hp:6, lore:2, rarity:"L",  inkable:false, effect:"toInkOnSummon"},
 {id:13, name:"ãƒªãƒ³",         color:"blue",   type:"character", cost:4, atk:2, hp:4, lore:1, rarity:"L",  inkable:true},
 {id:14, name:"ã‚‰ãŸã°ã‚",     color:"blue",   type:"character", cost:1, atk:1, hp:1, lore:0, rarity:"N",  inkable:true},
 {id:15, name:"ã‚ã‚Šã®ã¾ã¾ã§", color:"blue",   type:"song",      cost:5, atk:0, hp:0, lore:0, rarity:"SR", inkable:true,  effect:"songToInk1"},

 // é»„
 {id:16, name:"ãƒ—ãƒ¬ãƒƒãƒ„ã‚§ãƒ«",   color:"yellow", type:"character", cost:4, atk:1, hp:5, lore:2, rarity:"L",  inkable:true,  effect:"pretzelHealDraw"},
 {id:17, name:"ãƒŸã‚¹ã‚¿ãƒ¼ãƒã‚¸",   color:"yellow", type:"character", cost:3, atk:2, hp:5, lore:1, rarity:"N",  inkable:true},
 {id:18, name:"ãƒ•ãƒ³ãƒãƒ¼",       color:"yellow", type:"character", cost:4, atk:3, hp:5, lore:1, rarity:"N",  inkable:true},
 {id:19, name:"ã‚¢ãƒªã‚¨ãƒŠã‚¤",     color:"yellow", type:"character", cost:3, atk:2, hp:3, lore:1, rarity:"SR", inkable:true,  effect:"arienaiSearchSong", songPower:5}
];

function makeCardInstance(base) {
 return {
   id: base.id,
   name: base.name,
   color: base.color,
   type: base.type,
   cost: base.cost,
   atk: base.atk,
   hp: base.hp,
   maxHp: base.hp,
   lore: base.lore,
   rarity: base.rarity,
   inkable: base.inkable,
   effect: base.effect,
   evolveCost: base.evolveCost,
   evade: base.evade || false,
   mustAttack: base.mustAttack || false,
   songPower: base.songPower || base.cost,
   rest: false,
   frozen: false,
   summonTurn: 0
 };
}

/* ========== ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ ========== */
let stones = 0;
let collection = {};
let savedDecks = [[], [], []];  // 3ã¤ã®ãƒ‡ãƒƒã‚­
let currentDeckIndex = 0;       // 0:ãƒ‡ãƒƒã‚­1, 1:ãƒ‡ãƒƒã‚­2, 2:ãƒ‡ãƒƒã‚­3

function loadData() {
 const s = localStorage.getItem("ds_stones");
 stones = s ? parseInt(s,10) : 0;

 const c = localStorage.getItem("ds_collection");
 collection = c ? JSON.parse(c) : {};

 // æ–°å½¢å¼ï¼ˆ3ãƒ‡ãƒƒã‚­ï¼‰ã®èª­ã¿è¾¼ã¿
 const d3 = localStorage.getItem("ds_playerDecks");
 if (d3) {
   try {
     const parsed = JSON.parse(d3);
     if (Array.isArray(parsed) && parsed.length === 3) {
       savedDecks = parsed;
     }
   } catch(e) {}
 } else {
   // æ—§å½¢å¼ï¼ˆ1ãƒ‡ãƒƒã‚­ï¼‰ã‹ã‚‰ã®å¼•ãç¶™ã
   const dOld = localStorage.getItem("ds_playerDeck");
   if (dOld) {
     try {
       const one = JSON.parse(dOld);
       if (Array.isArray(one)) {
         savedDecks[0] = one;
       }
     } catch(e) {}
   }
 }

 updateStoneDisplays();
}

function saveStones() {
 localStorage.setItem("ds_stones", String(stones));
 updateStoneDisplays();
}

function saveCollection() {
 localStorage.setItem("ds_collection", JSON.stringify(collection));
}

function savePlayerDecks() {
 localStorage.setItem("ds_playerDecks", JSON.stringify(savedDecks));
}

function updateStoneDisplays() {
 const v1 = document.getElementById("stoneCount");
 const v2 = document.getElementById("shopStoneCount");
 const v3 = document.getElementById("packStoneCount");
 if (v1) v1.textContent = stones;
 if (v2) v2.textContent = stones;
 if (v3) v3.textContent = stones;
}

/* ========== ã‚·ãƒ§ãƒƒãƒ— ========== */
function showShop() {
 updateStoneDisplays();
 showScreen("shop");
}
function debugAddStones() {
 stones += 100;
 saveStones();
}

/* ========== ã‚¬ãƒãƒ£ ========== */
function showPack() {
 updateStoneDisplays();
 document.getElementById("packResult").innerHTML = "";
 showScreen("pack");
}

function openPack() {
 const COST = 5;
 if (stones < COST) {
   alert("ãƒ‰ãƒªãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³ãŒè¶³ã‚Šã¾ã›ã‚“ï¼ˆ5å€‹å¿…è¦ï¼‰");
   return;
 }
 stones -= COST;
 saveStones();

 const pulled = [];

 for (let i=0;i<5;i++) {
   const r = Math.random();
   let rarity;
   if (r < 0.78) rarity = "N";
   else if (r < 0.90) rarity = "R";
   else if (r < 0.98) rarity = "SR";
   else rarity = "L";

   let candidates = cards.filter(c => c.rarity === rarity);
   if (candidates.length === 0) {
     const order = ["L","SR","R","N"];
     for (const rr of order) {
       const list = cards.filter(c => c.rarity === rr);
       if (list.length) { candidates = list; break; }
     }
     if (!candidates.length) candidates = cards.slice();
   }

   const card = candidates[Math.floor(Math.random()*candidates.length)];
   pulled.push(card);
   if (!collection[card.id]) collection[card.id] = 0;
   collection[card.id]++;
 }
 saveCollection();

 const pr = document.getElementById("packResult");
 pr.innerHTML = pulled.map(c => `
   <div class="card-box ${c.color}">
     <div class="card-name">${c.name}</div>
     <div class="card-stats">è‰²:${c.color} / ãƒ¬ã‚¢:${c.rarity} / ç¨®é¡:${c.type}</div>
   </div>
 `).join("");
}

/* ========== ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ ========== */
function openCollection() {
 const list = document.getElementById("collectionList");
 let html = "";
 cards.forEach(c => {
   const cnt = collection[c.id] || 0;
   html += `
     <div class="card-box ${c.color}">
       <div class="card-name">${c.name}</div>
       <div class="card-stats">è‰²:${c.color} / ãƒ¬ã‚¢:${c.rarity} / ç¨®é¡:${c.type}</div>
       <div class="card-stats">æ‰€æŒæšæ•°: Ã—${cnt}</div>
     </div>`;
 });
 list.innerHTML = html;
 showScreen("collection");
}

/* ========== ãƒ‡ãƒƒã‚­ç·¨é›† ========== */
let deckCounts = {};

function openDeckBuilder(index) {
 if (typeof index === "number") {
   currentDeckIndex = index;
 }
 rebuildDeckEditor();
 showScreen("deck");
}

function switchDeck(idx) {
 currentDeckIndex = idx;
 rebuildDeckEditor();
}

function rebuildDeckEditor() {
 deckCounts = {};
 const currentDeck = savedDecks[currentDeckIndex] || [];
 currentDeck.forEach(id => {
   deckCounts[id] = (deckCounts[id] || 0) + 1;
 });

 const label = document.getElementById("currentDeckLabel");
 if (label) label.textContent = currentDeckIndex + 1;

 const area = document.getElementById("deckCardList");
 let html = "";
 cards.forEach(c => {
   const have = collection[c.id] || 0; // è¡¨ç¤ºç”¨
   const inDeck = deckCounts[c.id] || 0;
   html += `
     <div class="card-box ${c.color}">
       <div class="card-name">${c.name}</div>
       <div class="card-stats">
         è‰²:${c.color} / ãƒ¬ã‚¢:${c.rarity} / ç¨®é¡:${c.type} / ã‚³ã‚¹ãƒˆ:${c.cost}
       </div>
       <div class="card-stats">
         æ‰€æŒ: Ã—${have} ï¼ ãƒ‡ãƒƒã‚­: Ã—<span id="deck-count-${c.id}">${inDeck}</span>
       </div>
       <button class="btn small" onclick="changeDeckCount(${c.id}, -1)">ï¼</button>
       <button class="btn small" onclick="changeDeckCount(${c.id}, +1)">ï¼‹</button>
     </div>`;
 });
 area.innerHTML = html;
}

// åŸºæœ¬ã‚«ãƒ¼ãƒ‰åˆ¤å®šï¼ˆ0ã€œ5ã¯ç„¡åˆ¶é™ï¼‰
function isBasicCard(cardId) {
 return cardId >= 0 && cardId <= 5;
}

// ãƒ‡ãƒƒã‚­å†…ã®ä½¿ç”¨è‰²ã‚»ãƒƒãƒˆã‚’è¿”ã™
function getDeckColors(counts) {
 const colors = new Set();
 Object.entries(counts).forEach(([idStr, cnt]) => {
   if (cnt > 0) {
     const base = cards.find(c => c.id === parseInt(idStr,10));
     if (base) colors.add(base.color);
   }
 });
 return colors;
}

function changeDeckCount(cardId, diff) {
 const card = cards.find(c => c.id === cardId);
 if (!card) return;

 let cur = deckCounts[cardId] || 0;
 const before = cur;
 cur += diff;
 if (cur < 0) cur = 0;

 // ã„ã£ãŸã‚“åæ˜ ã—ã¦è‰²ãƒã‚§ãƒƒã‚¯ç”¨ã®ä»®ãƒ‡ãƒƒã‚­ã‚’ä½œã‚‹
 deckCounts[cardId] = cur;

 // å¢—ã‚„ã—ãŸã¨ãã ã‘è‰²ãƒã‚§ãƒƒã‚¯
 if (cur > before) {
   const colors = getDeckColors(deckCounts);
   if (colors.size > 2) {
     // 3è‰²ç›®ã¯NGãªã®ã§å…ƒã«æˆ»ã™
     deckCounts[cardId] = before;
     cur = before;
     alert("ãƒ‡ãƒƒã‚­ã¯2è‰²ã¾ã§ã§ã™ã€‚3è‰²ç›®ã®ã‚«ãƒ¼ãƒ‰ã¯å…¥ã‚Œã‚‰ã‚Œã¾ã›ã‚“ã€‚");
   }
 }

 // åŒåã‚«ãƒ¼ãƒ‰ä¸Šé™ï¼ˆåŸºæœ¬6ç¨®ä»¥å¤–ã¯4æšã¾ã§ï¼‰
 const basic = isBasicCard(cardId);
 if (!basic && cur > 4) {
   cur = 4;
   deckCounts[cardId] = cur;
   if (diff > 0) {
     alert("åŒã˜åå‰ã®ã‚«ãƒ¼ãƒ‰ã¯4æšã¾ã§ã§ã™ã€‚");
   }
 }

 const span = document.getElementById("deck-count-"+cardId);
 if (span) span.textContent = cur;
}

function saveDeck() {
 const newDeck = [];
 Object.entries(deckCounts).forEach(([idStr,cnt]) => {
   const id = parseInt(idStr,10);
   for (let i=0;i<cnt;i++) newDeck.push(id);
 });

 if (newDeck.length < 60) {
   alert("ãƒ‡ãƒƒã‚­ã¯60æšä»¥ä¸Šã«ã—ã¦ãã ã•ã„ã€‚ï¼ˆç¾åœ¨ " + newDeck.length + "æšï¼‰");
   return;
 }

 savedDecks[currentDeckIndex] = newDeck;
 savePlayerDecks();
 alert("ãƒ‡ãƒƒã‚­" + (currentDeckIndex+1) + "ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ï¼ˆ" + newDeck.length + "æšï¼‰");
 updatePlayerDeckButtons();
}

/* ========== CPUè¨­å®š ========== */
let cpuStrength = "normal";
let cpuColor = "red";
let playerDeckMode = "default"; // "default", "deck1", "deck2", "deck3"

function openCpuConfig() {
 updateCpuButtons();
 updatePlayerDeckButtons();
 showScreen("cpu");
}
function setCpuStrength(s) {
 cpuStrength = s;
 updateCpuButtons();
}
function setCpuColor(color) {
 cpuColor = color;
 updateCpuButtons();
}
function updateCpuButtons() {
 document.getElementById("btnCpuNormal").classList.toggle("toggle-selected", cpuStrength==="normal");
 document.getElementById("btnCpuStrong").classList.toggle("toggle-selected", cpuStrength==="strong");
 const colors = ["red","purple","blue","yellow","white","green"];
 colors.forEach(c => {
   const btnId = "cpu" + c.charAt(0).toUpperCase() + c.slice(1);
   const btn = document.getElementById(btnId);
   if (!btn) return;
   btn.classList.toggle("toggle-selected", cpuColor===c);
 });
}

function hasCustomDeck(index) {
 const deck = savedDecks[index];
 return Array.isArray(deck) && deck.length > 0;
}

function updatePlayerDeckButtons() {
 const btnDef = document.getElementById("btnPlayerDefault");
 const btn1 = document.getElementById("btnDeck1");
 const btn2 = document.getElementById("btnDeck2");
 const btn3 = document.getElementById("btnDeck3");

 btnDef.classList.toggle("toggle-selected", playerDeckMode==="default");
 btn1.classList.toggle("toggle-selected", playerDeckMode==="deck1");
 btn2.classList.toggle("toggle-selected", playerDeckMode==="deck2");
 btn3.classList.toggle("toggle-selected", playerDeckMode==="deck3");

 const btns = [btn1, btn2, btn3];
 for (let i=0;i<3;i++) {
   if (!hasCustomDeck(i)) {
     btns[i].disabled = true;
     btns[i].textContent = "ãƒ‡ãƒƒã‚­" + (i+1) + "ï¼ˆæœªä¿å­˜ï¼‰";
   } else {
     btns[i].disabled = false;
     btns[i].textContent = "ãƒ‡ãƒƒã‚­" + (i+1);
   }
 }
}

function selectPlayerDeck(mode) {
 if (mode.startsWith("deck")) {
   const idx = parseInt(mode.slice(4), 10) - 1;
   if (!hasCustomDeck(idx)) {
     alert("ã¾ãšãƒ‡ãƒƒã‚­ç·¨é›†ã§ãƒ‡ãƒƒã‚­" + (idx+1) + "ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
     return;
   }
 }
 playerDeckMode = mode;
 updatePlayerDeckButtons();
}

/* ========== å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========== */
function shuffle(arr) {
 for (let i=arr.length-1;i>0;i--) {
   const j = Math.floor(Math.random()*(i+1));
   [arr[i],arr[j]] = [arr[j],arr[i]];
 }
}

/* ========== ãƒãƒˆãƒ«é–¢é€£ ========== */
let battle = null;
let pendingAttackIndex = null;
let freezeSelectMode = false;
let destroySelectMode = false;
let destroySelectOwner = null; // "cpu" / "player"
let sendToInkSelectMode = false;
let sendToInkOwner = null; // "cpu" / "player"

function startBattle() {
 // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒƒã‚­ç”Ÿæˆ
 let playerDeckCards = [];

 if (playerDeckMode.startsWith("deck")) {
   const idx = parseInt(playerDeckMode.slice(4), 10) - 1; // deck1â†’0
   const deck = savedDecks[idx] || [];
   deck.forEach(id => {
     const base = cards.find(c => c.id === id);
     if (base) playerDeckCards.push(makeCardInstance(base));
   });
 }

 if (playerDeckCards.length === 0) {
   // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèµ¤ãƒ‡ãƒƒã‚­ 60æšï¼ˆç°¡æ˜“ï¼‰
   for (let i=0;i<52;i++) playerDeckCards.push(makeCardInstance(cards[0])); // ã‚«ãƒ¼
   playerDeckCards.push(makeCardInstance(cards[6])); // çµ‚ç„‰
   playerDeckCards.push(makeCardInstance(cards[6]));
   playerDeckCards.push(makeCardInstance(cards[7])); // ã‚±ãƒ«ã‚µ
   playerDeckCards.push(makeCardInstance(cards[8])); // ã‚¤ãƒ•ãƒªãƒ¼ãƒˆ
   playerDeckCards.push(makeCardInstance(cards[11])); // ãã‚ãã‚ãƒ€ãƒƒã‚¯
 }

 // CPUãƒ‡ãƒƒã‚­ç”Ÿæˆ 60æš
 let cpuDeckCards = [];
 const baseN  = cards.filter(c => c.rarity==="N"  && c.color===cpuColor);
 const baseSR = cards.filter(c => c.rarity==="SR" && cpuStrength!=="normal");
 const baseL  = cards.filter(c => c.rarity==="L"  && cpuStrength==="strong");

 for (let i=0;i<56;i++){
   const src = baseN.length ? baseN : cards.filter(c=>c.rarity==="N");
   cpuDeckCards.push(makeCardInstance(src[i % src.length]));
 }
 if (baseSR.length) cpuDeckCards.push(makeCardInstance(baseSR[0]));
 if (baseL.length)  cpuDeckCards.push(makeCardInstance(baseL[0]));
 // è¶³ã‚Šãªã‘ã‚Œã°Nã§åŸ‹ã‚ã‚‹
 while (cpuDeckCards.length < 60) {
   cpuDeckCards.push(makeCardInstance(cards[0]));
 }

 shuffle(playerDeckCards);
 shuffle(cpuDeckCards);

 battle = {
   turn: "player",
   turnCount: 1,
   player: {
     deck: playerDeckCards,
     hand: [],
     field: [],
     lore: 0,
     inkTotal: 0,
     inkAvail: 0,
     inkUsedThisTurn: 0
   },
   cpu: {
     deck: cpuDeckCards,
     hand: [],
     field: [],
     lore: 0,
     inkTotal: 0,
     inkAvail: 0,
     inkUsedThisTurn: 0
   }
 };

 // åˆæœŸæ‰‹æœ­7æš
 for (let i=0;i<7;i++) {
   if (battle.player.deck.length) battle.player.hand.push(battle.player.deck.pop());
   if (battle.cpu.deck.length)    battle.cpu.hand.push(battle.cpu.deck.pop());
 }

 clearLog();
 addLog("ãƒãƒˆãƒ«é–‹å§‹ï¼");
 showScreen("battle");

 // å…ˆæ”»1ã‚¿ãƒ¼ãƒ³ç›®é–‹å§‹ï¼ˆãƒ‰ãƒ­ãƒ¼ãªã—ï¼‰
 startPlayerTurn(true);
}

/* ========== ã‚¤ãƒ³ã‚¯é–¢é€£ï¼ˆãƒªãƒ³å¯¾å¿œï¼‰ ========== */
function ownerHasLin(owner) {
 return owner.field.some(card => card.id === ID_LIN);
}
function getMaxInkPerTurn(owner) {
 let base = 1;
 if (ownerHasLin(owner)) base += 1;
 return base;
}

/* ========== ãƒªãƒ³ã®ãƒ­ã‚¢å‹•çš„æ›´æ–° ========== */
function updateLinLore() {
 if (!battle) return;
 [battle.player, battle.cpu].forEach(owner => {
   owner.field.forEach(card => {
     if (card.id === ID_LIN) {
       card.lore = (owner.inkTotal >= 10 ? 5 : 1);
     }
   });
 });
}

/* ========== æ­»äº¡æ™‚å‡¦ç†ï¼ˆã‚‰ãŸã°ã‚ç­‰ï¼‰ ========== */
function onCardDestroyed(owner, card) {
 if (card.id === ID_RATABAA) {
   owner.inkTotal++;
   owner.inkAvail++;
   addLog(`ã€Œ${card.name}ã€ã¯ç ´å£Šã•ã‚Œã€ã‚³ã‚¹ãƒˆã«ãªã£ãŸã€‚`);
 }
}

/* ========== æ±ç”¨ï¼šã‚­ãƒ£ãƒ©ã‚’ã€Œã‚³ã‚¹ãƒˆã«é€ã‚‹ã€ ========== */
function sendCharacterToInk(owner, index) {
 const card = owner.field[index];
 if (!card) return;
 owner.field.splice(index,1);
 owner.inkTotal++;
 owner.inkAvail++;
 addLog(`ã€Œ${card.name}ã€ã¯ã‚³ã‚¹ãƒˆã«é€ã‚‰ã‚ŒãŸã€‚`);
}

/* ========== ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¿ãƒ¼ãƒ³é–‹å§‹å‡¦ç† ========== */
function startPlayerTurn(isFirstTurn) {
 if (!battle) return;
 const p = battle.player;

 battle.turn = "player";

 // è‡ªåˆ†ã®å ´ã®ãƒ¬ã‚¹ãƒˆè§£é™¤ï¼†å‡çµè§£é™¤
 p.field.forEach(card => {
   card.rest = false;
   if (card.frozen) card.frozen = false;
 });

 // ã‚¤ãƒ³ã‚¯ä½¿ç”¨ãƒªã‚»ãƒƒãƒˆ & å…¨å›å¾©
 p.inkUsedThisTurn = 0;
 p.inkAvail = p.inkTotal;

 // å…ˆæ”»1ã‚¿ãƒ¼ãƒ³ç›®ä»¥å¤–ã¯ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã«è‡ªå‹•ãƒ‰ãƒ­ãƒ¼
 if (!isFirstTurn) {
   if (p.deck.length) {
     p.hand.push(p.deck.pop());
     addLog("è‡ªåˆ†ã¯1æšãƒ‰ãƒ­ãƒ¼ã—ãŸã€‚");
   } else {
     addLog("è‡ªåˆ†ã¯å±±æœ­ãŒãªãã€ãƒ‰ãƒ­ãƒ¼ã§ããªã„ã€‚");
   }
 }

 addLog("è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã€‚");
 document.getElementById("actionArea").textContent = "ã‚­ãƒ£ãƒ©ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è¡Œå‹•ã‚’é¸ã¹ã¾ã™ã€‚";
 updateBattleView();
}

/* ========== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æç”» ========== */
function renderCardHtml(card) {
 const powerText = (card.type === "character")
   ? `${card.atk} / ${card.hp}/${card.maxHp}`
   : "ã‚½ãƒ³ã‚°";
 const loreText = card.lore ? `ãƒ­ã‚¢${card.lore}` : "";
 const costable = card.inkable ? "â­•ï¸" : "âŒ";
 let frozenMark = card.frozen ? "â„" : "";

 return `
   <div class="card ${card.color} ${card.rest ? "rest" : ""}">
     <div class="card-header">
       <span class="card-cost">${card.cost}</span>
       <span class="card-name-header">${card.name}${frozenMark}</span>
       <span class="card-inkable">${costable}</span>
     </div>
     <div class="card-illustration"></div>
     <div class="card-stats-row">
       <span>${powerText}</span>
       <span>${loreText}</span>
     </div>
     <div class="card-footer">
       ${card.type === "song" ? "ã‚½ãƒ³ã‚°" : "ã‚­ãƒ£ãƒ©"}
     </div>
   </div>
 `;
}

function updateBattleView() {
 if (!battle) return;
 const p = battle.player;
 const c = battle.cpu;

 updateLinLore();

 document.getElementById("playerLore").textContent = p.lore;
 document.getElementById("playerInkCurrent").textContent = p.inkAvail;
 document.getElementById("playerInkMax").textContent = p.inkTotal;
 document.getElementById("playerDeck").textContent = p.deck.length;

 document.getElementById("cpuHandCount").textContent = c.hand.length;
 document.getElementById("cLore").textContent = c.lore;
 document.getElementById("cDeck").textContent = c.deck.length;

 // è‡ªåˆ†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
 const pf = document.getElementById("playerField");
 pf.innerHTML = "";
 p.field.forEach((card, idx)=>{
   const wrap = document.createElement("div");
   wrap.innerHTML = renderCardHtml(card);
   const el = wrap.firstElementChild;
   el.onclick = ()=>onPlayerFieldClick(idx);
   pf.appendChild(el);
 });

 // CPUãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
 const cf = document.getElementById("cpuField");
 cf.innerHTML = "";
 c.field.forEach((card, idx)=>{
   const wrap = document.createElement("div");
   wrap.innerHTML = renderCardHtml(card);
   const el = wrap.firstElementChild;
   el.onclick = ()=>onCpuFieldClick(idx);
   cf.appendChild(el);
 });

 // æ‰‹æœ­
 const ph = document.getElementById("playerHand");
 ph.innerHTML = "";
 p.hand.forEach((card, idx)=>{
   const wrap = document.createElement("div");
   wrap.innerHTML = renderCardHtml(card);
   const cardEl = wrap.firstElementChild;

   // ãƒœã‚¿ãƒ³
   const btnArea = document.createElement("div");
   btnArea.className = "card-footer-buttons";

   const inkBtn = document.createElement("button");
   inkBtn.className = "btn small";
   inkBtn.textContent = "ã‚¤ãƒ³ã‚¯";
   inkBtn.onclick = ()=>inkFromHand(idx);

   const summonBtn = document.createElement("button");
   summonBtn.className = "btn small";
   summonBtn.textContent = "å¬å–š";
   summonBtn.onclick = ()=>playFromHand(idx);

   btnArea.appendChild(inkBtn);
   btnArea.appendChild(summonBtn);
   cardEl.appendChild(btnArea);

   ph.appendChild(cardEl);
 });

 // ã‚¿ãƒ¼ãƒ³è¡¨ç¤º
 document.getElementById("turnInfo").textContent =
   (battle.turn === "player") ? "è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³" : "ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³";

 checkWin();
}

/* ========== ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡Œå‹• ========== */
function playerDraw() {
 // ãƒ‰ãƒ­ãƒ¼ã¯ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã«è‡ªå‹•ã§è¡Œã‚ã‚Œã‚‹
 alert("ãƒ‰ãƒ­ãƒ¼ã¯ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã«è‡ªå‹•ã§1æšè¡Œã‚ã‚Œã¾ã™ã€‚ï¼ˆå…ˆæ”»1ã‚¿ãƒ¼ãƒ³ç›®ã‚’é™¤ãï¼‰");
}

function inkFromHand(index) {
 if (!battle) return;
 const p = battle.player;
 const card = p.hand[index];
 if (!card) return;

 const maxInk = getMaxInkPerTurn(p);
 if (p.inkUsedThisTurn >= maxInk) {
   alert("ã“ã®ã‚¿ãƒ¼ãƒ³ã«ç½®ã‘ã‚‹ã‚¤ãƒ³ã‚¯ã¯ã“ã‚Œä»¥ä¸Šã‚ã‚Šã¾ã›ã‚“ã€‚");
   return;
 }

 if (!card.inkable) {
   alert("ã“ã®ã‚«ãƒ¼ãƒ‰ã¯ã‚¤ãƒ³ã‚¯ã«ã§ãã¾ã›ã‚“ã€‚");
   return;
 }
 p.hand.splice(index,1);
 p.inkTotal++;
 p.inkAvail++;
 p.inkUsedThisTurn++;
 addLog(`ã€Œ${card.name}ã€ã‚’ã‚¤ãƒ³ã‚¯ã«ç½®ã„ãŸã€‚`);
 updateBattleView();
}

function playFromHand(index) {
 if (!battle) return;
 const p = battle.player;
 const c = battle.cpu;
 const card = p.hand[index];
 if (!card) return;

 // å¤‰èº«ãƒã‚§ãƒƒã‚¯ï¼ˆã‚±ãƒ«ã‚µï¼‰
 if (card.evolveCost !== undefined) {
   const baseNamePart = "ã‚«ãƒ¼"; // å¤‰èº«å…ƒ
   let baseIndex = -1;
   for (let i=0;i<p.field.length;i++) {
     if (p.field[i].name.includes(baseNamePart)) {
       baseIndex = i;
       break;
     }
   }
   if (baseIndex >= 0) {
     const base = p.field[baseIndex];
     if (p.inkAvail < card.evolveCost) {
       alert("å¤‰èº«ã‚³ã‚¹ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“ã€‚");
       return;
     }
     p.inkAvail -= card.evolveCost;
     // ãƒ€ãƒ¡ãƒ¼ã‚¸å¼•ãç¶™ã
     const lost = base.maxHp - base.hp;
     card.hp = card.maxHp - lost;
     if (card.hp < 1) card.hp = 1;
     card.rest = base.rest;
     card.summonTurn = base.summonTurn;
     p.field[baseIndex] = card;
     p.hand.splice(index,1);
     addLog(`ã€Œ${base.name}ã€ã¯ã€Œ${card.name}ã€ã«å¤‰èº«ã—ãŸï¼`);
     if (card.effect === "freeze2") {
       startFreezeSelect();
     }
     if (card.effect === "pretzelHealDraw") {
       doPretzelEffect(p);
     }
     if (card.effect === "arienaiSearchSong") {
       doArienaiEffect(p);
     }
     updateBattleView();
     return;
   }
 }

 // é€šå¸¸å¬å–š
 if (p.inkAvail < card.cost) {
   alert("ã‚¤ãƒ³ã‚¯ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚");
   return;
 }
 p.inkAvail -= card.cost;
 card.summonTurn = battle.turnCount;
 card.rest = false;
 p.hand.splice(index,1);
 p.field.push(card);
 addLog(`ã€Œ${card.name}ã€ã‚’å¬å–šã—ãŸã€‚`);

 // ETBåŠ¹æœ
 if (card.effect === "freeze2") {
   startFreezeSelect();
 } else if (card.effect === "destroyOnSummon") {
   startDestroySelect("cpu");
 } else if (card.effect === "toInkOnSummon") {
   startSendToInkSelect("cpu");
 } else if (card.effect === "pretzelHealDraw") {
   doPretzelEffect(p);
 } else if (card.effect === "arienaiSearchSong") {
   doArienaiEffect(p);
 }

 updateBattleView();
}

/* ========== ãƒ—ãƒ¬ãƒƒãƒ„ã‚§ãƒ«ã®åŠ¹æœ ==========
   å ´ã®å‘³æ–¹ã‚­ãƒ£ãƒ©ã‹ã‚‰åˆè¨ˆ3ãƒ€ãƒ¡ãƒ¼ã‚¸ã¾ã§å›å¾©ã—ã€ãã®å›å¾©ã—ãŸæ•°ã ã‘ãƒ‰ãƒ­ãƒ¼
====================================== */
function drawOne(owner) {
 if (!owner.deck.length) return false;
 owner.hand.push(owner.deck.pop());
 return true;
}

function doPretzelEffect(owner) {
 let healed = 0;
 while (healed < 3) {
   const target = owner.field.find(c => c.hp < c.maxHp);
   if (!target) break;
   target.hp++;
   healed++;
 }
 if (healed > 0) {
   for (let i=0;i<healed;i++) {
     drawOne(owner);
   }
   if (owner === battle.player) {
     addLog(`ã€Œãƒ—ãƒ¬ãƒƒãƒ„ã‚§ãƒ«ã€ã®åŠ¹æœã§åˆè¨ˆ${healed}ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å›å¾©ã—ã€${healed}æšãƒ‰ãƒ­ãƒ¼ã—ãŸã€‚`);
   } else {
     addLog(`CPUã®ã€Œãƒ—ãƒ¬ãƒƒãƒ„ã‚§ãƒ«ã€ã®åŠ¹æœã§${healed}å›å¾©ï¼†${healed}ãƒ‰ãƒ­ãƒ¼ã€‚`);
   }
 }
}

/* ========== ã‚¢ãƒªã‚¨ãƒŠã‚¤ã®ã‚½ãƒ³ã‚°ã‚µãƒ¼ãƒ ========== */
function doArienaiEffect(owner) {
 const temp = [];
 for (let i=0;i<4 && owner.deck.length;i++) {
   temp.push(owner.deck.pop());
 }
 let songIndex = -1;
 for (let i=0;i<temp.length;i++) {
   if (temp[i].type === "song") { songIndex = i; break; }
 }
 if (songIndex >= 0) {
   const card = temp.splice(songIndex,1)[0];
   owner.hand.push(card);
   addLog(`ã€Œã‚¢ãƒªã‚¨ãƒŠã‚¤ã€ã®åŠ¹æœã§ã‚½ãƒ³ã‚°ã€Œ${card.name}ã€ã‚’æ‰‹æœ­ã«åŠ ãˆãŸã€‚`);
 }
 // æ®‹ã‚Šã‚’ãƒ‡ãƒƒã‚­ã®ä¸‹ï¼ˆå…ˆé ­å´ï¼‰ã¸
 for (let i=temp.length-1;i>=0;i--) {
   owner.deck.unshift(temp[i]);
 }
}

/* ========== ã‚±ãƒ«ã‚µã®å‡çµé¸æŠ ========== */
let freezeTargets = [];

function startFreezeSelect() {
 if (!battle) return;
 const c = battle.cpu;
 if (c.field.length === 0) {
   addLog("ã‚±ãƒ«ã‚µåŠ¹æœï¼šå¯¾è±¡ã®ã‚­ãƒ£ãƒ©ãŒã„ã¾ã›ã‚“ã€‚");
   return;
 }
 freezeTargets = [];
 freezeSelectMode = true;
 document.getElementById("actionArea").innerHTML =
   `å‡çµã•ã›ã‚‹ç›¸æ‰‹ã‚­ãƒ£ãƒ©ã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆæœ€å¤§2ä½“ï¼‰ã€‚<br>
    ç›¸æ‰‹ã‚­ãƒ£ãƒ©ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠã€‚<br>
    <button class="btn small" onclick="finishFreezeSelect()">é¸æŠçµ‚äº†</button>`;
}

function finishFreezeSelect() {
 if (!battle) return;
 const c = battle.cpu;
 freezeTargets.forEach(idx=>{
   if (c.field[idx]) {
     c.field[idx].frozen = true;
     addLog(`ã€Œ${c.field[idx].name}ã€ã¯å‡çµã•ã‚ŒãŸï¼`);
   }
 });
 freezeSelectMode = false;
 freezeTargets = [];
 document.getElementById("actionArea").textContent = "ã‚­ãƒ£ãƒ©ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è¡Œå‹•ã‚’é¸ã¹ã¾ã™ã€‚";
 updateBattleView();
}

/* ========== ãƒã‚¸ãƒ§ãƒ‰ãƒ©ã®ç ´å£Šé¸æŠ ========== */
function startDestroySelect(ownerSide) {
 destroySelectMode = true;
 destroySelectOwner = ownerSide; // "cpu"ã®ã¿ä½¿ç”¨
 document.getElementById("actionArea").textContent =
   "é€€å ´ã•ã›ã‚‹ç›¸æ‰‹ã‚­ãƒ£ãƒ©ã‚’1ä½“é¸ã‚“ã§ãã ã•ã„ã€‚";
}

/* ========== ã‚´ãƒ¼ã‚ºï¼ã‚ã‚Šã®ã¾ã¾ã§ ã®ã€Œã‚³ã‚¹ãƒˆé€ã‚Šã€ ========== */
function startSendToInkSelect(ownerSide) {
 sendToInkSelectMode = true;
 sendToInkOwner = ownerSide; // "cpu" or "player"
 document.getElementById("actionArea").textContent =
   "ã‚³ã‚¹ãƒˆã«é€ã‚‹ã‚­ãƒ£ãƒ©ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚";
}

/* ========== ã‚¿ã‚¤ã‚¿ãƒ³ã®å¼·åˆ¶ã‚¢ã‚¿ãƒƒã‚¯åˆ¤å®š ========== */
function hasValidChallengeTarget(attacker, attackerOwner, defenderOwner) {
 const targets = defenderOwner.field.filter(t => {
   if (!t.rest) return false;
   if (t.evade && !attacker.evade) return false;
   return true;
 });
 return targets.length > 0;
}

/* ========== ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¯ãƒªãƒƒã‚¯ ========== */
function onPlayerFieldClick(index) {
 if (!battle) return;
 const p = battle.player;
 const c = battle.cpu;
 const card = p.field[index];
 if (!card) return;

 if (card.frozen) {
   alert("ã“ã®ã‚­ãƒ£ãƒ©ã¯å‡çµä¸­ã§ã™ã€‚");
   return;
 }
 if (card.rest) {
   alert("ã“ã®ã‚­ãƒ£ãƒ©ã¯ã™ã§ã«è¡Œå‹•ã—ã¾ã—ãŸã€‚");
   return;
 }

 const titanMustAttack =
   card.mustAttack && hasValidChallengeTarget(card, p, c);

 let html = `<div>${card.name} ã®è¡Œå‹•ã‚’é¸æŠï¼š</div>`;

 if (!titanMustAttack) {
   html += `<button class="btn small" onclick="doSeek(${index})">ã‚·ãƒ¼ã‚¯ï¼ˆãƒ­ã‚¢ï¼‹${card.lore}ï¼‰</button>`;
 }

 html += `<button class="btn small" onclick="prepareChallenge(${index})">ãƒãƒ£ãƒ¬ãƒ³ã‚¸</button>`;

 // ã‚½ãƒ³ã‚°ã‚’æ­Œãˆã‚‹ã‹ï¼ˆçµ‚ç„‰ã®å¤§ç« / ã‚ã‚Šã®ã¾ã¾ã§ ç­‰ï¼‰
 const songIndex = findSongInHand(card.songPower);
 if (!titanMustAttack && songIndex >= 0) {
   html += `<button class="btn small" onclick="songAsk(${index},${songIndex})">ã‚½ãƒ³ã‚°ã‚’æ­Œã†</button>`;
 }

 document.getElementById("actionArea").innerHTML = html;
}

function onCpuFieldClick(index) {
 if (!battle) return;
 const c = battle.cpu;
 const p = battle.player;
 const card = c.field[index];
 if (!card) return;

 // ã€Œã‚³ã‚¹ãƒˆã«é€ã‚‹ã€é¸æŠä¸­
 if (sendToInkSelectMode && sendToInkOwner === "cpu") {
   sendCharacterToInk(c, index);
   sendToInkSelectMode = false;
   sendToInkOwner = null;
   document.getElementById("actionArea").textContent =
     "ã‚­ãƒ£ãƒ©ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è¡Œå‹•ã‚’é¸ã¹ã¾ã™ã€‚";
   updateBattleView();
   return;
 }

 // ãƒã‚¸ãƒ§ãƒ‰ãƒ©ç ´å£Šé¸æŠä¸­
 if (destroySelectMode && destroySelectOwner === "cpu") {
   const target = c.field[index];
   if (target) {
     c.field.splice(index,1);
     onCardDestroyed(c, target);
     addLog(`ã€Œ${target.name}ã€ã¯ã€Œãƒã‚¸ãƒ§ãƒ‰ãƒ©ã€ã®åŠ¹æœã§é€€å ´ã—ãŸã€‚`);
   }
   destroySelectMode = false;
   destroySelectOwner = null;
   document.getElementById("actionArea").textContent =
     "ã‚­ãƒ£ãƒ©ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è¡Œå‹•ã‚’é¸ã¹ã¾ã™ã€‚";
   updateBattleView();
   return;
 }

 // ã‚±ãƒ«ã‚µå‡çµé¸æŠä¸­
 if (freezeSelectMode) {
   if (!freezeTargets.includes(index)) {
     freezeTargets.push(index);
     addLog(`å‡çµå¯¾è±¡ã«ã€Œ${card.name}ã€ã‚’é¸æŠã€‚`);
     if (freezeTargets.length >= 2) {
       finishFreezeSelect();
     }
   }
   return;
 }

 // ãƒãƒ£ãƒ¬ãƒ³ã‚¸å¯¾è±¡é¸æŠä¸­
 if (pendingAttackIndex !== null) {
   challengeTarget(index);
   return;
 }

 // ãŸã è¦‹ã‚‹ã ã‘
 document.getElementById("actionArea").textContent =
   `ç›¸æ‰‹ã®ã€Œ${card.name}ã€ ATK:${card.atk} / HP:${card.hp}/${card.maxHp}`;
}

/* ========== ã‚·ãƒ¼ã‚¯ / ãƒãƒ£ãƒ¬ãƒ³ã‚¸ ========== */
function doSeek(index) {
 const p = battle.player;
 const card = p.field[index];
 if (!card) return;
 if (card.rest || card.frozen) return;

 p.lore += card.lore;
 card.rest = true;
 addLog(`ã€Œ${card.name}ã€ãŒã‚·ãƒ¼ã‚¯ã—ã¦ãƒ­ã‚¢ã‚’${card.lore}å¾—ãŸã€‚`);
 document.getElementById("actionArea").textContent = "ã‚·ãƒ¼ã‚¯ã—ã¾ã—ãŸã€‚";
 updateBattleView();
}

function prepareChallenge(index) {
 const card = battle.player.field[index];
 if (!card) return;
 if (card.rest || card.frozen) return;

 pendingAttackIndex = index;
 document.getElementById("actionArea").textContent =
   "æ”»æ’ƒã™ã‚‹ç›¸æ‰‹ã®ãƒ¬ã‚¹ãƒˆã—ã¦ã„ã‚‹ã‚­ãƒ£ãƒ©ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚";
}

function challengeTarget(cpuIndex) {
 const p = battle.player;
 const c = battle.cpu;
 const attacker = p.field[pendingAttackIndex];
 const target   = c.field[cpuIndex];
 if (!attacker || !target) return;

 if (!target.rest) {
   alert("ãƒ¬ã‚¹ãƒˆã—ã¦ã„ã‚‹ã‚­ãƒ£ãƒ©ã—ã‹æ”»æ’ƒã§ãã¾ã›ã‚“ã€‚");
   return;
 }

 // å›é¿
 if (target.evade && !attacker.evade) {
   alert("ã“ã®ã‚­ãƒ£ãƒ©ã¯å›é¿ã‚’æŒã¤ã‚­ãƒ£ãƒ©ã«ã—ã‹ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã•ã‚Œã¾ã›ã‚“ã€‚");
   return;
 }

 target.hp   -= attacker.atk;
 attacker.hp -= target.atk;
 attacker.rest = true;

 addLog(`ã€Œ${attacker.name}ã€ãŒã€Œ${target.name}ã€ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼`);

 if (target.hp <= 0) {
   c.field.splice(cpuIndex,1);
   onCardDestroyed(c, target);
   addLog(`ã€Œ${target.name}ã€ã¯é€€å ´ã—ãŸã€‚`);
 }
 if (attacker.hp <= 0) {
   p.field.splice(pendingAttackIndex,1);
   onCardDestroyed(p, attacker);
   addLog(`ã€Œ${attacker.name}ã€ã¯é€€å ´ã—ãŸã€‚`);
 }

 pendingAttackIndex = null;
 document.getElementById("actionArea").textContent =
   "ã‚­ãƒ£ãƒ©ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è¡Œå‹•ã‚’é¸ã¹ã¾ã™ã€‚";
 updateBattleView();
}

/* ========== ã‚½ãƒ³ã‚°ï¼ˆçµ‚ç„‰ã®å¤§ç«/ã‚ã‚Šã®ã¾ã¾ã§ï¼‰ ========== */
function findSongInHand(maxSongPower) {
 const hand = battle.player.hand;
 for (let i=0;i<hand.length;i++) {
   if (hand[i].type === "song" && hand[i].cost <= maxSongPower) return i;
 }
 return -1;
}

function songAsk(charIndex, songIndex) {
 const p = battle.player;
 const char = p.field[charIndex];
 const spell = p.hand[songIndex];
 let html = `
   <div>ã€Œ${spell.name}ã€ã‚’ ${char.name} ãŒæ­Œã„ã¾ã™ã‹ï¼Ÿ</div>
   <button class="btn small" onclick="songCast(${charIndex},${songIndex},true)">ã‚­ãƒ£ãƒ©ã§æ­Œã†ï¼ˆã‚³ã‚¹ãƒˆ0ï¼‰</button>
   <button class="btn small" onclick="songCast(${charIndex},${songIndex},false)">é€šå¸¸å”±ãˆã‚‹ï¼ˆã‚³ã‚¹ãƒˆæ”¯æ‰•ã„ï¼‰</button>
 `;
 document.getElementById("actionArea").innerHTML = html;
}

function songCast(charIndex, songIndex, freeCast) {
 const p = battle.player;
 const spell = p.hand[songIndex];

 if (!freeCast) {
   if (p.inkAvail < spell.cost) {
     alert("ã‚¤ãƒ³ã‚¯ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚");
     return;
   }
   p.inkAvail -= spell.cost;
 } else {
   // ã‚­ãƒ£ãƒ©ã§æ­Œã† â†’ ãƒ¬ã‚¹ãƒˆ
   if (p.field[charIndex]) {
     p.field[charIndex].rest = true;
   }
 }

 p.hand.splice(songIndex,1);

 if (spell.effect === "boardwipe") {
   // ç ´å£Šæ‰±ã„
   battle.player.field.forEach(card => onCardDestroyed(battle.player, card));
   battle.cpu.field.forEach(card => onCardDestroyed(battle.cpu, card));
   battle.player.field = [];
   battle.cpu.field = [];
   addLog("çµ‚ç„‰ã®å¤§ç«ãŒç™ºå‹•ï¼å ´ã®ã‚­ãƒ£ãƒ©ã¯ã™ã¹ã¦ç ´å£Šã•ã‚ŒãŸï¼");
 } else if (spell.effect === "songToInk1") {
   if (battle.cpu.field.length === 0) {
     addLog("å¯¾è±¡ã®ã‚­ãƒ£ãƒ©ãŒã„ãªã„ãŸã‚ã€Œã‚ã‚Šã®ã¾ã¾ã§ã€ã¯ä¸ç™ºã€‚");
   } else {
     startSendToInkSelect("cpu");
   }
 }

 document.getElementById("actionArea").textContent = "ã‚½ãƒ³ã‚°ã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚";
 updateBattleView();
}

/* ========== ã‚¿ãƒ¼ãƒ³çµ‚äº† & CPUã‚¿ãƒ¼ãƒ³ ========== */
function endTurn() {
 if (!battle) return;
 if (battle.turn !== "player") return;

 // ã‚¿ã‚¤ã‚¿ãƒ³ãŒæ”»æ’ƒå¯èƒ½ãªã‚‰ãƒãƒ£ãƒ¬ãƒ³ã‚¸å¿…é ˆ
 const p = battle.player;
 const c = battle.cpu;
 for (let i=0;i<p.field.length;i++) {
   const card = p.field[i];
   if (card.mustAttack && !card.rest && !card.frozen &&
       hasValidChallengeTarget(card, p, c)) {
     alert("ã€Œã‚¿ã‚¤ã‚¿ãƒ³ã€ã¯æ”»æ’ƒå¯èƒ½ãªå ´åˆã€å¿…ãšãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚");
     return;
   }
 }

 battle.turn = "cpu";
 addLog("è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³çµ‚äº†ã€‚CPUã®ã‚¿ãƒ¼ãƒ³ã€‚");
 cpuTurn();
}

function cpuTurn() {
 if (!battle) return;
 const p = battle.player;
 const c = battle.cpu;

 battle.turnCount++;
 battle.turn = "cpu";

 // CPUå ´ã®ãƒ¬ã‚¹ãƒˆè§£é™¤ï¼†å‡çµè§£é™¤
 c.field.forEach(card => {
   card.rest = false;
   if (card.frozen) card.frozen = false;
 });

 // ã‚¤ãƒ³ã‚¯ä½¿ç”¨ãƒªã‚»ãƒƒãƒˆ & ã‚¤ãƒ³ã‚¯å…¨å›å¾©
 c.inkUsedThisTurn = 0;
 c.inkAvail = c.inkTotal;

 // ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ãƒ‰ãƒ­ãƒ¼
 if (c.deck.length) {
   c.hand.push(c.deck.pop());
   addLog("CPUã¯1æšãƒ‰ãƒ­ãƒ¼ã—ãŸã€‚");
 } else {
   addLog("CPUã¯å±±æœ­ãŒãªãã€ãƒ‰ãƒ­ãƒ¼ã§ããªã„ã€‚");
 }

 // ã‚¤ãƒ³ã‚¯ï¼ˆãƒªãƒ³ãŒã„ã‚‹ã¨2å›ã¾ã§ï¼‰
 const maxInk = getMaxInkPerTurn(c);
 while (c.inkUsedThisTurn < maxInk) {
   let placed = false;
   for (let i=0;i<c.hand.length;i++) {
     const card = c.hand[i];
     if (card.inkable) {
       c.hand.splice(i,1);
       c.inkTotal++;
       c.inkAvail++;
       c.inkUsedThisTurn++;
       addLog("CPUã¯ã‚¤ãƒ³ã‚¯ã‚’1æšç½®ã„ãŸã€‚");
       placed = true;
       break;
     }
   }
   if (!placed) break;
 }

 // å¬å–šï¼ˆé«˜ã‚³ã‚¹ãƒˆå„ªå…ˆï¼‰
 let bestIndex = -1;
 let bestCost  = -1;
 c.hand.forEach((card, idx) => {
   if (card.cost <= c.inkAvail && card.cost > bestCost && card.type === "character") {
     bestCost = card.cost;
     bestIndex = idx;
   }
 });
 if (bestIndex >= 0) {
   const card = c.hand[bestIndex];
   c.inkAvail -= card.cost;
   card.summonTurn = battle.turnCount;
   card.rest = false;
   c.hand.splice(bestIndex,1);
   c.field.push(card);
   addLog(`CPUã¯ã€Œ${card.name}ã€ã‚’å¬å–šã—ãŸã€‚`);

   // CPUå´ETB
   if (card.effect === "destroyOnSummon") {
     if (p.field.length > 0) {
       // é©å½“ï¼šATKã®é«˜ã„é †
       let tIndex = 0;
       for (let i=1;i<p.field.length;i++) {
         if (p.field[i].atk > p.field[tIndex].atk) tIndex = i;
       }
       const target = p.field[tIndex];
       p.field.splice(tIndex,1);
       onCardDestroyed(p, target);
       addLog(`CPUã®ã€Œãƒã‚¸ãƒ§ãƒ‰ãƒ©ã€ã®åŠ¹æœã§ã€Œ${target.name}ã€ãŒé€€å ´ã—ãŸã€‚`);
     }
   } else if (card.effect === "toInkOnSummon") {
     if (p.field.length > 0) {
       let tIndex = 0;
       for (let i=1;i<p.field.length;i++) {
         if (p.field[i].atk > p.field[tIndex].atk) tIndex = i;
       }
       sendCharacterToInk(p, tIndex);
     }
   } else if (card.effect === "pretzelHealDraw") {
     doPretzelEffect(c);
   } else if (card.effect === "arienaiSearchSong") {
     doArienaiEffect(c);
   }
 }

 // è¶…CPUæ”»æ’ƒ
 cpuAttack();

 // ãƒ­ã‚¢ç²å¾—ï¼ˆå ´ã®ã‚­ãƒ£ãƒ©ã®ãƒ­ã‚¢ã‚’åŠ ç®—ï¼‰
 updateLinLore();
 c.field.forEach(card => {
   c.lore += card.lore || 0;
 });

 // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³é–‹å§‹ï¼ˆ2ã‚¿ãƒ¼ãƒ³ç›®ä»¥é™ãªã®ã§å¸¸ã«ãƒ‰ãƒ­ãƒ¼ã‚ã‚Šï¼‰
 startPlayerTurn(false);
}

function cpuAttack() {
 const ultra = (cpuStrength === "strong");
 const p = battle.player;
 const c = battle.cpu;

 for (let i=0;i<c.field.length;i++) {
   const attacker = c.field[i];
   if (attacker.rest) continue;

   // å¯¾è±¡ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ¬ã‚¹ãƒˆã—ã¦ã„ã‚‹ã‚­ãƒ£ãƒ©
   let targets = p.field.filter(t => t.rest);

   // å›é¿å‡¦ç†
   if (!attacker.evade) {
     const evadeTargets = targets.filter(t => t.evade);
     if (evadeTargets.length) {
       targets = evadeTargets;
     }
   }

   if (!targets.length) continue;

   let target = targets[0];

   if (ultra) {
     // å€’ã›ãã†ãªç›¸æ‰‹å„ªå…ˆ
     let killable = targets.filter(t => t.hp <= attacker.atk);
     if (killable.length) {
       killable.sort((a,b)=>a.hp-b.hp);
       target = killable[0];
     } else {
       targets.sort((a,b)=>a.hp-b.hp);
       target = targets[0];
     }
   }

   target.hp   -= attacker.atk;
   attacker.hp -= target.atk;
   attacker.rest = true;

   addLog(`CPUã®ã€Œ${attacker.name}ã€ãŒã€Œ${target.name}ã€ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼`);

   if (target.hp <= 0) {
     const idx = p.field.indexOf(target);
     if (idx >= 0) p.field.splice(idx,1);
     onCardDestroyed(p, target);
     addLog(`ã€Œ${target.name}ã€ã¯é€€å ´ã—ãŸã€‚`);
   }
   if (attacker.hp <= 0) {
     c.field.splice(i,1);
     onCardDestroyed(c, attacker);
     addLog(`CPUã®ã€Œ${attacker.name}ã€ã¯é€€å ´ã—ãŸã€‚`);
     i--;
   }
 }
}

/* ========== å‹æ•—åˆ¤å®š ========== */
function checkWin() {
 if (!battle) return;
 const p = battle.player;
 const c = battle.cpu;
 if (p.lore >= 20) {
   alert("å‹åˆ©ï¼ãƒ­ã‚¢20é”æˆï¼");
   battle = null;
   showScreen("menu");
 } else if (c.lore >= 20) {
   alert("æ•—åŒ—â€¦ CPUãŒãƒ­ã‚¢20ã‚’é”æˆ");
   battle = null;
   showScreen("menu");
 }
}

/* ========== ãƒ­ã‚° ========== */
function clearLog() {
 const el = document.getElementById("log");
 if (el) el.innerHTML = "";
}
function addLog(text) {
 const el = document.getElementById("log");
 if (!el) return;
 const div = document.createElement("div");
 div.textContent = text;
 el.appendChild(div);
 el.scrollTop = el.scrollHeight;
}

/* ========== ãƒãƒˆãƒ«ä¸­æ–­ ========== */
function endBattleToMenu() {
 if (confirm("ãƒãƒˆãƒ«ã‚’çµ‚äº†ã—ã¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ")) {
   battle = null;
   showScreen("menu");
 }
}

/* ========== åˆæœŸåŒ– ========== */
window.addEventListener("load", () => {
 loadData();
 showScreen("menu");
});
</script>

</body>
</html>
