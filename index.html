<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Dream-seeker TCG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #181818;
      color: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    h1 {
      text-align: center;
      padding: 12px;
      font-size: 20px;
      background: #242424;
      margin: 0;
    }
    #app {
      max-width: 520px;
      margin: 0 auto;
      padding: 8px;
    }
    .screen { display: none; }
    .screen.active { display: block; }

    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    .menu-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 20px;
    }
    .menu-buttons button {
      padding: 12px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: #424242;
      color: #f5f5f5;
      width: 100%;
    }

    /* ãƒãƒˆãƒ«ç”»é¢ */
    .player-area {
      border: 1px solid #444;
      border-radius: 10px;
      padding: 8px;
      background: #202020;
      margin-bottom: 8px;
    }
    .player-header {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      flex-wrap: wrap;
    }
    .zone-title { font-size: 11px; margin-top: 6px; opacity: 0.8; }
    .zone { display: flex; flex-wrap: wrap; gap: 4px; }
    .card {
      border-radius: 6px;
      padding: 4px;
      font-size: 11px;
      width: 46%;
      border: 1px solid #555;
      background: #121212;
    }
    .card-red { border-color: #f44336; }
    .card-purple { border-color: #9c27b0; }
    .card-name { font-weight: bold; font-size: 12px; }
    .card-stats { font-size: 10px; }
    .btn {
      margin-top: 3px;
      width: 100%;
      padding: 4px;
      font-size: 11px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: #333;
      color: #f5f5f5;
    }
    .btn-small {
      padding: 2px 4px;
      font-size: 10px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: #555;
      color: #f5f5f5;
      margin-left: 4px;
    }
    #battleControls {
      border-top: 1px solid #444;
      border-bottom: 1px solid #444;
      padding: 6px;
      display: flex;
      gap: 6px;
      justify-content: center;
      font-size: 12px;
      margin-top: 6px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }
    #battleControls button {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #424242;
      color: #f5f5f5;
    }
    #log {
      padding: 6px;
      font-size: 11px;
      max-height: 220px;
      overflow-y: auto;
      background: #151515;
      border-radius: 8px;
      border: 1px solid #333;
    }
    .section-title {
      font-size: 14px;
      margin-top: 16px;
      margin-bottom: 8px;
      font-weight: bold;
    }
    p { font-size: 13px; }
  </style>
</head>
<body>
<h1>Dream-seeker TCG</h1>
<div id="app">
  <!-- ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
  <div id="menuScreen" class="screen active">
    <div class="section-title">ãƒ¢ãƒ¼ãƒ‰é¸æŠ</div>
    <div class="menu-buttons">
      <button onclick="startBattle()">ãƒãƒˆãƒ«ã‚’å§‹ã‚ã‚‹</button>
      <button onclick="showScreen('pack')">ãƒ‘ãƒƒã‚¯ã‚’é–‹ãï¼ˆæº–å‚™ä¸­ï¼‰</button>
      <button onclick="showScreen('deck')">ãƒ‡ãƒƒã‚­ç·¨é›†ï¼ˆæº–å‚™ä¸­ï¼‰</button>
    </div>
  </div>

  <!-- ãƒãƒˆãƒ«ç”»é¢ -->
  <div id="battleScreen" class="screen">
    <div id="player1" class="player-area"></div>
    <div id="player0" class="player-area"></div>

    <div id="battleControls">
      <!-- â€» ãƒ‰ãƒ­ãƒ¼ã¯ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã«è‡ªå‹•ã§1æšå¼•ãã®ã§ãƒœã‚¿ãƒ³ã¯ãªã— -->
      <span id="turnInfo"></span>
      <span id="attackerInfo"></span>
      <span id="freezeInfo"></span>
      <button id="freezeDoneBtn" onclick="finishFreezeSelection()" class="btn-small" style="display:none;">
        é¸æŠçµ‚äº†
      </button>
      <button onclick="endTurn()" class="btn-small">ã‚¿ãƒ¼ãƒ³çµ‚äº†</button>
      <button onclick="backToMenu()" class="btn-small">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
    </div>

    <div id="log"></div>
  </div>

  <!-- ãƒ‘ãƒƒã‚¯ç”»é¢ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰ -->
  <div id="packScreen" class="screen">
    <div class="section-title">ãƒ‘ãƒƒã‚¯ï¼ˆæº–å‚™ä¸­ï¼‰</div>
    <p>ã“ã“ã§ã¯å°†æ¥ã€ã€Œãƒ‘ãƒƒã‚¯ã‚’é–‹ã„ã¦ã‚«ãƒ¼ãƒ‰ã‚’å…¥æ‰‹ã™ã‚‹ã€ç”»é¢ã«ã™ã‚‹äºˆå®šï¼</p>
    <button class="btn" onclick="showScreen('menu')">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
  </div>

  <!-- ãƒ‡ãƒƒã‚­ç·¨é›†ç”»é¢ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰ -->
  <div id="deckScreen" class="screen">
    <div class="section-title">ãƒ‡ãƒƒã‚­ç·¨é›†ï¼ˆæº–å‚™ä¸­ï¼‰</div>
    <p>ã“ã“ã§ã¯å°†æ¥ã€ã€Œå¥½ããªã‚«ãƒ¼ãƒ‰ã‚’å…¥ã‚Œæ›¿ãˆã¦ãƒ‡ãƒƒã‚­ã‚’ä½œã‚‹ã€ç”»é¢ã«ã™ã‚‹äºˆå®šï¼</p>
    <button class="btn" onclick="showScreen('menu')">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
  </div>
</div>

<script>
/* ==== ç”»é¢åˆ‡ã‚Šæ›¿ãˆ ==== */
function showScreen(name) {
  const ids = ["menuScreen","battleScreen","packScreen","deckScreen"];
  ids.forEach(id => document.getElementById(id).classList.remove("active"));
  if (name === "menu")   document.getElementById("menuScreen").classList.add("active");
  if (name === "battle") document.getElementById("battleScreen").classList.add("active");
  if (name === "pack")   document.getElementById("packScreen").classList.add("active");
  if (name === "deck")   document.getElementById("deckScreen").classList.add("active");
}

function startBattle() {
  initBattle();
  showScreen("battle");
}

function backToMenu() {
  showScreen("menu");
}

/* ==== ã‚«ãƒ¼ãƒ‰å®šç¾© ==== */
const cards = {
  // èµ¤ã®ä»£è¡¨ã‚«ãƒ¼ãƒ‰
  101:{id:101,name:"ç´…è“®ã®çªæ’ƒè€…",color:"red",type:"character",
       cost:3,strength:4,willpower:1,lore:1,inkable:true},
  102:{id:102,name:"çƒˆç«ã®å‡¦åˆ‘äºº",color:"red",type:"character",
       cost:5,strength:5,willpower:4,lore:2,inkable:true},
  111:{id:111,name:"çµ‚ç„‰ã®å¤§ç«",color:"red",type:"song",
       cost:7,inkable:false,ability:"destroyAll"},

  // ç´«ã®ä»£è¡¨ã‚«ãƒ¼ãƒ‰
  201:{id:201,name:"å¹»æƒ³ã®æ›¸è¨˜",color:"purple",type:"character",
       cost:2,strength:1,willpower:3,lore:1,inkable:true},
  // â„ æ°·ã®å¥³ç‹ï¼šã‚³ã‚¹ãƒˆãƒ¬ã‚¹ï¼ˆã‚¤ãƒ³ã‚¯ä¸å¯ï¼‰
  211:{id:211,name:"æ°·ã®å¥³ç‹ ã‚¢ã‚¤ã‚¹ãƒ•ã‚£ãƒ¼ãƒ",color:"purple",type:"character",
       cost:8,strength:4,willpower:6,lore:3,inkable:false,ability:"stun2"}
};

// æ±ç”¨ã‚¤ãƒ³ã‚¯ã‚­ãƒ£ãƒ©ã‚’è‡ªå‹•ç”Ÿæˆï¼ˆå„è‰² 20æšè¿½åŠ ã—ã¦30æšãƒ‡ãƒƒã‚­ã«ï¼‰
let genId = 300;
const redDeckBase = [101,102,111];
const purpleDeckBase = [201,211];

for (let i = 0; i < 20; i++) {
  cards[genId] = {
    id: genId,
    name: "èµ¤ã®å…µå£«" + (i+1),
    color: "red",
    type: "character",
    cost: 2,
    strength: 2,
    willpower: 2,
    lore: 1,
    inkable: true
  };
  redDeckBase.push(genId);
  genId++;

  cards[genId] = {
    id: genId,
    name: "ç´«ã®å­¦å¾’" + (i+1),
    color: "purple",
    type: "character",
    cost: 2,
    strength: 1,
    willpower: 3,
    lore: 1,
    inkable: true
  };
  purpleDeckBase.push(genId);
  genId++;
}

function shuffle(a){ return a.sort(() => Math.random() - 0.5); }

/* ==== ãƒãƒˆãƒ«ç”¨ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ==== */
let battleState = null;

function createPlayer(name, deckList) {
  return {
    name,
    deck: shuffle(deckList.slice()),
    hand: [],
    board: [],  // {id, rest, damage, stun}
    grave: [],
    ink: [],
    lore: 0
  };
}

function initBattle() {
  battleState = {
    current: 0,  // 0: èµ¤, 1: ç´«
    players: [
      createPlayer("èµ¤ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼", redDeckBase),
      createPlayer("ç´«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼", purpleDeckBase)
    ],
    selectedAttacker: null,
    winner: null,
    log: [],
    freezeSelection: null,   // æ°·ã®å¥³ç‹ã®å‡çµé¸æŠ
    inkUsedThisTurn: false   // ã“ã®ã‚¿ãƒ¼ãƒ³ã‚‚ã†ã‚¤ãƒ³ã‚¯ã‚’ç½®ã„ãŸã‹
  };

  // åˆæœŸãƒ‰ãƒ­ãƒ¼5æšãšã¤ï¼ˆã“ã‚Œã¯å…ˆè¡Œæº–å‚™ï¼‰
  for (let i = 0; i < 5; i++) {
    drawCard(0);
    drawCard(1);
  }
  logMessage("ãƒãƒˆãƒ«é–‹å§‹ï¼ä¸¡è€…5æšãƒ‰ãƒ­ãƒ¼ã€‚");

  // å…ˆæ”»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³é–‹å§‹å‡¦ç†ï¼ˆã“ã“ã§1ãƒ‰ãƒ­ãƒ¼ï¼‰
  startTurnForCurrent();
  renderBattle();
}

function logMessage(msg) {
  if (!battleState) return;
  battleState.log.push(msg);
  if (battleState.log.length > 80) battleState.log.shift();
  const logDiv = document.getElementById("log");
  logDiv.innerHTML = battleState.log.map(l => "ãƒ»" + l).join("<br>");
  logDiv.scrollTop = logDiv.scrollHeight;
}

function drawCard(playerIndex) {
  const p = battleState.players[playerIndex];
  const cardId = p.deck.pop();
  if (!cardId) {
    return false;
  }
  p.hand.push(cardId);
  return true;
}

/* ã‚¿ãƒ¼ãƒ³é–‹å§‹å‡¦ç†ï¼šæœ€åˆã«1ãƒ‰ãƒ­ãƒ¼ï¼‹ã‚¹ã‚¿ãƒ³/ãƒ¬ã‚¹ãƒˆå‡¦ç† */
function startTurnForCurrent() {
  const p = battleState.players[battleState.current];

  // ã‚¤ãƒ³ã‚¯ã¯æ¯ã‚¿ãƒ¼ãƒ³ãƒªã‚»ãƒƒãƒˆï¼ˆ1ã‚¿ãƒ¼ãƒ³1å›ã¾ã§ï¼‰
  battleState.inkUsedThisTurn = false;

  // ã‚¹ã‚¿ãƒ³ä¸­ã®ã‚­ãƒ£ãƒ©ã¯1ã‚¿ãƒ¼ãƒ³ä¼‘ã¿ã€ãã‚Œä»¥å¤–ã¯ãƒ¬ãƒ‡ã‚£
  p.board.forEach(u => {
    if (u.stun > 0) {
      u.stun--;
      u.rest = true;
    } else {
      u.rest = false;
    }
  });

  // ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã«å¿…ãš1ãƒ‰ãƒ­ãƒ¼ï¼ˆå±±æœ­ãŒã‚ã‚Œã°ï¼‰
  const ok = drawCard(battleState.current);
  if (ok) {
    logMessage(`${p.name}ã®ã‚¿ãƒ¼ãƒ³é–‹å§‹ï¼š1æšãƒ‰ãƒ­ãƒ¼`);
  } else {
    logMessage(`${p.name}ã®ã‚¿ãƒ¼ãƒ³é–‹å§‹ï¼šå±±æœ­ãŒãªããƒ‰ãƒ­ãƒ¼ã§ããªã„`);
  }
}

/* ã‚¤ãƒ³ã‚¯ã«åŸ‹ã‚ã‚‹ï¼ˆ1ã‚¿ãƒ¼ãƒ³ã«1å›ã¾ã§ï¼‰ */
function playInk(pi, hi) {
  if (battleState.winner !== null) return;
  if (pi !== battleState.current) return;

  if (battleState.inkUsedThisTurn) {
    alert("ã“ã®ã‚¿ãƒ¼ãƒ³ã¯ã™ã§ã«ã‚³ã‚¹ãƒˆã‚’ç½®ã„ã¦ã„ã¾ã™");
    return;
  }

  const p = battleState.players[pi];
  const cardId = p.hand[hi];
  const c = cards[cardId];

  // ã‚³ã‚¹ãƒˆãƒ¬ã‚¹ï¼ˆinkable:falseï¼‰ã®ã‚«ãƒ¼ãƒ‰ã¯ã‚¤ãƒ³ã‚¯ã«ã§ããªã„
  if (c.inkable === false) {
    alert("ã“ã®ã‚«ãƒ¼ãƒ‰ã¯ã‚¤ãƒ³ã‚¯ã«ã§ãã¾ã›ã‚“ï¼ˆã‚³ã‚¹ãƒˆãƒ¬ã‚¹ï¼‰");
    return;
  }

  p.hand.splice(hi,1);
  p.ink.push(cardId);
  battleState.inkUsedThisTurn = true;
  logMessage(`${p.name}ã¯ã€Œ${c.name}ã€ã‚’ã‚¤ãƒ³ã‚¯ã«ã—ãŸï¼ˆã‚¤ãƒ³ã‚¯:${p.ink.length}ï¼‰`);
  renderBattle();
}

/* ã‚­ãƒ£ãƒ©å¬å–š */
function playCharacter(pi, hi) {
  if (battleState.winner !== null) return;
  if (pi !== battleState.current) return;
  const p = battleState.players[pi];
  const cardId = p.hand[hi];
  const c = cards[cardId];
  if (c.type !== "character") {
    alert("ã‚­ãƒ£ãƒ©ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
    return;
  }
  if (p.ink.length < c.cost) {
    alert("ã‚¤ãƒ³ã‚¯ãŒè¶³ã‚Šã¾ã›ã‚“");
    return;
  }
  p.hand.splice(hi,1);
  const unit = { id: cardId, rest: false, damage: 0, stun: 0 };
  p.board.push(unit);
  logMessage(`${p.name}ã¯ã‚­ãƒ£ãƒ©ã€Œ${c.name}ã€ã‚’å¬å–šï¼ˆã‚³ã‚¹ãƒˆ${c.cost}ï¼‰`);

  // æ°·ã®å¥³ç‹ï¼šç›¸æ‰‹ã‚­ãƒ£ãƒ©2ä½“ã¾ã§é¸ã‚“ã§å‡çµ
  if (c.ability === "stun2") {
    const enemyIndex = 1 - pi;
    const enemy = battleState.players[enemyIndex];

    if (enemy.board.length === 0) {
      logMessage("â„ æ°·ã®å¥³ç‹ï¼šå‡çµã§ãã‚‹ç›¸æ‰‹ã‚­ãƒ£ãƒ©ãŒã„ã¾ã›ã‚“");
    } else {
      battleState.freezeSelection = {
        enemyIndex,
        targets: [] // {index: ç•ªå·}
      };
      logMessage("â„ æ°·ã®å¥³ç‹ï¼šå‡çµã•ã›ã‚‹ã‚­ãƒ£ãƒ©ã‚’æœ€å¤§2ä½“ã¾ã§é¸ã‚“ã§ãã ã•ã„");
    }
  }

  renderBattle();
}

/* ã‚½ãƒ³ã‚°ï¼ˆçµ‚ç„‰ã®å¤§ç«ãªã©ï¼‰ */
function playSong(pi, hi) {
  if (battleState.winner !== null) return;
  if (pi !== battleState.current) return;
  const p = battleState.players[pi];
  const cardId = p.hand[hi];
  const c = cards[cardId];
  if (c.type !== "song") {
    alert("ã‚½ãƒ³ã‚°ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
    return;
  }
  if (p.ink.length < c.cost) {
    alert("ã‚¤ãƒ³ã‚¯ãŒè¶³ã‚Šã¾ã›ã‚“ï¼ˆã‚½ãƒ³ã‚°è¸ã¿å€’ã—ã¯ã¾ã æœªå®Ÿè£…ï¼‰");
    return;
  }

  if (c.ability === "destroyAll") {
    battleState.players.forEach(pl => {
      pl.board.forEach(b => pl.grave.push(b.id));
      pl.board = [];
    });
    logMessage("ğŸ”¥ çµ‚ç„‰ã®å¤§ç«ï¼å ´ã®ã‚­ãƒ£ãƒ©ã¯ã™ã¹ã¦æ¶ˆãˆå»ã£ãŸï¼");
  } else {
    logMessage(`${p.name}ã¯ã‚½ãƒ³ã‚°ã€Œ${c.name}ã€ã‚’ä½¿ç”¨ï¼ˆåŠ¹æœæœªå®Ÿè£…ï¼‰`);
  }

  p.hand.splice(hi,1);
  p.grave.push(cardId);
  renderBattle();
}

/* ã‚·ãƒ¼ã‚¯ï¼ˆãƒ­ã‚¢ç²å¾—ï¼‰ */
function seekCharacter(pi, bi) {
  if (battleState.winner !== null) return;
  if (pi !== battleState.current) return;
  const p = battleState.players[pi];
  const unit = p.board[bi];
  if (!unit) return;
  if (unit.rest) {
    alert("ãƒ¬ã‚¹ãƒˆçŠ¶æ…‹ã®ã‚­ãƒ£ãƒ©ã¯ã‚·ãƒ¼ã‚¯ã§ãã¾ã›ã‚“");
    return;
  }
  const c = cards[unit.id];
  unit.rest = true;
  p.lore += c.lore;
  logMessage(`${p.name}ã®ã€Œ${c.name}ã€ãŒã‚·ãƒ¼ã‚¯ã—ã€ãƒ­ã‚¢${c.lore}ç²å¾—ï¼ï¼ˆåˆè¨ˆãƒ­ã‚¢:${p.lore}ï¼‰`);
  checkWinner();
  renderBattle();
}

/* ã‚¢ã‚¿ãƒƒã‚«ãƒ¼æŒ‡å®š */
function setAttacker(pi, bi) {
  if (battleState.winner !== null) return;
  if (pi !== battleState.current) return;
  const p = battleState.players[pi];
  const unit = p.board[bi];
  if (!unit) return;
  if (unit.rest) {
    alert("ãƒ¬ã‚¹ãƒˆçŠ¶æ…‹ã®ã‚­ãƒ£ãƒ©ã¯ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã§ãã¾ã›ã‚“");
    return;
  }
  battleState.selectedAttacker = { player: pi, index: bi };
  const c = cards[unit.id];
  logMessage(`${p.name}ã¯ã€Œ${c.name}ã€ã‚’ã‚¢ã‚¿ãƒƒã‚«ãƒ¼ã«é¸ã‚“ã `);
  renderBattle();
}

/* ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ˆæ”»æ’ƒï¼‰ */
function challengeCharacter(targetPi, targetBi) {
  if (battleState.winner !== null) return;
  const sel = battleState.selectedAttacker;
  if (!sel) {
    alert("å…ˆã«è‡ªåˆ†ã®ã‚­ãƒ£ãƒ©ã‚’ã‚¢ã‚¿ãƒƒã‚«ãƒ¼ã«é¸ã‚“ã§ãã ã•ã„");
    return;
  }
  if (sel.player !== battleState.current) return;

  const atkP = battleState.players[sel.player];
  const defP = battleState.players[targetPi];

  const atk = atkP.board[sel.index];
  const def = defP.board[targetBi];
  if (!atk || !def) return;

  if (atk.rest) {
    alert("ãƒ¬ã‚¹ãƒˆçŠ¶æ…‹ã®ã‚­ãƒ£ãƒ©ã¯ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã§ãã¾ã›ã‚“");
    battleState.selectedAttacker = null;
    renderBattle();
    return;
  }

  const atkC = cards[atk.id];
  const defC = cards[def.id];

  atk.damage += defC.strength;
  def.damage += atkC.strength;
  atk.rest = true;

  logMessage(`${atkP.name}ã®ã€Œ${atkC.name}ã€ãŒ ${defP.name}ã®ã€Œ${defC.name}ã€ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼`);

  if (def.damage >= defC.willpower) {
    defP.grave.push(def.id);
    defP.board.splice(targetBi,1);
    logMessage(`${defP.name}ã®ã€Œ${defC.name}ã€ã¯ãƒãƒ‹ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸ`);
  }
  if (atk.damage >= atkC.willpower) {
    atkP.grave.push(atk.id);
    atkP.board.splice(sel.index,1);
    logMessage(`${atkP.name}ã®ã€Œ${atkC.name}ã€ã‚‚ãƒãƒ‹ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸ`);
  }

  battleState.selectedAttacker = null;
  renderBattle();
}

/* æ°·ã®å¥³ç‹ï¼šå‡çµå¯¾è±¡ã‚’é¸ã¶ */
function selectFreezeTarget(pi, bi) {
  if (!battleState || !battleState.freezeSelection) return;
  const fs = battleState.freezeSelection;

  if (pi !== fs.enemyIndex) return;

  const enemy = battleState.players[pi];
  const unit = enemy.board[bi];
  if (!unit) return;

  // ã™ã§ã«é¸ã‚“ã§ã„ã‚‹ã‹
  if (fs.targets.some(t => t.index === bi)) return;

  if (fs.targets.length >= 2) {
    alert("ã“ã‚Œä»¥ä¸Šé¸æŠã§ãã¾ã›ã‚“ï¼ˆæœ€å¤§2ä½“ã¾ã§ï¼‰");
    return;
  }

  unit.stun = 1;
  unit.rest = true;
  fs.targets.push({ index: bi });

  const c = cards[unit.id];
  logMessage(`â„ ã€Œ${c.name}ã€ã‚’å‡çµå¯¾è±¡ã«é¸ã³ã¾ã—ãŸ`);

  if (fs.targets.length >= 2) {
    finishFreezeSelection();
  } else {
    renderBattle();
  }
}

/* æ°·ã®å¥³ç‹ï¼šå‡çµé¸æŠã‚’çµ‚äº† */
function finishFreezeSelection() {
  if (!battleState || !battleState.freezeSelection) return;
  const fs = battleState.freezeSelection;
  if (fs.targets.length === 0) {
    logMessage("æ°·ã®å¥³ç‹ï¼šå‡çµå¯¾è±¡ã‚’é¸ã°ãšã«é¸æŠã‚’çµ‚äº†ã—ã¾ã—ãŸ");
  } else {
    logMessage("æ°·ã®å¥³ç‹ï¼šå‡çµã®é¸æŠã‚’çµ‚äº†ã—ã¾ã—ãŸ");
  }
  battleState.freezeSelection = null;
  renderBattle();
}

/* å‹åˆ©åˆ¤å®šï¼ˆãƒ­ã‚¢15ã§å‹ã¡ï¼‰ */
function checkWinner() {
  if (battleState.winner !== null) return;
  for (let i = 0; i < 2; i++) {
    if (battleState.players[i].lore >= 15) {
      battleState.winner = i;
      const name = battleState.players[i].name;
      logMessage(`â˜… ${name}ãŒãƒ­ã‚¢15ã«åˆ°é”ï¼å‹åˆ©ï¼`);
      alert(name + "ã®å‹ã¡ï¼");
    }
  }
}

/* ã‚¿ãƒ¼ãƒ³çµ‚äº† â†’ ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³é–‹å§‹ï¼ˆè‡ªå‹•1ãƒ‰ãƒ­ãƒ¼ï¼‰ */
function endTurn() {
  if (battleState.winner !== null) return;
  const p = battleState.players[battleState.current];
  logMessage(`${p.name}ã®ã‚¿ãƒ¼ãƒ³ã‚’çµ‚äº†`);

  battleState.current = 1 - battleState.current;
  battleState.selectedAttacker = null;
  battleState.freezeSelection = null;

  startTurnForCurrent();
  renderBattle();
}

/* æç”»å‡¦ç† */
function renderBattle() {
  if (!battleState) return;
  renderPlayer(0);
  renderPlayer(1);

  const turnInfo = document.getElementById("turnInfo");
  const atkInfo = document.getElementById("attackerInfo");
  const freezeInfo = document.getElementById("freezeInfo");
  const freezeBtn = document.getElementById("freezeDoneBtn");

  const p = battleState.players[battleState.current];
  turnInfo.textContent = "ç¾åœ¨: " + p.name;

  if (battleState.selectedAttacker) {
    const sel = battleState.selectedAttacker;
    const u = battleState.players[sel.player].board[sel.index];
    const c = u ? cards[u.id] : null;
    atkInfo.textContent = c ? "ã‚¢ã‚¿ãƒƒã‚«ãƒ¼: " + c.name : "";
  } else {
    atkInfo.textContent = "";
  }

  if (battleState.freezeSelection) {
    freezeInfo.textContent =
      "æ°·ã®å¥³ç‹ï¼šå‡çµã•ã›ã‚‹ã‚­ãƒ£ãƒ©ã‚’é¸æŠä¸­ï¼ˆ" +
      battleState.freezeSelection.targets.length + "/2ï¼‰";
    freezeBtn.style.display = "inline-block";
  } else {
    freezeInfo.textContent = "";
    freezeBtn.style.display = "none";
  }
}

function renderPlayer(pi) {
  const p = battleState.players[pi];
  const container = document.getElementById("player" + pi);
  const isCurrent = (pi === battleState.current);

  let html = "";
  html += '<div class="player-header">'
       + '<span>' + (pi===0?"èµ¤ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆèµ¤ãƒ‡ãƒƒã‚­ï¼‰":"ç´«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆç´«ãƒ‡ãƒƒã‚­ï¼‰") + '</span>'
       + '<span>ãƒ­ã‚¢:' + p.lore + 'ï½œã‚¤ãƒ³ã‚¯:' + p.ink.length
       + 'ï½œå±±æœ­:' + p.deck.length + 'ï½œæ‰‹æœ­:' + p.hand.length + '</span>'
       + '<span>' + (isCurrent?"â˜… ã“ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³":"") + '</span>'
       + '</div>';

  // å ´
  html += '<div class="zone-title">å ´</div><div class="zone">';
  p.board.forEach((u,bi)=>{
    const c = cards[u.id];
    const colorClass = c.color === "red" ? "card-red" : "card-purple";
    const state = u.rest ? "ãƒ¬ã‚¹ãƒˆ" : "ãƒ¬ãƒ‡ã‚£";
    const dmg = u.damage>0 ? " / ãƒ€ãƒ¡ãƒ¼ã‚¸:" + u.damage : "";
    const stun = u.stun>0 ? " / â„å‡çµä¸­" : "";
    html += '<div class="card ' + colorClass + '">'
         + '<div class="card-name">' + c.name + '</div>'
         + '<div class="card-stats">' + c.strength + '/' + c.willpower
         + ' / ãƒ­ã‚¢:' + c.lore + '</div>'
         + '<div class="card-stats">çŠ¶æ…‹:' + state + dmg + stun + '</div>';

    if (battleState.winner === null && isCurrent && !u.rest) {
      html += '<button class="btn" onclick="seekCharacter(' + pi + ',' + bi + ')">ã‚·ãƒ¼ã‚¯ï¼ˆãƒ­ã‚¢ç²å¾—ï¼‰</button>';
      html += '<button class="btn" onclick="setAttacker(' + pi + ',' + bi + ')">ã‚¢ã‚¿ãƒƒã‚«ãƒ¼ã«ã™ã‚‹ï¼ˆãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼‰</button>';
    }

    const sel = battleState.selectedAttacker;
    if (battleState.winner === null && sel && sel.player === battleState.current && pi !== battleState.current) {
      html += '<button class="btn" onclick="challengeCharacter(' + pi + ',' + bi + ')">ã“ã®ã‚­ãƒ£ãƒ©ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸</button>';
    }

    // æ°·ã®å¥³ç‹ã®å‡çµå¯¾è±¡é¸æŠãƒœã‚¿ãƒ³
    if (battleState.winner === null &&
        battleState.freezeSelection &&
        pi === battleState.freezeSelection.enemyIndex) {

      const already = battleState.freezeSelection.targets.some(t => t.index === bi);

      if (!already && battleState.freezeSelection.targets.length < 2) {
        html += '<button class="btn" onclick="selectFreezeTarget(' + pi + ',' + bi + ')">å‡çµã•ã›ã‚‹</button>';
      } else if (already) {
        html += '<div class="card-stats">å‡çµå¯¾è±¡ã«é¸æŠä¸­</div>';
      }
    }

    html += '</div>';
  });
  html += '</div>';

  // æ‰‹æœ­
  html += '<div class="zone-title">æ‰‹æœ­</div><div class="zone">';
  p.hand.forEach((cid,hi)=>{
    const c = cards[cid];
    const colorClass = c.color === "red" ? "card-red" : "card-purple";
    html += '<div class="card ' + colorClass + '">'
         + '<div class="card-name">' + c.name + '</div>'
         + '<div class="card-stats">[' + c.type + '] ã‚³ã‚¹ãƒˆ:' + (c.cost ?? "-")
         + (c.inkable===false?"ï¼ˆã‚³ã‚¹ãƒˆãƒ¬ã‚¹ï¼‰":"") + '</div>';

    if (battleState.winner === null && isCurrent) {
      html += '<button class="btn" onclick="playInk(' + pi + ',' + hi + ')">ã‚¤ãƒ³ã‚¯ã«ã™ã‚‹ï¼ˆ1ã‚¿ãƒ¼ãƒ³1å›ï¼‰</button>';
      if (c.type === "character") {
        html += '<button class="btn" onclick="playCharacter(' + pi + ',' + hi + ')">å¬å–š</button>';
      }
      if (c.type === "song") {
        html += '<button class="btn" onclick="playSong(' + pi + ',' + hi + ')">ã‚½ãƒ³ã‚°ã‚’ä½¿ã†</button>';
      }
    }
    html += '</div>';
  });
  html += '</div>';

  container.innerHTML = html;
}

/* åˆæœŸè¡¨ç¤ºã¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã ã‘ */
window.onload = function() {
  showScreen("menu");
};
</script>
</body>
</html>
